"use strict";var ar=Object.defineProperty;var cr=(c,r,i)=>r in c?ar(c,r,{enumerable:!0,configurable:!0,writable:!0,value:i}):c[r]=i;var y=(c,r,i)=>(cr(c,typeof r!="symbol"?r+"":r,i),i);const at=require("electron"),pt=require("crypto"),ur=require("path"),lr=require("fs"),_t=require("node:child_process"),hr=require("sqlite3"),ee=require("url");function xe(c){const r=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(c){for(const i in c)if(i!=="default"){const o=Object.getOwnPropertyDescriptor(c,i);Object.defineProperty(r,i,o.get?o:{enumerable:!0,get:()=>c[i]})}}return r.default=c,Object.freeze(r)}const A=xe(ur),q=xe(lr),ke=require("cheerio");async function pr(c){await c.goto("https://ipinfo.io/json",{waitLoad:!0,waitNetworkIdle:!0});const r=await c.content({timeout:2e4}),o=ke.load(r)("pre").text();return JSON.parse(o)}async function fr(c){await c.goto("https://httpbin.org/get",{waitLoad:!0,waitNetworkIdle:!0});const r=await c.content(),o=ke.load(r)("pre").text();return JSON.parse(o)}var be={},wt={};wt.byteLength=wr;wt.toByteArray=mr;wt.fromByteArray=br;var P=[],U=[],dr=typeof Uint8Array<"u"?Uint8Array:Array,Bt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var et=0,gr=Bt.length;et<gr;++et)P[et]=Bt[et],U[Bt.charCodeAt(et)]=et;U["-".charCodeAt(0)]=62;U["_".charCodeAt(0)]=63;function Ee(c){var r=c.length;if(r%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var i=c.indexOf("=");i===-1&&(i=r);var o=i===r?0:4-i%4;return[i,o]}function wr(c){var r=Ee(c),i=r[0],o=r[1];return(i+o)*3/4-o}function yr(c,r,i){return(r+i)*3/4-i}function mr(c){var r,i=Ee(c),o=i[0],a=i[1],u=new dr(yr(c,o,a)),p=0,g=a>0?o-4:o,w;for(w=0;w<g;w+=4)r=U[c.charCodeAt(w)]<<18|U[c.charCodeAt(w+1)]<<12|U[c.charCodeAt(w+2)]<<6|U[c.charCodeAt(w+3)],u[p++]=r>>16&255,u[p++]=r>>8&255,u[p++]=r&255;return a===2&&(r=U[c.charCodeAt(w)]<<2|U[c.charCodeAt(w+1)]>>4,u[p++]=r&255),a===1&&(r=U[c.charCodeAt(w)]<<10|U[c.charCodeAt(w+1)]<<4|U[c.charCodeAt(w+2)]>>2,u[p++]=r>>8&255,u[p++]=r&255),u}function xr(c){return P[c>>18&63]+P[c>>12&63]+P[c>>6&63]+P[c&63]}function kr(c,r,i){for(var o,a=[],u=r;u<i;u+=3)o=(c[u]<<16&16711680)+(c[u+1]<<8&65280)+(c[u+2]&255),a.push(xr(o));return a.join("")}function br(c){for(var r,i=c.length,o=i%3,a=[],u=16383,p=0,g=i-o;p<g;p+=u)a.push(kr(c,p,p+u>g?g:p+u));return o===1?(r=c[i-1],a.push(P[r>>2]+P[r<<4&63]+"==")):o===2&&(r=(c[i-2]<<8)+c[i-1],a.push(P[r>>10]+P[r>>4&63]+P[r<<2&63]+"=")),a.join("")}var qt={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */qt.read=function(c,r,i,o,a){var u,p,g=a*8-o-1,w=(1<<g)-1,m=w>>1,h=-7,E=i?a-1:0,R=i?-1:1,v=c[r+E];for(E+=R,u=v&(1<<-h)-1,v>>=-h,h+=g;h>0;u=u*256+c[r+E],E+=R,h-=8);for(p=u&(1<<-h)-1,u>>=-h,h+=o;h>0;p=p*256+c[r+E],E+=R,h-=8);if(u===0)u=1-m;else{if(u===w)return p?NaN:(v?-1:1)*(1/0);p=p+Math.pow(2,o),u=u-m}return(v?-1:1)*p*Math.pow(2,u-o)};qt.write=function(c,r,i,o,a,u){var p,g,w,m=u*8-a-1,h=(1<<m)-1,E=h>>1,R=a===23?Math.pow(2,-24)-Math.pow(2,-77):0,v=o?0:u-1,V=o?1:-1,G=r<0||r===0&&1/r<0?1:0;for(r=Math.abs(r),isNaN(r)||r===1/0?(g=isNaN(r)?1:0,p=h):(p=Math.floor(Math.log(r)/Math.LN2),r*(w=Math.pow(2,-p))<1&&(p--,w*=2),p+E>=1?r+=R/w:r+=R*Math.pow(2,1-E),r*w>=2&&(p++,w/=2),p+E>=h?(g=0,p=h):p+E>=1?(g=(r*w-1)*Math.pow(2,a),p=p+E):(g=r*Math.pow(2,E-1)*Math.pow(2,a),p=0));a>=8;c[i+v]=g&255,v+=V,g/=256,a-=8);for(p=p<<a|g,m+=a;m>0;c[i+v]=p&255,v+=V,p/=256,m-=8);c[i+v-V]|=G*128};/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(c){const r=wt,i=qt,o=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;c.Buffer=h,c.SlowBuffer=Le,c.INSPECT_MAX_BYTES=50;const a=2147483647;c.kMaxLength=a;const{Uint8Array:u,ArrayBuffer:p,SharedArrayBuffer:g}=globalThis;h.TYPED_ARRAY_SUPPORT=w(),!h.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function w(){try{const n=new u(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,u.prototype),Object.setPrototypeOf(n,t),n.foo()===42}catch{return!1}}Object.defineProperty(h.prototype,"parent",{enumerable:!0,get:function(){if(h.isBuffer(this))return this.buffer}}),Object.defineProperty(h.prototype,"offset",{enumerable:!0,get:function(){if(h.isBuffer(this))return this.byteOffset}});function m(n){if(n>a)throw new RangeError('The value "'+n+'" is invalid for option "size"');const t=new u(n);return Object.setPrototypeOf(t,h.prototype),t}function h(n,t,e){if(typeof n=="number"){if(typeof t=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return V(n)}return E(n,t,e)}h.poolSize=8192;function E(n,t,e){if(typeof n=="string")return G(n,t);if(p.isView(n))return Lt(n);if(n==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof n);if(M(n,p)||n&&M(n.buffer,p)||typeof g<"u"&&(M(n,g)||n&&M(n.buffer,g)))return lt(n,t,e);if(typeof n=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const s=n.valueOf&&n.valueOf();if(s!=null&&s!==n)return h.from(s,t,e);const l=Ne(n);if(l)return l;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof n[Symbol.toPrimitive]=="function")return h.from(n[Symbol.toPrimitive]("string"),t,e);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof n)}h.from=function(n,t,e){return E(n,t,e)},Object.setPrototypeOf(h.prototype,u.prototype),Object.setPrototypeOf(h,u);function R(n){if(typeof n!="number")throw new TypeError('"size" argument must be of type number');if(n<0)throw new RangeError('The value "'+n+'" is invalid for option "size"')}function v(n,t,e){return R(n),n<=0?m(n):t!==void 0?typeof e=="string"?m(n).fill(t,e):m(n).fill(t):m(n)}h.alloc=function(n,t,e){return v(n,t,e)};function V(n){return R(n),m(n<0?0:xt(n)|0)}h.allocUnsafe=function(n){return V(n)},h.allocUnsafeSlow=function(n){return V(n)};function G(n,t){if((typeof t!="string"||t==="")&&(t="utf8"),!h.isEncoding(t))throw new TypeError("Unknown encoding: "+t);const e=jt(n,t)|0;let s=m(e);const l=s.write(n,t);return l!==e&&(s=s.slice(0,l)),s}function J(n){const t=n.length<0?0:xt(n.length)|0,e=m(t);for(let s=0;s<t;s+=1)e[s]=n[s]&255;return e}function Lt(n){if(M(n,u)){const t=new u(n);return lt(t.buffer,t.byteOffset,t.byteLength)}return J(n)}function lt(n,t,e){if(t<0||n.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(n.byteLength<t+(e||0))throw new RangeError('"length" is outside of buffer bounds');let s;return t===void 0&&e===void 0?s=new u(n):e===void 0?s=new u(n,t):s=new u(n,t,e),Object.setPrototypeOf(s,h.prototype),s}function Ne(n){if(h.isBuffer(n)){const t=xt(n.length)|0,e=m(t);return e.length===0||n.copy(e,0,0,t),e}if(n.length!==void 0)return typeof n.length!="number"||Et(n.length)?m(0):J(n);if(n.type==="Buffer"&&Array.isArray(n.data))return J(n.data)}function xt(n){if(n>=a)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+a.toString(16)+" bytes");return n|0}function Le(n){return+n!=n&&(n=0),h.alloc(+n)}h.isBuffer=function(t){return t!=null&&t._isBuffer===!0&&t!==h.prototype},h.compare=function(t,e){if(M(t,u)&&(t=h.from(t,t.offset,t.byteLength)),M(e,u)&&(e=h.from(e,e.offset,e.byteLength)),!h.isBuffer(t)||!h.isBuffer(e))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(t===e)return 0;let s=t.length,l=e.length;for(let f=0,d=Math.min(s,l);f<d;++f)if(t[f]!==e[f]){s=t[f],l=e[f];break}return s<l?-1:l<s?1:0},h.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},h.concat=function(t,e){if(!Array.isArray(t))throw new TypeError('"list" argument must be an Array of Buffers');if(t.length===0)return h.alloc(0);let s;if(e===void 0)for(e=0,s=0;s<t.length;++s)e+=t[s].length;const l=h.allocUnsafe(e);let f=0;for(s=0;s<t.length;++s){let d=t[s];if(M(d,u))f+d.length>l.length?(h.isBuffer(d)||(d=h.from(d)),d.copy(l,f)):u.prototype.set.call(l,d,f);else if(h.isBuffer(d))d.copy(l,f);else throw new TypeError('"list" argument must be an Array of Buffers');f+=d.length}return l};function jt(n,t){if(h.isBuffer(n))return n.length;if(p.isView(n)||M(n,p))return n.byteLength;if(typeof n!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof n);const e=n.length,s=arguments.length>2&&arguments[2]===!0;if(!s&&e===0)return 0;let l=!1;for(;;)switch(t){case"ascii":case"latin1":case"binary":return e;case"utf8":case"utf-8":return bt(n).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return e*2;case"hex":return e>>>1;case"base64":return te(n).length;default:if(l)return s?-1:bt(n).length;t=(""+t).toLowerCase(),l=!0}}h.byteLength=jt;function je(n,t,e){let s=!1;if((t===void 0||t<0)&&(t=0),t>this.length||((e===void 0||e>this.length)&&(e=this.length),e<=0)||(e>>>=0,t>>>=0,e<=t))return"";for(n||(n="utf8");;)switch(n){case"hex":return Qe(this,t,e);case"utf8":case"utf-8":return Wt(this,t,e);case"ascii":return Ke(this,t,e);case"latin1":case"binary":return Xe(this,t,e);case"base64":return ze(this,t,e);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Ze(this,t,e);default:if(s)throw new TypeError("Unknown encoding: "+n);n=(n+"").toLowerCase(),s=!0}}h.prototype._isBuffer=!0;function z(n,t,e){const s=n[t];n[t]=n[e],n[e]=s}h.prototype.swap16=function(){const t=this.length;if(t%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let e=0;e<t;e+=2)z(this,e,e+1);return this},h.prototype.swap32=function(){const t=this.length;if(t%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let e=0;e<t;e+=4)z(this,e,e+3),z(this,e+1,e+2);return this},h.prototype.swap64=function(){const t=this.length;if(t%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let e=0;e<t;e+=8)z(this,e,e+7),z(this,e+1,e+6),z(this,e+2,e+5),z(this,e+3,e+4);return this},h.prototype.toString=function(){const t=this.length;return t===0?"":arguments.length===0?Wt(this,0,t):je.apply(this,arguments)},h.prototype.toLocaleString=h.prototype.toString,h.prototype.equals=function(t){if(!h.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t?!0:h.compare(this,t)===0},h.prototype.inspect=function(){let t="";const e=c.INSPECT_MAX_BYTES;return t=this.toString("hex",0,e).replace(/(.{2})/g,"$1 ").trim(),this.length>e&&(t+=" ... "),"<Buffer "+t+">"},o&&(h.prototype[o]=h.prototype.inspect),h.prototype.compare=function(t,e,s,l,f){if(M(t,u)&&(t=h.from(t,t.offset,t.byteLength)),!h.isBuffer(t))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof t);if(e===void 0&&(e=0),s===void 0&&(s=t?t.length:0),l===void 0&&(l=0),f===void 0&&(f=this.length),e<0||s>t.length||l<0||f>this.length)throw new RangeError("out of range index");if(l>=f&&e>=s)return 0;if(l>=f)return-1;if(e>=s)return 1;if(e>>>=0,s>>>=0,l>>>=0,f>>>=0,this===t)return 0;let d=f-l,x=s-e;const _=Math.min(d,x),b=this.slice(l,f),B=t.slice(e,s);for(let k=0;k<_;++k)if(b[k]!==B[k]){d=b[k],x=B[k];break}return d<x?-1:x<d?1:0};function Vt(n,t,e,s,l){if(n.length===0)return-1;if(typeof e=="string"?(s=e,e=0):e>2147483647?e=2147483647:e<-2147483648&&(e=-2147483648),e=+e,Et(e)&&(e=l?0:n.length-1),e<0&&(e=n.length+e),e>=n.length){if(l)return-1;e=n.length-1}else if(e<0)if(l)e=0;else return-1;if(typeof t=="string"&&(t=h.from(t,s)),h.isBuffer(t))return t.length===0?-1:Ht(n,t,e,s,l);if(typeof t=="number")return t=t&255,typeof u.prototype.indexOf=="function"?l?u.prototype.indexOf.call(n,t,e):u.prototype.lastIndexOf.call(n,t,e):Ht(n,[t],e,s,l);throw new TypeError("val must be string, number or Buffer")}function Ht(n,t,e,s,l){let f=1,d=n.length,x=t.length;if(s!==void 0&&(s=String(s).toLowerCase(),s==="ucs2"||s==="ucs-2"||s==="utf16le"||s==="utf-16le")){if(n.length<2||t.length<2)return-1;f=2,d/=2,x/=2,e/=2}function _(B,k){return f===1?B[k]:B.readUInt16BE(k*f)}let b;if(l){let B=-1;for(b=e;b<d;b++)if(_(n,b)===_(t,B===-1?0:b-B)){if(B===-1&&(B=b),b-B+1===x)return B*f}else B!==-1&&(b-=b-B),B=-1}else for(e+x>d&&(e=d-x),b=e;b>=0;b--){let B=!0;for(let k=0;k<x;k++)if(_(n,b+k)!==_(t,k)){B=!1;break}if(B)return b}return-1}h.prototype.includes=function(t,e,s){return this.indexOf(t,e,s)!==-1},h.prototype.indexOf=function(t,e,s){return Vt(this,t,e,s,!0)},h.prototype.lastIndexOf=function(t,e,s){return Vt(this,t,e,s,!1)};function Ve(n,t,e,s){e=Number(e)||0;const l=n.length-e;s?(s=Number(s),s>l&&(s=l)):s=l;const f=t.length;s>f/2&&(s=f/2);let d;for(d=0;d<s;++d){const x=parseInt(t.substr(d*2,2),16);if(Et(x))return d;n[e+d]=x}return d}function He(n,t,e,s){return ht(bt(t,n.length-e),n,e,s)}function We(n,t,e,s){return ht(ir(t),n,e,s)}function Ge(n,t,e,s){return ht(te(t),n,e,s)}function Je(n,t,e,s){return ht(nr(t,n.length-e),n,e,s)}h.prototype.write=function(t,e,s,l){if(e===void 0)l="utf8",s=this.length,e=0;else if(s===void 0&&typeof e=="string")l=e,s=this.length,e=0;else if(isFinite(e))e=e>>>0,isFinite(s)?(s=s>>>0,l===void 0&&(l="utf8")):(l=s,s=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const f=this.length-e;if((s===void 0||s>f)&&(s=f),t.length>0&&(s<0||e<0)||e>this.length)throw new RangeError("Attempt to write outside buffer bounds");l||(l="utf8");let d=!1;for(;;)switch(l){case"hex":return Ve(this,t,e,s);case"utf8":case"utf-8":return He(this,t,e,s);case"ascii":case"latin1":case"binary":return We(this,t,e,s);case"base64":return Ge(this,t,e,s);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Je(this,t,e,s);default:if(d)throw new TypeError("Unknown encoding: "+l);l=(""+l).toLowerCase(),d=!0}},h.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function ze(n,t,e){return t===0&&e===n.length?r.fromByteArray(n):r.fromByteArray(n.slice(t,e))}function Wt(n,t,e){e=Math.min(n.length,e);const s=[];let l=t;for(;l<e;){const f=n[l];let d=null,x=f>239?4:f>223?3:f>191?2:1;if(l+x<=e){let _,b,B,k;switch(x){case 1:f<128&&(d=f);break;case 2:_=n[l+1],(_&192)===128&&(k=(f&31)<<6|_&63,k>127&&(d=k));break;case 3:_=n[l+1],b=n[l+2],(_&192)===128&&(b&192)===128&&(k=(f&15)<<12|(_&63)<<6|b&63,k>2047&&(k<55296||k>57343)&&(d=k));break;case 4:_=n[l+1],b=n[l+2],B=n[l+3],(_&192)===128&&(b&192)===128&&(B&192)===128&&(k=(f&15)<<18|(_&63)<<12|(b&63)<<6|B&63,k>65535&&k<1114112&&(d=k))}}d===null?(d=65533,x=1):d>65535&&(d-=65536,s.push(d>>>10&1023|55296),d=56320|d&1023),s.push(d),l+=x}return Ye(s)}const Gt=4096;function Ye(n){const t=n.length;if(t<=Gt)return String.fromCharCode.apply(String,n);let e="",s=0;for(;s<t;)e+=String.fromCharCode.apply(String,n.slice(s,s+=Gt));return e}function Ke(n,t,e){let s="";e=Math.min(n.length,e);for(let l=t;l<e;++l)s+=String.fromCharCode(n[l]&127);return s}function Xe(n,t,e){let s="";e=Math.min(n.length,e);for(let l=t;l<e;++l)s+=String.fromCharCode(n[l]);return s}function Qe(n,t,e){const s=n.length;(!t||t<0)&&(t=0),(!e||e<0||e>s)&&(e=s);let l="";for(let f=t;f<e;++f)l+=or[n[f]];return l}function Ze(n,t,e){const s=n.slice(t,e);let l="";for(let f=0;f<s.length-1;f+=2)l+=String.fromCharCode(s[f]+s[f+1]*256);return l}h.prototype.slice=function(t,e){const s=this.length;t=~~t,e=e===void 0?s:~~e,t<0?(t+=s,t<0&&(t=0)):t>s&&(t=s),e<0?(e+=s,e<0&&(e=0)):e>s&&(e=s),e<t&&(e=t);const l=this.subarray(t,e);return Object.setPrototypeOf(l,h.prototype),l};function I(n,t,e){if(n%1!==0||n<0)throw new RangeError("offset is not uint");if(n+t>e)throw new RangeError("Trying to access beyond buffer length")}h.prototype.readUintLE=h.prototype.readUIntLE=function(t,e,s){t=t>>>0,e=e>>>0,s||I(t,e,this.length);let l=this[t],f=1,d=0;for(;++d<e&&(f*=256);)l+=this[t+d]*f;return l},h.prototype.readUintBE=h.prototype.readUIntBE=function(t,e,s){t=t>>>0,e=e>>>0,s||I(t,e,this.length);let l=this[t+--e],f=1;for(;e>0&&(f*=256);)l+=this[t+--e]*f;return l},h.prototype.readUint8=h.prototype.readUInt8=function(t,e){return t=t>>>0,e||I(t,1,this.length),this[t]},h.prototype.readUint16LE=h.prototype.readUInt16LE=function(t,e){return t=t>>>0,e||I(t,2,this.length),this[t]|this[t+1]<<8},h.prototype.readUint16BE=h.prototype.readUInt16BE=function(t,e){return t=t>>>0,e||I(t,2,this.length),this[t]<<8|this[t+1]},h.prototype.readUint32LE=h.prototype.readUInt32LE=function(t,e){return t=t>>>0,e||I(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+this[t+3]*16777216},h.prototype.readUint32BE=h.prototype.readUInt32BE=function(t,e){return t=t>>>0,e||I(t,4,this.length),this[t]*16777216+(this[t+1]<<16|this[t+2]<<8|this[t+3])},h.prototype.readBigUInt64LE=H(function(t){t=t>>>0,tt(t,"offset");const e=this[t],s=this[t+7];(e===void 0||s===void 0)&&nt(t,this.length-8);const l=e+this[++t]*2**8+this[++t]*2**16+this[++t]*2**24,f=this[++t]+this[++t]*2**8+this[++t]*2**16+s*2**24;return BigInt(l)+(BigInt(f)<<BigInt(32))}),h.prototype.readBigUInt64BE=H(function(t){t=t>>>0,tt(t,"offset");const e=this[t],s=this[t+7];(e===void 0||s===void 0)&&nt(t,this.length-8);const l=e*2**24+this[++t]*2**16+this[++t]*2**8+this[++t],f=this[++t]*2**24+this[++t]*2**16+this[++t]*2**8+s;return(BigInt(l)<<BigInt(32))+BigInt(f)}),h.prototype.readIntLE=function(t,e,s){t=t>>>0,e=e>>>0,s||I(t,e,this.length);let l=this[t],f=1,d=0;for(;++d<e&&(f*=256);)l+=this[t+d]*f;return f*=128,l>=f&&(l-=Math.pow(2,8*e)),l},h.prototype.readIntBE=function(t,e,s){t=t>>>0,e=e>>>0,s||I(t,e,this.length);let l=e,f=1,d=this[t+--l];for(;l>0&&(f*=256);)d+=this[t+--l]*f;return f*=128,d>=f&&(d-=Math.pow(2,8*e)),d},h.prototype.readInt8=function(t,e){return t=t>>>0,e||I(t,1,this.length),this[t]&128?(255-this[t]+1)*-1:this[t]},h.prototype.readInt16LE=function(t,e){t=t>>>0,e||I(t,2,this.length);const s=this[t]|this[t+1]<<8;return s&32768?s|4294901760:s},h.prototype.readInt16BE=function(t,e){t=t>>>0,e||I(t,2,this.length);const s=this[t+1]|this[t]<<8;return s&32768?s|4294901760:s},h.prototype.readInt32LE=function(t,e){return t=t>>>0,e||I(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},h.prototype.readInt32BE=function(t,e){return t=t>>>0,e||I(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},h.prototype.readBigInt64LE=H(function(t){t=t>>>0,tt(t,"offset");const e=this[t],s=this[t+7];(e===void 0||s===void 0)&&nt(t,this.length-8);const l=this[t+4]+this[t+5]*2**8+this[t+6]*2**16+(s<<24);return(BigInt(l)<<BigInt(32))+BigInt(e+this[++t]*2**8+this[++t]*2**16+this[++t]*2**24)}),h.prototype.readBigInt64BE=H(function(t){t=t>>>0,tt(t,"offset");const e=this[t],s=this[t+7];(e===void 0||s===void 0)&&nt(t,this.length-8);const l=(e<<24)+this[++t]*2**16+this[++t]*2**8+this[++t];return(BigInt(l)<<BigInt(32))+BigInt(this[++t]*2**24+this[++t]*2**16+this[++t]*2**8+s)}),h.prototype.readFloatLE=function(t,e){return t=t>>>0,e||I(t,4,this.length),i.read(this,t,!0,23,4)},h.prototype.readFloatBE=function(t,e){return t=t>>>0,e||I(t,4,this.length),i.read(this,t,!1,23,4)},h.prototype.readDoubleLE=function(t,e){return t=t>>>0,e||I(t,8,this.length),i.read(this,t,!0,52,8)},h.prototype.readDoubleBE=function(t,e){return t=t>>>0,e||I(t,8,this.length),i.read(this,t,!1,52,8)};function F(n,t,e,s,l,f){if(!h.isBuffer(n))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>l||t<f)throw new RangeError('"value" argument is out of bounds');if(e+s>n.length)throw new RangeError("Index out of range")}h.prototype.writeUintLE=h.prototype.writeUIntLE=function(t,e,s,l){if(t=+t,e=e>>>0,s=s>>>0,!l){const x=Math.pow(2,8*s)-1;F(this,t,e,s,x,0)}let f=1,d=0;for(this[e]=t&255;++d<s&&(f*=256);)this[e+d]=t/f&255;return e+s},h.prototype.writeUintBE=h.prototype.writeUIntBE=function(t,e,s,l){if(t=+t,e=e>>>0,s=s>>>0,!l){const x=Math.pow(2,8*s)-1;F(this,t,e,s,x,0)}let f=s-1,d=1;for(this[e+f]=t&255;--f>=0&&(d*=256);)this[e+f]=t/d&255;return e+s},h.prototype.writeUint8=h.prototype.writeUInt8=function(t,e,s){return t=+t,e=e>>>0,s||F(this,t,e,1,255,0),this[e]=t&255,e+1},h.prototype.writeUint16LE=h.prototype.writeUInt16LE=function(t,e,s){return t=+t,e=e>>>0,s||F(this,t,e,2,65535,0),this[e]=t&255,this[e+1]=t>>>8,e+2},h.prototype.writeUint16BE=h.prototype.writeUInt16BE=function(t,e,s){return t=+t,e=e>>>0,s||F(this,t,e,2,65535,0),this[e]=t>>>8,this[e+1]=t&255,e+2},h.prototype.writeUint32LE=h.prototype.writeUInt32LE=function(t,e,s){return t=+t,e=e>>>0,s||F(this,t,e,4,4294967295,0),this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=t&255,e+4},h.prototype.writeUint32BE=h.prototype.writeUInt32BE=function(t,e,s){return t=+t,e=e>>>0,s||F(this,t,e,4,4294967295,0),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=t&255,e+4};function Jt(n,t,e,s,l){Zt(t,s,l,n,e,7);let f=Number(t&BigInt(4294967295));n[e++]=f,f=f>>8,n[e++]=f,f=f>>8,n[e++]=f,f=f>>8,n[e++]=f;let d=Number(t>>BigInt(32)&BigInt(4294967295));return n[e++]=d,d=d>>8,n[e++]=d,d=d>>8,n[e++]=d,d=d>>8,n[e++]=d,e}function zt(n,t,e,s,l){Zt(t,s,l,n,e,7);let f=Number(t&BigInt(4294967295));n[e+7]=f,f=f>>8,n[e+6]=f,f=f>>8,n[e+5]=f,f=f>>8,n[e+4]=f;let d=Number(t>>BigInt(32)&BigInt(4294967295));return n[e+3]=d,d=d>>8,n[e+2]=d,d=d>>8,n[e+1]=d,d=d>>8,n[e]=d,e+8}h.prototype.writeBigUInt64LE=H(function(t,e=0){return Jt(this,t,e,BigInt(0),BigInt("0xffffffffffffffff"))}),h.prototype.writeBigUInt64BE=H(function(t,e=0){return zt(this,t,e,BigInt(0),BigInt("0xffffffffffffffff"))}),h.prototype.writeIntLE=function(t,e,s,l){if(t=+t,e=e>>>0,!l){const _=Math.pow(2,8*s-1);F(this,t,e,s,_-1,-_)}let f=0,d=1,x=0;for(this[e]=t&255;++f<s&&(d*=256);)t<0&&x===0&&this[e+f-1]!==0&&(x=1),this[e+f]=(t/d>>0)-x&255;return e+s},h.prototype.writeIntBE=function(t,e,s,l){if(t=+t,e=e>>>0,!l){const _=Math.pow(2,8*s-1);F(this,t,e,s,_-1,-_)}let f=s-1,d=1,x=0;for(this[e+f]=t&255;--f>=0&&(d*=256);)t<0&&x===0&&this[e+f+1]!==0&&(x=1),this[e+f]=(t/d>>0)-x&255;return e+s},h.prototype.writeInt8=function(t,e,s){return t=+t,e=e>>>0,s||F(this,t,e,1,127,-128),t<0&&(t=255+t+1),this[e]=t&255,e+1},h.prototype.writeInt16LE=function(t,e,s){return t=+t,e=e>>>0,s||F(this,t,e,2,32767,-32768),this[e]=t&255,this[e+1]=t>>>8,e+2},h.prototype.writeInt16BE=function(t,e,s){return t=+t,e=e>>>0,s||F(this,t,e,2,32767,-32768),this[e]=t>>>8,this[e+1]=t&255,e+2},h.prototype.writeInt32LE=function(t,e,s){return t=+t,e=e>>>0,s||F(this,t,e,4,2147483647,-2147483648),this[e]=t&255,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24,e+4},h.prototype.writeInt32BE=function(t,e,s){return t=+t,e=e>>>0,s||F(this,t,e,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=t&255,e+4},h.prototype.writeBigInt64LE=H(function(t,e=0){return Jt(this,t,e,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),h.prototype.writeBigInt64BE=H(function(t,e=0){return zt(this,t,e,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function Yt(n,t,e,s,l,f){if(e+s>n.length)throw new RangeError("Index out of range");if(e<0)throw new RangeError("Index out of range")}function Kt(n,t,e,s,l){return t=+t,e=e>>>0,l||Yt(n,t,e,4),i.write(n,t,e,s,23,4),e+4}h.prototype.writeFloatLE=function(t,e,s){return Kt(this,t,e,!0,s)},h.prototype.writeFloatBE=function(t,e,s){return Kt(this,t,e,!1,s)};function Xt(n,t,e,s,l){return t=+t,e=e>>>0,l||Yt(n,t,e,8),i.write(n,t,e,s,52,8),e+8}h.prototype.writeDoubleLE=function(t,e,s){return Xt(this,t,e,!0,s)},h.prototype.writeDoubleBE=function(t,e,s){return Xt(this,t,e,!1,s)},h.prototype.copy=function(t,e,s,l){if(!h.isBuffer(t))throw new TypeError("argument should be a Buffer");if(s||(s=0),!l&&l!==0&&(l=this.length),e>=t.length&&(e=t.length),e||(e=0),l>0&&l<s&&(l=s),l===s||t.length===0||this.length===0)return 0;if(e<0)throw new RangeError("targetStart out of bounds");if(s<0||s>=this.length)throw new RangeError("Index out of range");if(l<0)throw new RangeError("sourceEnd out of bounds");l>this.length&&(l=this.length),t.length-e<l-s&&(l=t.length-e+s);const f=l-s;return this===t&&typeof u.prototype.copyWithin=="function"?this.copyWithin(e,s,l):u.prototype.set.call(t,this.subarray(s,l),e),f},h.prototype.fill=function(t,e,s,l){if(typeof t=="string"){if(typeof e=="string"?(l=e,e=0,s=this.length):typeof s=="string"&&(l=s,s=this.length),l!==void 0&&typeof l!="string")throw new TypeError("encoding must be a string");if(typeof l=="string"&&!h.isEncoding(l))throw new TypeError("Unknown encoding: "+l);if(t.length===1){const d=t.charCodeAt(0);(l==="utf8"&&d<128||l==="latin1")&&(t=d)}}else typeof t=="number"?t=t&255:typeof t=="boolean"&&(t=Number(t));if(e<0||this.length<e||this.length<s)throw new RangeError("Out of range index");if(s<=e)return this;e=e>>>0,s=s===void 0?this.length:s>>>0,t||(t=0);let f;if(typeof t=="number")for(f=e;f<s;++f)this[f]=t;else{const d=h.isBuffer(t)?t:h.from(t,l),x=d.length;if(x===0)throw new TypeError('The value "'+t+'" is invalid for argument "value"');for(f=0;f<s-e;++f)this[f+e]=d[f%x]}return this};const Z={};function kt(n,t,e){Z[n]=class extends e{constructor(){super(),Object.defineProperty(this,"message",{value:t.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${n}]`,this.stack,delete this.name}get code(){return n}set code(l){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:l,writable:!0})}toString(){return`${this.name} [${n}]: ${this.message}`}}}kt("ERR_BUFFER_OUT_OF_BOUNDS",function(n){return n?`${n} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),kt("ERR_INVALID_ARG_TYPE",function(n,t){return`The "${n}" argument must be of type number. Received type ${typeof t}`},TypeError),kt("ERR_OUT_OF_RANGE",function(n,t,e){let s=`The value of "${n}" is out of range.`,l=e;return Number.isInteger(e)&&Math.abs(e)>2**32?l=Qt(String(e)):typeof e=="bigint"&&(l=String(e),(e>BigInt(2)**BigInt(32)||e<-(BigInt(2)**BigInt(32)))&&(l=Qt(l)),l+="n"),s+=` It must be ${t}. Received ${l}`,s},RangeError);function Qt(n){let t="",e=n.length;const s=n[0]==="-"?1:0;for(;e>=s+4;e-=3)t=`_${n.slice(e-3,e)}${t}`;return`${n.slice(0,e)}${t}`}function tr(n,t,e){tt(t,"offset"),(n[t]===void 0||n[t+e]===void 0)&&nt(t,n.length-(e+1))}function Zt(n,t,e,s,l,f){if(n>e||n<t){const d=typeof t=="bigint"?"n":"";let x;throw f>3?t===0||t===BigInt(0)?x=`>= 0${d} and < 2${d} ** ${(f+1)*8}${d}`:x=`>= -(2${d} ** ${(f+1)*8-1}${d}) and < 2 ** ${(f+1)*8-1}${d}`:x=`>= ${t}${d} and <= ${e}${d}`,new Z.ERR_OUT_OF_RANGE("value",x,n)}tr(s,l,f)}function tt(n,t){if(typeof n!="number")throw new Z.ERR_INVALID_ARG_TYPE(t,"number",n)}function nt(n,t,e){throw Math.floor(n)!==n?(tt(n,e),new Z.ERR_OUT_OF_RANGE(e||"offset","an integer",n)):t<0?new Z.ERR_BUFFER_OUT_OF_BOUNDS:new Z.ERR_OUT_OF_RANGE(e||"offset",`>= ${e?1:0} and <= ${t}`,n)}const er=/[^+/0-9A-Za-z-_]/g;function rr(n){if(n=n.split("=")[0],n=n.trim().replace(er,""),n.length<2)return"";for(;n.length%4!==0;)n=n+"=";return n}function bt(n,t){t=t||1/0;let e;const s=n.length;let l=null;const f=[];for(let d=0;d<s;++d){if(e=n.charCodeAt(d),e>55295&&e<57344){if(!l){if(e>56319){(t-=3)>-1&&f.push(239,191,189);continue}else if(d+1===s){(t-=3)>-1&&f.push(239,191,189);continue}l=e;continue}if(e<56320){(t-=3)>-1&&f.push(239,191,189),l=e;continue}e=(l-55296<<10|e-56320)+65536}else l&&(t-=3)>-1&&f.push(239,191,189);if(l=null,e<128){if((t-=1)<0)break;f.push(e)}else if(e<2048){if((t-=2)<0)break;f.push(e>>6|192,e&63|128)}else if(e<65536){if((t-=3)<0)break;f.push(e>>12|224,e>>6&63|128,e&63|128)}else if(e<1114112){if((t-=4)<0)break;f.push(e>>18|240,e>>12&63|128,e>>6&63|128,e&63|128)}else throw new Error("Invalid code point")}return f}function ir(n){const t=[];for(let e=0;e<n.length;++e)t.push(n.charCodeAt(e)&255);return t}function nr(n,t){let e,s,l;const f=[];for(let d=0;d<n.length&&!((t-=2)<0);++d)e=n.charCodeAt(d),s=e>>8,l=e%256,f.push(l),f.push(s);return f}function te(n){return r.toByteArray(rr(n))}function ht(n,t,e,s){let l;for(l=0;l<s&&!(l+e>=t.length||l>=n.length);++l)t[l+e]=n[l];return l}function M(n,t){return n instanceof t||n!=null&&n.constructor!=null&&n.constructor.name!=null&&n.constructor.name===t.name}function Et(n){return n!==n}const or=function(){const n="0123456789abcdef",t=new Array(256);for(let e=0;e<16;++e){const s=e*16;for(let l=0;l<16;++l)t[s+l]=n[e]+n[l]}return t}();function H(n){return typeof BigInt>"u"?sr:n}function sr(){throw new Error("BigInt not supported")}})(be);const W=be.Buffer;class re{constructor(){y(this,"algorithm","aes-256-cbc");y(this,"key");y(this,"iv",pt.randomBytes(16));this.algorithm="aes-256-cbc";const r="Tus7uAT6r3eSj9gVbF7Wic3ipNczYNK1";this.key=W.from(r),this.iv=pt.randomBytes(16)}encrypt(r){let i=pt.createCipheriv(this.algorithm,this.key,this.iv),o=i.update(r);return o=W.concat([o,i.final()]),{iv:this.iv.toString("hex"),encryptedData:o.toString("hex")}}decrypt(r){let i=W.from(r.iv,"hex"),o=W.from(r.encryptedData,"hex"),a=pt.createDecipheriv(this.algorithm,W.from(this.key),i),u=a.update(o);return u=W.concat([u,a.final()]),u.toString()}}const ie=require("keytar");class Er{constructor(r){y(this,"service");this.service=r}setPassword(r,i){ie.setPassword(this.service,r,i)}async getPassword(r){return await ie.getPassword(this.service,r)}}class Tt{constructor(){y(this,"store");y(this,"useSafestore");this.store=new Er("social-market-token"),this.useSafestore=!1}setValue(r,i){if(this.useSafestore){const o=at.safeStorage.encryptString(i);this.store.setPassword(r,o.toString())}else{const a=new re().encrypt(i);this.store.setPassword(r,JSON.stringify(a))}}async getValue(r){const i=await this.store.getPassword(r);return i?this.useSafestore?at.safeStorage.decryptString(W.from(i)):new re().decrypt(JSON.parse(i)):""}checkEncryavaile(r){return at.safeStorage.isEncryptionAvailable()}}class Pt{constructor(){y(this,"_headers",{});y(this,"baseUrl");this.baseUrl="http://localhost:8082"}async setheaderToken(){const i=await new Tt().getValue("social-market-token");console.log("prepare to set token:"+i),i&&this.setHeader("Authorization","Bearer "+i)}async _fetchJSON(r,i){await this.setheaderToken();const o=await fetch(this.baseUrl+r,{...i,headers:this._headers});if(!o.ok)throw new Error(o.statusText);const a=await o.json();return console.log(a),a}setHeader(r,i){return this._headers[r]=i,this}getHeader(r){return this._headers[r]}setBasicAuth(r,i){return this._headers.Authorization=`Basic ${btoa(`${r}:${i}`)}`,this}setBearerAuth(r){return this._headers.Authorization=`Bearer ${r}`,this}async get(r,i={}){return console.log(this._headers),this._fetchJSON(r,{...i,method:"GET"})}async post(r,i,o={}){return this._fetchJSON(r,{...o,body:i,method:"POST"})}async put(r,i){return this._fetchJSON(r,{body:i?JSON.stringify(i):void 0,method:"PUT"})}async patch(r,i,o={}){return this._fetchJSON(r,{...o,body:JSON.stringify(i),method:"PATCH"})}async delete(r,i={}){return this._fetchJSON(r,{...i,method:"DELETE"})}}function Ft(c){this.message=c}Ft.prototype=new Error,Ft.prototype.name="InvalidCharacterError";var ne=typeof window<"u"&&window.atob&&window.atob.bind(window)||function(c){var r=String(c).replace(/=+$/,"");if(r.length%4==1)throw new Ft("'atob' failed: The string to be decoded is not correctly encoded.");for(var i,o,a=0,u=0,p="";o=r.charAt(u++);~o&&(i=a%4?64*i+o:o,a++%4)?p+=String.fromCharCode(255&i>>(-2*a&6)):0)o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(o);return p};function _r(c){var r=c.replace(/-/g,"+").replace(/_/g,"/");switch(r.length%4){case 0:break;case 2:r+="==";break;case 3:r+="=";break;default:throw"Illegal base64url string!"}try{return function(i){return decodeURIComponent(ne(i).replace(/(.)/g,function(o,a){var u=a.charCodeAt(0).toString(16).toUpperCase();return u.length<2&&(u="0"+u),"%"+u}))}(r)}catch{return ne(r)}}function gt(c){this.message=c}function Br(c,r){if(typeof c!="string")throw new gt("Invalid token specified");var i=(r=r||{}).header===!0?0:1;try{return JSON.parse(_r(c.split(".")[i]))}catch(o){throw new gt("Invalid token specified: "+o.message)}}gt.prototype=new Error,gt.prototype.name="InvalidTokenError";const oe=require("debug")("RemoteSource");class yt{constructor(){y(this,"tokenname","social-market-token");y(this,"REMOTEADD");y(this,"_httpClient");this._httpClient=new Pt}readConfig(){const r=require("dotenv").config();if(r.error)throw r.error;return r.parsed}async getRemoteConfig(r){return this._httpClient.get("/api/getsobyCam/?campaign_id="+r).then(function(o){if(o.status!=200)throw new Error("code not equal 200");if(!o.data.status)throw new Error("code not equal 200");return{sotype:o.data.data.sotype,socialuser:o.data.data.user,socialpass:o.data.data.pass,proxy:{proxy:o.data.data.proxy.url,user:o.data.data.proxy.user,pass:o.data.data.proxy.pass}}}).catch(function(o){console.error(o)})}async saveLinkremote(r){const i=require("form-data");oe(r);const o=new i;return o.append("title",r.title),r.content&&o.append("content",r.content),o.append("url",r.url),o.append("lang",r.lang),r.socialtask_id&&o.append("socialtask_id",r.socialtask_id),this._httpClient.post("/api/savesolink",o).then(function(u){return u.data.data}).catch(function(u){throw new Error(u.message)})}async Getscrapyinfolist(r,i){return this._httpClient.get("/api/getscrapeinfolist?sotaskid="+r+"&limit="+i).then(function(a){return oe(a),a.data.data?a.data.data:null}).catch(function(a){throw new Error(a.message)})}async Gettaskinfo(r){return this._httpClient.get("/api/getsocialtaskinfo?task_id="+r).then(function(o){return o.data.data}).catch(function(o){throw new Error(o.message)})}async Gettaskkeywords(r){return this._httpClient.get("/api/taskkeyword?task_id="+r).then(function(o){const a=[],u=o.data.data;for(const p in u)a.push(u[p].keyword);return a}).catch(function(o){throw new Error(o.message)})}async Updateprocesstime(r){const i=require("form-data"),o=new i;o.append("id",r),await this._httpClient.post("/api/updatescrapeprotime",o).then(function(a){}).catch(function(a){throw new Error(a.message)})}async Login(r,i){var o=new FormData;o.append("username",r),o.append("password",i),console.log(Array.from(o));const a=this;return await this._httpClient.post("/user/login",o).then(function(p){if(!p.status)throw new Error(p.msg);const g=a.ValidateToken(p.data.Token);return g.account_id>0&&new Tt().setValue(a.tokenname,p.data.Token),g}).catch(function(p){throw new Error(p.message)})}async GetUserInfo(){const i=await new Tt().getValue(this.tokenname);return i==null||i.length<1?null:(console.log("token is:"+i),await this._httpClient.get("/api/user/info").then(function(a){if(a.status==!1)throw new Error(a.msg);return a.data}).catch(function(a){throw new Error(a.message)}))}ValidateToken(r){const i=Br(r);return{account_id:i.AccountId,email:i.Email,roles:i.Roles?i.Roles:[]}}}const ft=require("debug")("se-scraper:Scraper"),Sr=require("app-root-path"),se=require("fs");class Nt{constructor(r){y(this,"config");y(this,"page");y(this,"last_response");y(this,"metadata");y(this,"pluggable");y(this,"context");y(this,"logger");y(this,"proxy");y(this,"keywords");y(this,"STANDARD_TIMEOUT");y(this,"SOLVE_CAPTCHA_TIME");y(this,"results");y(this,"result_rank");y(this,"num_requests");y(this,"num_keywords");y(this,"taskid");y(this,"observers",[]);r.page&&(this.page=r.page),this.last_response=null,this.metadata={scraping_detected:!1},this.pluggable=r.pluggable,this.config=r.config,this.logger=this.config.logger,this.context=r.context,r.config.proxy&&(this.proxy=r.config.proxy),r.config.keywords&&(this.keywords=r.config.keywords),r.taskid&&(this.taskid=r.taskid),this.STANDARD_TIMEOUT=1e4,this.SOLVE_CAPTCHA_TIME=45e3,this.results={},this.result_rank=1,this.num_requests=0,this.num_keywords=0;let i=this.config[`${this.config.search_engine}_settings`];i&&typeof i=="string"&&(i=JSON.parse(i),this.config[`${this.config.search_engine}_settings`]=i)}attach(r){if(this.observers.includes(r))return console.log("Subject: Observer has been attached already.");console.log("Subject: Attached an observer."),this.observers.push(r)}detach(r){const i=this.observers.indexOf(r);if(i===-1)return console.log("Subject: Nonexistent observer.");this.observers.splice(i,1),console.log("Subject: Detached an observer.")}notify(r,i){console.log("Subject: Notifying observers...");for(const o of this.observers)o.update(r,i)}async runLogin(r){var i;ft("worker=%o",r.worker,this.config.keywords),r.page&&(this.page=r.page),await((i=this.page)==null?void 0:i.setViewport({width:1280,height:800})),await this.load_browser_engine(),await this.makeloginaction()}async load_browser_engine(){var r,i,o;if(this.config.apply_evasion_techniques===!0&&await Ir(this.page),this.config.block_assets===!0&&(await this.page.setRequestInterception(!0),this.page.on("request",a=>{const u=a.resourceType();["stylesheet","font","image","media"].includes(u)?a.abort():a.continue()})),this.config.test_evasion===!0){const a="https://bot.sannysoft.com";await this.page.goto(a),await this.page.screenshot({path:"headless-evasion-result.png"})}if(this.config.log_http_headers===!0&&(this.metadata.http_headers=await fr(this.page)),this.config.log_ip_address===!0){const a=await pr(this.page);this.metadata.ipinfo=a}if(this.proxy&&this.config.log_ip_address===!0){if(ft(`${(r=this.metadata.ipinfo)==null?void 0:r.ip} vs ${this.proxy}`),(i=this.metadata.ipinfo)!=null&&i.ip&&!this.proxy.includes((o=this.metadata.ipinfo)==null?void 0:o.ip))throw new Error(`Proxy output ip ${this.proxy} does not match with provided one`);this.logger.info(`Using valid Proxy: ${this.proxy}`)}return await this.load_start_page()}async load_login_page(){}async load_start_page(){}async makeloginaction(){}async userloginaction(){}async searchdata(r){}async workersearchdata(r){if(r.worker&&ft("worker=%o",r.worker,this.config.keywords),r.page&&(this.page=r.page),await this.page.setViewport({width:1280,height:800}),await this.load_browser_engine(),!this.config.keywords){console.error("keyword is empty");return}const i=await this.searchdata({keyword:this.config.keywords}),o=new yt;i==null||i.map(async a=>{const u={title:a.title,url:a.link,lang:a.lang,socialtask_id:a.taskid};try{await o.saveLinkremote(u)}catch(p){console.error(p)}})}async downloadvideo(r){const i=new Date,o=i.getFullYear()+"-"+(i.getMonth()+1)+"-"+i.getDate(),a=A.resolve(Sr+"/tmp/video/"+o+"/");se.existsSync(a)||se.mkdirSync(a,{recursive:!0}),r.forEach(async(u,p)=>{ft(u);const g=await this.downloadSigleVideo(u.url,a);if(g)for(let w=0;w<g.length;w++){const h={video:{url:u.url,localpath:g[w],title:u.title,description:u.content,language:u.lang},scrapeinfo:u};this.notify("downloadvideoend",h)}})}async downloadSigleVideo(r,i){}}async function Ir(c){await c.evaluateOnNewDocument(()=>{const r=Object.getPrototypeOf(navigator);delete r.webdriver,Object.setPrototypeOf(navigator,r)}),await c.evaluateOnNewDocument(()=>{}),await c.evaluateOnNewDocument(()=>{Object.defineProperty(navigator,"plugins",{get:()=>[1,2,3,4,5]})}),await c.evaluateOnNewDocument(()=>{Object.defineProperty(navigator,"languages",{get:()=>["en-US","en"]})}),await c.evaluateOnNewDocument(()=>{Object.defineProperty(HTMLIFrameElement.prototype,"contentWindow",{get:function(){return window}})}),await c.evaluateOnNewDocument(()=>{window.console.debug=()=>null})}class vr extends Nt{constructor(r){super(r)}async load_login_page(){const r="https://www.facebook.com";this.logger.info("Using loginUrl: "+r),this.last_response=await this.page.goto(r)}async userloginaction(){}}const Tr=require("fs");class _e extends Nt{constructor(r){super(r)}async load_login_page(){const r="https://www.youtube.com";this.logger.info("Using loginUrl: "+r),await this.page.setBypassCSP(!0),this.last_response=await this.page.goto(r),await this.page.evaluate(()=>{const o=document.getElementById("logo-icon");o&&(o.style.display="none")}),console.log(this.config.tmppath),await this.page.waitForSelector("#avatar-btn",{timeout:0});const i=await this.page.cookies();await Tr.writeFile(this.config.tmppath+"/cookies.json",JSON.stringify(i,null,2))}}module.exports={YoutubeScraper:_e};const ae=require("fs"),ce=require("crypto"),Fr=require("http"),Cr=require("https"),Ar=require("progress-stream"),St=require("node-fetch"),Ur=require("debug")("bilibili-download"),Rr=Ur("app:error");class Be{constructor(r){y(this,"url");y(this,"finished");this.url=r,this.finished=!1}}class Se{constructor(){y(this,"type");y(this,"id");y(this,"url");y(this,"aid");y(this,"pid");y(this,"cid");y(this,"name");y(this,"links");y(this,"tasks");this.type="",this.id="",this.url="",this.aid=-1,this.pid=1,this.cid=-1,this.name="",this.links=[],this.tasks=[]}getVideoUrl(r){if(!r)throw new Error("video url is empty");this.url="";const i={BV:"https://www.bilibili.com/video/",bv:"https://www.bilibili.com/video/",av:"https://www.bilibili.com/video/",ep:"https://www.bilibili.com/bangumi/play/",ss:"https://www.bilibili.com/bangumi/play/"};for(const[o,a]of Object.entries(i))if(r.includes(o)){this.type=o,this.id=o+r.split(o)[1],this.url=a+this.id;break}}async getAid(){const{type:r,url:i}=this;if(i)return St(i).then(o=>o.text()).then(o=>{const a=o.match(/__INITIAL_STATE__=(.*?);\(function\(\)/)[1],u=JSON.parse(a);r==="BV"||r==="bv"||r==="av"?(this.aid=u.videoData.aid,this.pid=parseInt(i.split("p=")[1],10)||1,this.cid=u.videoData.pages[this.pid-1].cid):r==="ep"?(this.aid=u.epInfo.aid,this.cid=u.epInfo.cid):r==="ss"&&(this.aid=u.epList[0].aid,this.cid=u.epList[0].cid)}).catch(function(o){throw new Error("get video aid error")})}async getInfo(){const{aid:r,cid:i}=this;if(!i)throw new Error("get video cid error");return St("https://api.bilibili.com/x/web-interface/view?aid="+r).then(o=>o.json()).catch(function(o){throw new Error("get video info error")})}async getData(r=!1){const{cid:i,type:o}=this;let a;if(r){const u=`cid=${i}&module=movie&player=1&quality=112&ts=1`,p=ce.createHash("md5").update(u+"9b288147e5474dd2aa67085f716c560d").digest("hex");a=`https://bangumi.bilibili.com/player/web_api/playurl?${u}&sign=${p}`}else if(o==="BV"||o==="bv"||o==="av"){const u=`appkey=iVGUTjsxvpLeuDCf&cid=${i}&otype=json&qn=112&quality=112&type=`,p=ce.createHash("md5").update(u+"aHRmhWMLkdeMuILqORnYZocwMBpMEOdt").digest("hex");a=`https://interface.bilibili.com/v2/playurl?${u}&sign=${p}`}else a=`https://api.bilibili.com/pgc/player/web/playurl?qn=80&cid=${i}`;return St(a).then(u=>u.text()).then(u=>{const p=r?this.parseData(u):JSON.parse(u),g=p.durl||p.result.durl;if(g)return this.links=g.map(w=>w.url),{fallback:r,data:p};if(r)throw Error();return this.getData(!0)}).catch(function(u){throw new Error("get playUrl or download link error")})}parseData(r){const i=$(r),o={durl:[],quality:""};return o.durl=[],o.quality=i.find("quality").text(),i.find("durl").each((a,u)=>{const p=$(u);o.durl.push({url:p.find("url").text(),order:p.find("order").text(),length:p.find("length").text(),size:p.find("size").text()})}),o}downloadByIndex(r,i,o=(a,u)=>{}){const{url:a}=this;if(this.tasks.some(w=>w.url===this.links[r]))return"DUPLICATE";this.tasks.push(new Be(this.links[r]));let u;try{u=ae.statSync(i)}catch{}const p={url:this.links[r],headers:{Range:`bytes=${u?u.size:0}-`,"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.212 Safari/537.36",Referer:a}},g=ae.createWriteStream(i,u?{flags:"a"}:{});return this.download(p,g,o),u}download(r,i,o){const a=this.tasks.findIndex(w=>w.url===r.url),u=Ar({time:250}).on("progress",w=>{const{percentage:m}=w;m===100&&(this.tasks[a].finished=!0),o(w,a)}),{url:p}=r;function g(w){(w.startsWith("https")?Cr:Fr).get(w,r,m=>{if(m.statusCode===302)return w=m.headers.location,g(w);u.setLength(m.headers["content-length"]),m.pipe(u).pipe(i).on("error",h=>{Rr(h)})})}g(p)}}module.exports={Task:Be,Downloader:Se};function $r(c){return c&&c.__esModule&&Object.prototype.hasOwnProperty.call(c,"default")?c.default:c}var Ie={exports:{}},S=Ie.exports={},O,D;function Ct(){throw new Error("setTimeout has not been defined")}function At(){throw new Error("clearTimeout has not been defined")}(function(){try{typeof setTimeout=="function"?O=setTimeout:O=Ct}catch{O=Ct}try{typeof clearTimeout=="function"?D=clearTimeout:D=At}catch{D=At}})();function ve(c){if(O===setTimeout)return setTimeout(c,0);if((O===Ct||!O)&&setTimeout)return O=setTimeout,setTimeout(c,0);try{return O(c,0)}catch{try{return O.call(null,c,0)}catch{return O.call(this,c,0)}}}function Mr(c){if(D===clearTimeout)return clearTimeout(c);if((D===At||!D)&&clearTimeout)return D=clearTimeout,clearTimeout(c);try{return D(c)}catch{try{return D.call(null,c)}catch{return D.call(this,c)}}}var L=[],it=!1,Q,dt=-1;function Or(){!it||!Q||(it=!1,Q.length?L=Q.concat(L):dt=-1,L.length&&Te())}function Te(){if(!it){var c=ve(Or);it=!0;for(var r=L.length;r;){for(Q=L,L=[];++dt<r;)Q&&Q[dt].run();dt=-1,r=L.length}Q=null,it=!1,Mr(c)}}S.nextTick=function(c){var r=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)r[i-1]=arguments[i];L.push(new Fe(c,r)),L.length===1&&!it&&ve(Te)};function Fe(c,r){this.fun=c,this.array=r}Fe.prototype.run=function(){this.fun.apply(null,this.array)};S.title="browser";S.browser=!0;S.env={};S.argv=[];S.version="";S.versions={};function j(){}S.on=j;S.addListener=j;S.once=j;S.off=j;S.removeListener=j;S.removeAllListeners=j;S.emit=j;S.prependListener=j;S.prependOnceListener=j;S.listeners=function(c){return[]};S.binding=function(c){throw new Error("process.binding is not supported")};S.cwd=function(){return"/"};S.chdir=function(c){throw new Error("process.chdir is not supported")};S.umask=function(){return 0};var Dr=Ie.exports;const rt=$r(Dr),Ce=require("path");async function qr(c){await c.evaluate(async()=>{await new Promise(r=>{let i=0;const o=100;var a=setInterval(()=>{const u=document.body.scrollHeight;window.scrollBy(0,o),i+=o,i>=u-window.innerHeight&&(clearInterval(a),r(void 0))},100)})})}function Ae(){const c=new Date;return c.getFullYear().toString()+"-"+N(c.getMonth()+1)+"-"+N(c.getDate())+" "+N(c.getHours())+":"+N(c.getMinutes())+":"+N(c.getSeconds())}function N(c){return c<10?"0"+c.toString():c.toString()}function Pr(){const c=new Date;return c.getFullYear().toString()+"-"+N(c.getMonth()+1)+"-"+N(c.getDate())+" "+N(c.getHours())+":"+N(c.getMinutes())+":"+N(c.getSeconds())}function Nr(){switch(rt.platform){case"darwin":return Ce.join(rt.env.HOME,"Library","Application Support");case"win32":return rt.env.APPDATA;case"linux":return rt.env.HOME}}function Lr(){if(!Nr())return;const r="social-marketing";return Ce.join(rt.env.HOME,r,"log")}require("cheerio");const It=require("fs"),jr=require("path"),Vr=require("filenamify"),C=require("debug")("bilibili-scraper"),Hr=C("app:error");class Ue extends Nt{constructor(i){super(i);y(this,"startUrl");this.startUrl="https://www.bilibili.com"}async load_start_page(){C("load start page")}async makeloginaction(){this.logger.info("Using loginUrl: "+this.startUrl),await this.page.setBypassCSP(!0),this.last_response=await this.page.goto(this.startUrl),C("login success, cookies has been save at "+this.config.tmppath),await this.page.click(".header-login-entry"),await this.page.waitForSelector(".bili-mini-content-wp",{timeout:this.STANDARD_TIMEOUT});const i=await this.page.$("//div[contains(., ' 短信登录 ')]");i&&await i.click(),await this.page.waitForSelector(".header-entry-mini",{timeout:0});const o=await this.page.cookies();return await It.writeFile(this.config.tmppath+"/cookies.json",JSON.stringify(o,null,2),a=>{a&&Hr(a)}),await this.page.close(),!0}async clickSearchbtn(i){i.page&&(this.page=i.page),this.logger.info("Using loginUrl: "+this.startUrl),await this.page.setBypassCSP(!0),this.last_response=await this.page.goto(this.startUrl),await this.page.type(".nav-search-input",i.keyword);const o=await this.page.$(".nav-search-btn");return o&&await o.click(),o}async searchdata(i){i.page&&(this.page=i.page);const o=[];if(Array.isArray(i.keyword))for(const a of i.keyword){const u={page:this.page,keyword:a},p=await this.getVideourls(u);if(p)for(const g of p)o.push(g)}else if(typeof i.keyword=="string"){const a={page:this.page,keyword:i.keyword},u=await this.getVideourls(a);if(u)for(const p of u)o.push(u)}return o}async getVideourls(i){if(i.page&&(this.page=i.page),i.cookiesPath){if(!It.existsSync(i.cookiesPath))throw new Error(`Cannot find cookies file at ${i.cookiesPath}`);const o=JSON.parse(await It.promises.readFile(i.cookiesPath));await this.page.setCookie(...o)}if(typeof i.keyword=="string")return await this.handleSearch({page:this.page,keyword:i.keyword});{const o=[];for(const a of i.keyword){const u=await this.handleSearch({page:this.page,keyword:a});if(u)for(const p of u)o.push(p)}return o}}async handleSearch(i){await this.clickSearchbtn({page:this.page,keyword:i.keyword});const o=this.page.browser();await o.waitForTarget(w=>w.url().includes("search.bilibili.com"));const a=await o.pages();let u;for(const w of a)if((await w.url()).includes("search.bilibili.com")){u=w;break}if(!u)throw new Error("search page not found");await qr(u);try{await u.waitForSelector(".vui_pagenation",{timeout:5e3})}catch{return C("not find .vui_pagenation item, the page may not have result"),new Promise(m=>{m(null)})}const p=[],g=await u.$$("button.vui_button");C(g);for(let w=0;w<g.length;w++){await u.evaluate(h=>{h.click()},g[w]);const m=await this.getVideolistlink({page:u});C(m),m.map(h=>{p.push(h)})}return p}async getVideolistlink({page:i}){i&&(this.page=i);let o=[];C(this.config.taskid);let a=0;return this.config.taskid&&(a=this.config.taskid),o=await this.page.$$eval(".bili-video-card__info--right >a:first-child",(u,p)=>u.map(g=>{const w={title:"",link:"",lang:"zh-cn"};p&&(w.taskid=p);const m=g.getAttribute("href");m&&(w.link=m);const h=g.querySelector("h3");if(h){const E=h.getAttribute("title");E&&(w.title=E)}return w}),a),await o.forEach((u,p)=>{u.link.includes("/video/")||o.splice(p,1)}),await o.forEach((u,p)=>{u.link.includes("/api/")&&(C("element has api "+u),o.splice(p,1))}),C(o),o}async downloadSigleVideo(i,o){if(!i)throw C(i),new Error("link is empty");const a=new Se;if(a.getVideoUrl(i),!a.url)throw new Error("video url invalid");await a.getAid();const u=await a.getInfo();C("VIDEO INFO",u);const p=Math.random().toString(20).slice(2),{data:g,fallback:w}=await a.getData(),m=g.durl||g.result.durl,h=g.quality||g.result.quality,R={112:"1080P+",80:"1080P",74:"720P60",64:"720P",48:"720P",32:"480P",16:"360P",15:"360P"}[h]||"unknown";if(C("videoQuantity is "+R),w)throw new Error("error happen when get video data");const v=[];return m.forEach((V,G)=>{const J=jr.join(o,`${Vr(p)}-${G}.flv`);C("part is %o",G),C("file name %o",J),a.downloadByIndex(G,J,(Lt,lt)=>{}),v.push(J)}),v}async getVideodetail(i,o){i&&(this.page=i),await this.page.goto(o,{waitUntil:"domcontentloaded"})}}module.exports={BilibiliScraper:Ue};const Y=require("debug")("videoedit");class Wr{async removeWatermark(r,i,o,a){if(!q.existsSync(r))throw new Error("video path not exist for the path "+r);const u=A.dirname(i);q.existsSync(u)||q.mkdirSync(u,{recursive:!0});const p=await _t.spawn("Marketingtool",["--action","removeWatermark","-f",r,"-o",i]);p.stdout.on("data",g=>{Y(`stdout: ${g}`)}),p.stderr.on("data",g=>{Y(`stderr: ${g}`)}),p.on("close",g=>{if(Y(`watermark remove child process exited with code ${g}`),a&&g==0)Y("run callback"),a(o,i);else{const w="_convert";if(r.includes(w))return;{Y("start convert video");const m=A.dirname(r)+A.sep+A.parse(r).name+w+".mp4";this.convertvideo(r,m,()=>this.removeWatermark(m,i,o,a))}}})}async getVideocaptions(r,i,o,a){if(!q.existsSync(r))throw new Error("video path not exist");await _t.spawn("Marketingtool",["--action","translate","-f",r,"--source-lang",o,"--target-lang",a])}async convertvideo(r,i,o){if(!q.existsSync(r))throw new Error("video path not exist");(await _t.spawn("Marketingtool",["--action","convertvideo","-f",r,"-o",i])).on("close",u=>{Y(`convert video child process exited with code ${u}`),u!=1&&Y("convert command failure: Marketingtool --action convertvideo -f "+r+" -o "+i)})}}const Gr=require("debug")("scraperdb"),ue=require("app-root-path"),X=class X{constructor(){y(this,"dbname");y(this,"db");y(this,"pathdb");const r=A.resolve(ue+"/tmp/db/");q.existsSync(r)||q.mkdirSync(r,{recursive:!0}),this.dbname="scraper.db",this.pathdb=r+"/"+this.dbname,this.db=new hr.Database(this.pathdb,i=>{if(i)throw new Error("Getting error "+i)})}static getInstance(){return X.instance||(X.instance=new X),X.instance}init(){this.createTables()}getdb(){return this.db}createTables(){const r=A.resolve(ue+"/src/sql/scraperdb/");q.readdir(r,(i,o)=>{Gr(o),o.forEach(a=>{this.db.exec(q.readFileSync(r+A.sep+a).toString())})})}};y(X,"instance");let ct=X;class le{constructor(){y(this,"db");y(this,"videoTable","video");y(this,"videoDescriptionTable","video_description");y(this,"language",[{id:1,name:"en-us"},{id:2,name:"zh-cn"}]);const r=ct.getInstance();this.db=r.getdb()}saveVideo(r,i){let o=0;for(let g=0;g<this.language.length;g++)this.language[g].name==r.language&&(o=this.language[g].id);const a=Ae(),u="INSERT INTO "+this.videoTable+" (url,localpath,record_time) VALUES (?,?,?)",p=this;this.db.run(u,[r.url,r.localpath,a],function(g){if(g)throw new Error(g.message+" url:"+r.url+" recordtime:"+a);if(this.lastID){const w="INSERT INTO "+p.videoDescriptionTable+" (video_id,language_id,title,description) VALUES (?,?,?,?)";p.db.run(w,[this.lastID,o,r.title,r.description],function(m){if(m)throw new Error(m.message)}),i&&i(this.lastID)}})}updateVideofilter(r,i){const o="UPDATE "+this.videoTable+" SET filterwatermark = ? WHERE id = ?";this.db.run(o,[i,r],function(a){if(a)throw new Error(a.message)})}truncatedb(){const r="DELETE FROM "+this.videoTable;this.db.run(r,[],function(o){if(o)throw new Error(o.message)});const i="DELETE FROM "+this.videoDescriptionTable;this.db.run(i,[],function(o){if(o)throw new Error(o.message)})}}const he=require("debug")("Observer:videodownloadObserver"),Jr=require("app-root-path");class zr{constructor(){}update(r,i){switch(r){case"downloadvideoend":this.videodownloadend(i);break}}videodownloadend(r){he(r);const i=new le,o=new Wr,u=A.resolve(Jr+"/tmp/video/filterwater/")+A.sep+Math.random().toString(16).slice(2)+".mp4";i.saveVideo(r.video,g=>o.removeWatermark(r.video.localpath,u,g,function(m,h){const E=new le;he("start to update video filter, the insert id is "+m+" the output path is "+h),E.updateVideofilter(m,h)}));const p=new yt;r.scrapeinfo.id&&p.Updateprocesstime(r.scrapeinfo.id)}}const{Browser:Yr}=require("puppeteer-cluster/dist/concurrency/builtInConcurrency"),vt=require("debug")("se-scraper:CustomConcurrency"),{timeoutExecute:pe}=require("puppeteer-cluster/dist/util"),fe=5e3;class Kr extends Yr{async init(){}async close(){}async workerInstance(){const r=this.options.perBrowserOptions.shift();vt("Launch puppeteer instance with options=%o",r);let i=await this.puppeteer.launch(r),o,a;return{jobInstance:async()=>(await pe(fe,(async()=>{a=await i.createIncognitoBrowserContext(),o=await a.newPage()})()),{resources:{page:o},close:async()=>{await pe(fe,a.close())}}),close:async()=>{await i.close()},repair:async()=>{vt("Starting repair");try{await i.close()}catch(u){vt("Failed to close chrome: %o",u)}i=await this.puppeteer.launch(r)}}}}const Ut=require("fs"),Xr=require("os"),K=require("lodash"),{createLogger:Qr,format:Zr,transports:ti}=require("winston"),{combine:ei,timestamp:ri,printf:ii}=Zr,ot=require("debug")("se-scraper:ScrapeManager"),{Cluster:de}=require("puppeteer-cluster"),ni=require("puppeteer"),{addExtra:oi}=require("puppeteer-extra"),si=require("user-agents"),ai=6;function ge(c){let r=Ut.readFileSync(c).toString().split(Xr.EOL);return r=r.filter(i=>i.trim().length>0),r}function st(c,r){if(typeof c=="string")return new{facebook:vr,youtube:_e,bilibili:Ue}[c](r);throw new Error("social platform must either be a string of class (function)")}class mt{constructor(r,i={}){y(this,"cluster");y(this,"pluggable");y(this,"scraper");y(this,"context");y(this,"config");y(this,"logger");y(this,"browser");y(this,"page");y(this,"numClusters");y(this,"tmppath");y(this,"runLogin");if(this.context=i,this.config=K.defaults(r,{user_agent:"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36",random_user_agent:!1,set_manual_settings:!1,log_ip_address:!1,log_http_headers:!1,sleep_range:null,logger:Qr({level:"info",format:ei(ri(),ii(({level:o,message:a,timestamp:u})=>`${u} [${o}] ${a}`)),transports:[new ti.Console]}),platform:"facebook",keywords:["nodejs rocks"],chrome_flags:["--disable-infobars","--window-position=0,0","--ignore-certifcate-errors","--ignore-certifcate-errors-spki-list","--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-accelerated-2d-canvas","--disable-gpu","--window-size=1280,768","--start-fullscreen","--hide-scrollbars","--disable-notifications"],ignoreDefaultArgs:["--enable-automation","--disable-extensions","--disable-default-apps","--disable-component-extensions-with-background-pages"],num_pages:1,output_file:"",html_output:!1,clean_html_output:!0,clean_data_images:!0,screen_output:!1,scrape_from_file:"",block_assets:!0,custom_func:null,throw_on_detection:!1,proxies:null,proxy_file:"",use_proxies_only:!1,test_evasion:!1,apply_evasion_techniques:!0,puppeteer_cluster_config:{timeout:30*60*1e3,monitor:!1,concurrency:de.CONCURRENCY_BROWSER,maxConcurrency:1}}),this.logger=this.config.logger,r.sleep_range&&r.sleep_range.length!==2)throw"sleep_range is not a valid array of two integers.";if(Ut.existsSync(this.config.keyword_file)&&(this.config.keywords=ge(this.config.keyword_file)),this.config.proxies&&this.config.proxy_file)throw new Error("Either use a proxy_file or specify a proxy for all connections. Do not use both options.");if(this.config.proxy_file&&(this.config.proxies=ge(this.config.proxy_file),this.logger.info(`${this.config.proxies.length} proxies read from file.`)),!this.config.proxies&&this.config.use_proxies_only)throw new Error("Must provide at least one proxy in proxies if you enable use_proxies_only");ot("this.config=%O",this.config)}async start(){if(this.config.custom_func)if(Ut.existsSync(this.config.custom_func))try{const i=require(this.config.custom_func);this.pluggable=new i({config:this.config,context:this.context})}catch(i){return console.error(i),!1}else return console.error(`File "${this.config.custom_func}" does not exist!`),!1;const r=K.clone(this.config.chrome_flags);if(this.pluggable&&this.pluggable.start_browser)this.browser=await this.pluggable.start_browser({config:this.config}),this.page=await this.browser.newPage();else{let i;this.config.proxies&&this.config.proxies.length>0?(this.numClusters=Math.min(this.config.proxies.length+(this.config.use_proxies_only?0:1),ai),i=K.clone(this.config.proxies),this.config.use_proxies_only===!1&&i.unshift(null)):(this.numClusters=this.config.puppeteer_cluster_config.maxConcurrency,i=K.times(this.numClusters,null)),this.logger.info(`Using ${this.numClusters} clusters.`);const o=K.map(i,u=>{const p=this.config.random_user_agent?new si({deviceCategory:"desktop"}).toString():this.config.user_agent;let g=r.concat([`--user-agent=${p}`]);return u&&(g=g.concat([`--proxy-server=${u}`])),{headless:this.config.headless,ignoreHTTPSErrors:!0,args:g}});ot("perBrowserOptions=%O",o);const a=oi(ni);this.cluster=await de.launch({puppeteer:a,monitor:this.config.puppeteer_cluster_config.monitor,timeout:this.config.puppeteer_cluster_config.timeout,concurrency:Kr,maxConcurrency:this.numClusters,puppeteerOptions:{perBrowserOptions:o}})}}async login(r={}){if(Object.assign(this.config,r),this.pluggable&&this.pluggable.start_browser)this.scraper=st(this.config.platform,{config:this.config,context:this.context,pluggable:this.pluggable,page:this.page,tmppath:this.tmppath}),await this.scraper.runLogin({page:this.page});else{const i=[];for(let a=0;a<this.numClusters;a++)i.push([]);for(let a=0;a<this.config.keywords.length;a++)i[a%this.numClusters].push(this.config.keywords[a]);ot("chunks=%o",i);const o=[];for(let a=0;a<i.length;a++){const u=K.clone(this.config);u.keywords=i[a];const p=st(this.config.platform,{config:u,context:{},pluggable:this.pluggable}),g=p.runLogin.bind(p);o.push(this.cluster.execute({},g))}await Promise.all(o)}}async searchdata(r={}){if(Object.assign(this.config,r),this.pluggable&&this.pluggable.start_browser){this.scraper=st(this.config.platform,{config:this.config,context:this.context,pluggable:this.pluggable,page:this.page,tmppath:this.tmppath});const i={page:this.page};await this.scraper.workersearchdata(i)}else{const i=[];for(let a=0;a<this.numClusters;a++)i.push([]);for(let a=0;a<this.config.keywords.length;a++)i[a%this.numClusters].push(this.config.keywords[a]);ot("chunks=%o",i);const o=[];for(let a=0;a<i.length;a++){const u=K.clone(this.config);u.keywords=i[a];const p=st(this.config.platform,{config:u,context:{},pluggable:this.pluggable}),g=p.workersearchdata.bind(p);o.push(this.cluster.execute({},g))}await Promise.all(o)}}async quit(){this.pluggable&&this.pluggable.close_browser?await this.pluggable.close_browser():(await this.cluster.idle(),await this.cluster.close())}async downloadPlatomvideo(r){if(!["bilibili"].includes(this.config.platform))throw new Error("download video function not work at platform "+this.config.platform);this.scraper=st(this.config.platform,{config:this.config,context:this.context,pluggable:this.pluggable,page:this.page,tmppath:this.tmppath}),ot("links=%o",r);const o=new zr;this.scraper.attach(o),await this.scraper.downloadvideo(r)}}module.exports={ScrapeManager:mt};const we=require("debug")("index");async function ci(c,r){Object.assign(c,r);var i=new mt(c);await i.start();var o=await i.login(r);return await i.quit(),o}async function ui(c,r){Object.assign(c,r);var i=new mt(c);await i.start(),await i.searchdata(r),await i.quit()}async function li(c,r){Object.assign(c,r);const i=5,o=new yt;if(we("result task id is "+r.resulttaskid),!r.resulttaskid)throw new Error("result_taskid is null");const a=await o.Getscrapyinfolist(r.resulttaskid,i);if(we(a),!a)throw new Error("video link list is null");if(a.length<1)throw new Error("link list is empty");var u=new mt(c);u.downloadPlatomvideo(a)}async function hi(){ct.getInstance().init()}class ye{constructor(){y(this,"db");y(this,"taskrunTable","task_run");const r=ct.getInstance();this.db=r.getdb()}saveTaskrun(r,i,o,a){const u=Ae(),p="INSERT INTO "+this.taskrunTable+" (task_id,taskrun_num,log_path,record_time) VALUES (?,?,?,?)";this.db.run(p,[r,i,o,u],function(g){if(g)throw new Error(g.message+" taskid:"+r.toString()+" recordtime:"+u);this.lastID&&a&&a(this.lastID)})}getTaskidbytaskrunNum(r,i){const o="SELECT task_id FROM "+this.taskrunTable+" WHERE taskrun_num = ?";let a=0;this.db.get(o,[r],(u,p)=>{if(u)throw new Error(u.message);p&&(a=p.task_id,i&&i(a))})}checkTaskrunExist(r,i,o){const a="SELECT task_id FROM "+this.taskrunTable+" WHERE task_id = ? AND taskrun_num = ?";let u=!1;this.db.get(a,[r,i],(p,g)=>{if(p)throw new Error(p.message);g&&(u=!0),o&&o(u)})}}var Rt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Re={},$t={exports:{}};function pi(){throw new Error(`secure random number generation not supported by this browser
use chrome, FireFox or Internet Explorer 11`)}var Mt=Rt.crypto||Rt.msCrypto;Mt&&Mt.getRandomValues?$t.exports=fi:$t.exports=pi;function fi(c,r){if(c>65536)throw new Error("requested too many random bytes");var i=new Rt.Uint8Array(c);c>0&&Mt.getRandomValues(i);var o=new W(i.buffer);return typeof r=="function"?rt.nextTick(function(){r(null,o)}):o}var di=$t.exports,$e={exports:{}};(function(c,r){function i(){this.chars=""}i.prototype.setType=function(o){if(Array.isArray(o))for(var a=0;a<o.length;a++)this.chars+=this.getCharacters(o[a]);else this.chars=this.getCharacters(o)},i.prototype.getCharacters=function(o){var a,u="0123456789",p="abcdefghijklmnopqrstuvwxyz",g=p.toUpperCase(),w="abcdef",m="01",h="01234567";return o==="alphanumeric"?a=u+p+g:o==="numeric"?a=u:o==="alphabetic"?a=p+g:o==="hex"?a=u+w:o==="binary"?a=m:o==="octal"?a=h:a=o,a},i.prototype.removeUnreadable=function(){var o=/[0OIl]/g;this.chars=this.chars.replace(o,"")},i.prototype.setcapitalization=function(o){o==="uppercase"?this.chars=this.chars.toUpperCase():o==="lowercase"&&(this.chars=this.chars.toLowerCase())},i.prototype.removeDuplicates=function(){var o=this.chars.split("");o=[...new Set(o)],this.chars=o.join("")},c.exports=i})($e);var gi=$e.exports,Me=di,wi=gi;function yi(c){for(var r=[],i=0;i<c;i++)r.push(Math.floor(Math.random()*255));return{length:c,readUInt8:function(o){return r[o]}}}function mi(c){try{return Me(c)}catch{return yi(c)}}function Oe(c,r,i,o,a){for(var u=r,p=0;p<c.length&&u.length<o;p++){var g=c.readUInt8(p);g<a&&(u+=i.charAt(g%i.length))}return u}function De(c,r,i,o,a){Me(i,function(u,p){u&&a(u);var g=Oe(p,c,r,i,o);g.length<i?De(g,r,i,o,a):a(null,g)})}Re.generate=function(c,r){var i=new wi,o,a="";typeof c=="object"?(o=typeof c.length=="number"?c.length:32,c.charset?i.setType(c.charset):i.setType("alphanumeric"),c.capitalization&&i.setcapitalization(c.capitalization),c.readable&&i.removeUnreadable(),i.removeDuplicates()):typeof c=="number"?(o=c,i.setType("alphanumeric")):(o=32,i.setType("alphanumeric"));var u=i.chars.length,p=256-256%u;if(!r){for(;a.length<o;){var g=mi(Math.ceil(o*256/p));a=Oe(g,a,i.chars,o,p)}return a}De(a,i.chars,o,p,r)};var xi=Re;const ki=require("path");class qe{createsocialtaskrun(r,i){const o=new ye,a=this.getlogfile(r);return o.checkTaskrunExist(r,i,p=>{if(p)throw new Error("task run number exist")}),o.saveTaskrun(r,i,a,null),{taskId:r,taskRunNum:i,logfile:a}}getlogfile(r){const i=Lr();if(!i)throw new Error("get user home dir error");const o=Pr();return ki.join(i,"social-task-log",o,r.toString()+".log")}gentaskrunNum(r){return r.toString()+":"+xi.generate()}TaskidbytaskrunNum(r,i){new ye().getTaskidbytaskrunNum(r,i)}}class bi{constructor(){y(this,"_httpClient");this._httpClient=new Pt}async getTaskbycampagin(r,i,o){const a=new URLSearchParams({campaiginId:r.toString(),page:i.toString(),size:o.toString()}),u=new ee.URLSearchParams(a),p=await this._httpClient.get("/api/listsotask?"+u).catch(function(g){throw new Error(g.message)});if(!p)throw new Error("remote return social task is null");return p}async getTaskbyid(r){const i=new URLSearchParams({task_id:r.toString()}),o=new ee.URLSearchParams(i),a=await this._httpClient.get("/api/getsocialtaskinfo?"+o).catch(function(u){throw new Error(u.message)});if(!a)throw new Error("remote return social task is null");return a}async getTasktype(){const r=await this._httpClient.get("/api/socialtasktype").catch(function(i){throw new Error(i.message)});if(!r)throw new Error("remote return social task type is null");return r}async getTaglist(){const r=await this._httpClient.get("/api/tag").catch(function(i){throw new Error(i.message)});if(!r)throw new Error("remote return tag is null");return r}async saveSocialTask(r){let i=new FormData;r.id&&i.append("socialtask_id",String(r.id)),i.append("campaign_id",String(r.campaign_id)),i.append("task_name",String(r.task_name)),i.append("type_id",String(r.type_id)),r.tag&&i.append("tags[]",String(r.tag)),r.keywords&&i.append("keywords[]",String(r.keywords));const o=await this._httpClient.post("/api/savesocialtask",i).catch(function(a){throw new Error(a.message)});if(!o)throw new Error("remote return social task type is null");return o}async createsocialtask(r,i){return new qe().createsocialtaskrun(r,i)}async runsocialtask(r,i){var g,w;const o=A.join(__dirname,"utilityCode.js");if(!q.existsSync(o))throw new Error("child js path not exist for the path "+o);const{port1:a,port2:u}=new at.MessageChannelMain,p=at.utilityProcess.fork(A.join(__dirname,"utilityCode.js"),["-a","runtask","-t",r.taskRunNum],{stdio:"pipe",execArgv:["puppeteer-cluster:*"]});console.log(A.join(__dirname,"utilityCode.js")),p.on("spawn",()=>{p.postMessage({message:"hello"},[a])}),(g=p.stdout)==null||g.on("data",m=>{console.log(`Received data chunk ${m}`),i&&i(m.toString())}),(w=p.stderr)==null||w.on("data",m=>{console.log(`Received error chunk ${m}`),i&&i(m.toString())}),p.on("exit",()=>{console.log("child process exited ")}),u.on("message",m=>{console.log("port receive:",m.data),u.postMessage("I receive your messages:")}),u.start(),p.on("message",m=>{console.log("接收到消息了：",m)})}}class Ei{constructor(){y(this,"_httpClient");this._httpClient=new Pt}async getKeywordsbytag(r){let i=new FormData;i.append("tags[]",String(r));const o=await this._httpClient.post("/api/getkeywordtag",i).catch(function(a){throw new Error(a.message)}).then(function(a){return a});if(!o)throw new Error("remote return social task type is null");return o.data}}const{ArgumentParser:_i}=require("argparse"),me=require("fs"),Bi=require("path").resolve,Si=require("debug")("runcli"),ut=new _i({description:"Social martketing"});ut.add_argument("-a","--action",{help:"Tha action you want to the program to take"});ut.add_argument("-c","--campaign",{help:"Tha campaign id you want to program to take"});ut.add_argument("-t","--taskrunnum",{help:"Tha task run number you want to program to take"});ut.add_argument("-head","--headless",{help:"Tha task run number you want to program to take"});let Pe=ut.parse_args(),Ot={user_agent:"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36",random_user_agent:!1,headless:!1,debug_level:1,chrome_flags:[],custom_func:"",proxy:"",proxy_file:"",use_cluster:!1,puppeteer_cluster_config:{timeout:10*60*1e3,monitor:!1,concurrency:1,maxConcurrency:1}},T={output_file:"/tmp/test/test.json",block_assets:!1,test_evasion:!1,apply_evasion_techniques:!0,log_ip_address:!1,log_http_headers:!1,platform:"facebook",tmppath:"",taskid:0};function Dt(c,r,i){var o=c[r];return typeof o<"u"?o:i}async function Ii(c){let r=Dt(c,"action",!1);switch(r||console.log("no parameter action been passed"),r){case"login":Ti();break;case"runtask":const i=Dt(c,"taskrunnum",!1);if(!i)throw new Error("task id is empty");vi(i);break;case"sqlinit":hi();break}}async function vi(c){await new qe().TaskidbytaskrunNum(c,async i=>{if(console.log(i),!i)throw new Error("get taskid from db error");const a=await new bi().getTaskbyid(i);if(!a)throw new Error("taskInfo is undefined");if(console.log(a),!a.status)throw new Error(a.msg);if(!a.data)throw new Error("social task data empty");const u=a.data;switch(u.type_name){case"bilibiliscrape":if(T.platform="bilibili",T.taskid=u.id,u.keywords)T.keywords=u.keywords;else{const p=u.tag;if(p){const w=await new Ei().getKeywordsbytag(p);if(w)T.keywords=w;else throw new Error("get keyword by tag failure, keywordarr is undefined")}else throw new Error("both keyword and tag is undefined")}if(!T.keywords)throw new Error("can not get keywords,keywords is undefined");await ui(Ot,T);break;case"bilibilidownload":T.platform="bilibili",T.taskid=u.id,await li(Ot,T);break}})}async function Ti(){let c=Dt(Pe,"campaign",!1);var r=new yt;let i=await r.getRemoteConfig(c);if(Si(i),i==null||!i)throw new Error("sosetting is undefined");T.platform=i.sotype,T.user=i.socialuser,T.pass=i.socialpass,console.log(i);const o=Bi("./tmp/"+T.platform+"/"+i.socialuser);await Fi(o),T.tmppath=o,await ci(Ot,T)}function Fi(c){c.split("/").reduce((r,i)=>(r+=`${i}/`,me.existsSync(r)||me.mkdirSync(r),r),"")}Ii(Pe);
//# sourceMappingURL=utilityCode.js.map
