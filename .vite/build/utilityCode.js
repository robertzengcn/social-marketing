"use strict";var Ot=Object.defineProperty;var $t=(o,t,e)=>t in o?Ot(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var c=(o,t,e)=>($t(o,typeof t!="symbol"?t+"":t,e),e);const S=require("electron"),T=require("crypto"),Mt=require("path"),Dt=require("fs"),A=require("node:child_process"),Pt=require("sqlite3"),K=require("url");function pt(o){const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(o){for(const e in o)if(e!=="default"){const s=Object.getOwnPropertyDescriptor(o,e);Object.defineProperty(t,e,s.get?s:{enumerable:!0,get:()=>o[e]})}}return t.default=o,Object.freeze(t)}const g=pt(Mt),f=pt(Dt),gt=require("cheerio");async function At(o){await o.goto("https://ipinfo.io/json",{waitLoad:!0,waitNetworkIdle:!0});const t=await o.content({timeout:2e4}),s=gt.load(t)("pre").text();return JSON.parse(s)}async function It(o){await o.goto("https://httpbin.org/get",{waitLoad:!0,waitNetworkIdle:!0});const t=await o.content(),s=gt.load(t)("pre").text();return JSON.parse(s)}class Y{constructor(){c(this,"algorithm","aes-256-cbc");c(this,"key");c(this,"iv",T.randomBytes(16));this.algorithm="aes-256-cbc";const t="Tus7uAT6r3eSj9gVbF7Wic3ipNczYNK1";this.key=Buffer.from(t),this.iv=T.randomBytes(16)}encrypt(t){let e=T.createCipheriv(this.algorithm,this.key,this.iv),s=e.update(t);return s=Buffer.concat([s,e.final()]),{iv:this.iv.toString("hex"),encryptedData:s.toString("hex")}}decrypt(t){let e=Buffer.from(t.iv,"hex"),s=Buffer.from(t.encryptedData,"hex"),r=T.createDecipheriv(this.algorithm,Buffer.from(this.key),e),i=r.update(s);return i=Buffer.concat([i,r.final()]),i.toString()}}const Q=require("keytar");class Ut{constructor(t){c(this,"service");this.service=t}setPassword(t,e){Q.setPassword(this.service,t,e)}async getPassword(t){return await Q.getPassword(this.service,t)}}class R{constructor(){c(this,"store");c(this,"useSafestore");this.store=new Ut("social-market-token"),this.useSafestore=!1}setValue(t,e){if(this.useSafestore){const s=S.safeStorage.encryptString(e);this.store.setPassword(t,s.toString())}else{const r=new Y().encrypt(e);this.store.setPassword(t,JSON.stringify(r))}}async getValue(t){const e=await this.store.getPassword(t);return e?this.useSafestore?S.safeStorage.decryptString(Buffer.from(e)):new Y().decrypt(JSON.parse(e)):""}checkEncryavaile(t){return S.safeStorage.isEncryptionAvailable()}}class J{constructor(){c(this,"_headers",{});c(this,"baseUrl");this.baseUrl="http://localhost:8082"}async setheaderToken(){const e=await new R().getValue("social-market-token");console.log("prepare to set token:"+e),e&&this.setHeader("Authorization","Bearer "+e)}async _fetchJSON(t,e){await this.setheaderToken();const s=await fetch(this.baseUrl+t,{...e,headers:this._headers});if(!s.ok)throw new Error(s.statusText);const r=await s.json();return console.log(r),r}setHeader(t,e){return this._headers[t]=e,this}getHeader(t){return this._headers[t]}setBasicAuth(t,e){return this._headers.Authorization=`Basic ${btoa(`${t}:${e}`)}`,this}setBearerAuth(t){return this._headers.Authorization=`Bearer ${t}`,this}async get(t,e={}){return console.log(this._headers),this._fetchJSON(t,{...e,method:"GET"})}async post(t,e,s={}){return this._fetchJSON(t,{...s,body:e,method:"POST"})}async put(t,e){return this._fetchJSON(t,{body:e?JSON.stringify(e):void 0,method:"PUT"})}async patch(t,e,s={}){return this._fetchJSON(t,{...s,body:JSON.stringify(e),method:"PATCH"})}async delete(t,e={}){return this._fetchJSON(t,{...e,method:"DELETE"})}}function L(o){this.message=o}L.prototype=new Error,L.prototype.name="InvalidCharacterError";var X=typeof window<"u"&&window.atob&&window.atob.bind(window)||function(o){var t=String(o).replace(/=+$/,"");if(t.length%4==1)throw new L("'atob' failed: The string to be decoded is not correctly encoded.");for(var e,s,r=0,i=0,a="";s=t.charAt(i++);~s&&(e=r%4?64*e+s:s,r++%4)?a+=String.fromCharCode(255&e>>(-2*r&6)):0)s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(s);return a};function Nt(o){var t=o.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}try{return function(e){return decodeURIComponent(X(e).replace(/(.)/g,function(s,r){var i=r.charCodeAt(0).toString(16).toUpperCase();return i.length<2&&(i="0"+i),"%"+i}))}(t)}catch{return X(t)}}function q(o){this.message=o}function Rt(o,t){if(typeof o!="string")throw new q("Invalid token specified");var e=(t=t||{}).header===!0?0:1;try{return JSON.parse(Nt(o.split(".")[e]))}catch(s){throw new q("Invalid token specified: "+s.message)}}q.prototype=new Error,q.prototype.name="InvalidTokenError";const Z=require("debug")("RemoteSource");class O{constructor(){c(this,"tokenname","social-market-token");c(this,"REMOTEADD");c(this,"_httpClient");this._httpClient=new J}readConfig(){const t=require("dotenv").config();if(t.error)throw t.error;return t.parsed}async getRemoteConfig(t){return this._httpClient.get("/api/getsobyCam/?campaign_id="+t).then(function(s){if(s.status!=200)throw new Error("code not equal 200");if(!s.data.status)throw new Error("code not equal 200");return{sotype:s.data.data.sotype,socialuser:s.data.data.user,socialpass:s.data.data.pass,proxy:{proxy:s.data.data.proxy.url,user:s.data.data.proxy.user,pass:s.data.data.proxy.pass}}}).catch(function(s){console.error(s)})}async saveLinkremote(t){const e=require("form-data");Z(t);const s=new e;return s.append("title",t.title),t.content&&s.append("content",t.content),s.append("url",t.url),s.append("lang",t.lang),t.socialtask_id&&s.append("socialtask_id",t.socialtask_id),this._httpClient.post("/api/savesolink",s).then(function(i){return i.data.data}).catch(function(i){throw new Error(i.message)})}async Getscrapyinfolist(t,e){return this._httpClient.get("/api/getscrapeinfolist?sotaskid="+t+"&limit="+e).then(function(r){return Z(r),r.data.data?r.data.data:null}).catch(function(r){throw new Error(r.message)})}async Gettaskinfo(t){return this._httpClient.get("/api/getsocialtaskinfo?task_id="+t).then(function(s){return s.data.data}).catch(function(s){throw new Error(s.message)})}async Gettaskkeywords(t){return this._httpClient.get("/api/taskkeyword?task_id="+t).then(function(s){const r=[],i=s.data.data;for(const a in i)r.push(i[a].keyword);return r}).catch(function(s){throw new Error(s.message)})}async Updateprocesstime(t){const e=require("form-data"),s=new e;s.append("id",t),await this._httpClient.post("/api/updatescrapeprotime",s).then(function(r){}).catch(function(r){throw new Error(r.message)})}async Login(t,e){var s=new FormData;s.append("username",t),s.append("password",e),console.log(Array.from(s));const r=this;return await this._httpClient.post("/user/login",s).then(function(a){if(!a.status)throw new Error(a.msg);const n=r.ValidateToken(a.data.Token);return n.account_id>0&&new R().setValue(r.tokenname,a.data.Token),n}).catch(function(a){throw new Error(a.message)})}async GetUserInfo(){const e=await new R().getValue(this.tokenname);return e==null||e.length<1?null:(console.log("token is:"+e),await this._httpClient.get("/api/user/info").then(function(r){if(r.status==!1)throw new Error(r.msg);return r.data}).catch(function(r){throw new Error(r.message)}))}ValidateToken(t){const e=Rt(t);return{account_id:e.AccountId,email:e.Email,roles:e.Roles?e.Roles:[]}}}const C=require("debug")("se-scraper:Scraper"),Lt=require("app-root-path"),tt=require("fs");class z{constructor(t){c(this,"config");c(this,"page");c(this,"last_response");c(this,"metadata");c(this,"pluggable");c(this,"context");c(this,"logger");c(this,"proxy");c(this,"keywords");c(this,"STANDARD_TIMEOUT");c(this,"SOLVE_CAPTCHA_TIME");c(this,"results");c(this,"result_rank");c(this,"num_requests");c(this,"num_keywords");c(this,"taskid");c(this,"observers",[]);t.page&&(this.page=t.page),this.last_response=null,this.metadata={scraping_detected:!1},this.pluggable=t.pluggable,this.config=t.config,this.logger=this.config.logger,this.context=t.context,t.config.proxy&&(this.proxy=t.config.proxy),t.config.keywords&&(this.keywords=t.config.keywords),t.taskid&&(this.taskid=t.taskid),this.STANDARD_TIMEOUT=1e4,this.SOLVE_CAPTCHA_TIME=45e3,this.results={},this.result_rank=1,this.num_requests=0,this.num_keywords=0;let e=this.config[`${this.config.search_engine}_settings`];e&&typeof e=="string"&&(e=JSON.parse(e),this.config[`${this.config.search_engine}_settings`]=e)}attach(t){if(this.observers.includes(t))return console.log("Subject: Observer has been attached already.");console.log("Subject: Attached an observer."),this.observers.push(t)}detach(t){const e=this.observers.indexOf(t);if(e===-1)return console.log("Subject: Nonexistent observer.");this.observers.splice(e,1),console.log("Subject: Detached an observer.")}notify(t,e){console.log("Subject: Notifying observers...");for(const s of this.observers)s.update(t,e)}async runLogin(t){var e;C("worker=%o",t.worker,this.config.keywords),t.page&&(this.page=t.page),await((e=this.page)==null?void 0:e.setViewport({width:1280,height:800})),await this.load_browser_engine(),await this.makeloginaction()}async load_browser_engine(){var t,e,s;if(this.config.apply_evasion_techniques===!0&&await Bt(this.page),this.config.block_assets===!0&&(await this.page.setRequestInterception(!0),this.page.on("request",r=>{const i=r.resourceType();["stylesheet","font","image","media"].includes(i)?r.abort():r.continue()})),this.config.test_evasion===!0){const r="https://bot.sannysoft.com";await this.page.goto(r),await this.page.screenshot({path:"headless-evasion-result.png"})}if(this.config.log_http_headers===!0&&(this.metadata.http_headers=await It(this.page)),this.config.log_ip_address===!0){const r=await At(this.page);this.metadata.ipinfo=r}if(this.proxy&&this.config.log_ip_address===!0){if(C(`${(t=this.metadata.ipinfo)==null?void 0:t.ip} vs ${this.proxy}`),(e=this.metadata.ipinfo)!=null&&e.ip&&!this.proxy.includes((s=this.metadata.ipinfo)==null?void 0:s.ip))throw new Error(`Proxy output ip ${this.proxy} does not match with provided one`);this.logger.info(`Using valid Proxy: ${this.proxy}`)}return await this.load_start_page()}async load_login_page(){}async load_start_page(){}async makeloginaction(){}async userloginaction(){}async searchdata(t){}async workersearchdata(t){if(t.worker&&C("worker=%o",t.worker,this.config.keywords),t.page&&(this.page=t.page),await this.page.setViewport({width:1280,height:800}),await this.load_browser_engine(),!this.config.keywords){console.error("keyword is empty");return}const e=await this.searchdata({keyword:this.config.keywords}),s=new O;e==null||e.map(async r=>{const i={title:r.title,url:r.link,lang:r.lang,socialtask_id:r.taskid};try{await s.saveLinkremote(i)}catch(a){console.error(a)}})}async downloadvideo(t){const e=new Date,s=e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate(),r=g.resolve(Lt+"/tmp/video/"+s+"/");tt.existsSync(r)||tt.mkdirSync(r,{recursive:!0}),t.forEach(async(i,a)=>{C(i);const n=await this.downloadSigleVideo(i.url,r);if(n)for(let l=0;l<n.length;l++){const h={video:{url:i.url,localpath:n[l],title:i.title,description:i.content,language:i.lang},scrapeinfo:i};this.notify("downloadvideoend",h)}})}async downloadSigleVideo(t,e){}}async function Bt(o){await o.evaluateOnNewDocument(()=>{const t=Object.getPrototypeOf(navigator);delete t.webdriver,Object.setPrototypeOf(navigator,t)}),await o.evaluateOnNewDocument(()=>{}),await o.evaluateOnNewDocument(()=>{Object.defineProperty(navigator,"plugins",{get:()=>[1,2,3,4,5]})}),await o.evaluateOnNewDocument(()=>{Object.defineProperty(navigator,"languages",{get:()=>["en-US","en"]})}),await o.evaluateOnNewDocument(()=>{Object.defineProperty(HTMLIFrameElement.prototype,"contentWindow",{get:function(){return window}})}),await o.evaluateOnNewDocument(()=>{window.console.debug=()=>null})}class Vt extends z{constructor(t){super(t)}async load_login_page(){const t="https://www.facebook.com";this.logger.info("Using loginUrl: "+t),this.last_response=await this.page.goto(t)}async userloginaction(){}}const jt=require("fs");class ft extends z{constructor(t){super(t)}async load_login_page(){const t="https://www.youtube.com";this.logger.info("Using loginUrl: "+t),await this.page.setBypassCSP(!0),this.last_response=await this.page.goto(t),await this.page.evaluate(()=>{const s=document.getElementById("logo-icon");s&&(s.style.display="none")}),console.log(this.config.tmppath),await this.page.waitForSelector("#avatar-btn",{timeout:0});const e=await this.page.cookies();await jt.writeFile(this.config.tmppath+"/cookies.json",JSON.stringify(e,null,2))}}module.exports={YoutubeScraper:ft};const et=require("fs"),st=require("crypto"),Ft=require("http"),Ht=require("https"),Wt=require("progress-stream"),I=require("node-fetch"),Jt=require("debug")("bilibili-download"),zt=Jt("app:error");class wt{constructor(t){c(this,"url");c(this,"finished");this.url=t,this.finished=!1}}class mt{constructor(){c(this,"type");c(this,"id");c(this,"url");c(this,"aid");c(this,"pid");c(this,"cid");c(this,"name");c(this,"links");c(this,"tasks");this.type="",this.id="",this.url="",this.aid=-1,this.pid=1,this.cid=-1,this.name="",this.links=[],this.tasks=[]}getVideoUrl(t){if(!t)throw new Error("video url is empty");this.url="";const e={BV:"https://www.bilibili.com/video/",bv:"https://www.bilibili.com/video/",av:"https://www.bilibili.com/video/",ep:"https://www.bilibili.com/bangumi/play/",ss:"https://www.bilibili.com/bangumi/play/"};for(const[s,r]of Object.entries(e))if(t.includes(s)){this.type=s,this.id=s+t.split(s)[1],this.url=r+this.id;break}}async getAid(){const{type:t,url:e}=this;if(e)return I(e).then(s=>s.text()).then(s=>{const r=s.match(/__INITIAL_STATE__=(.*?);\(function\(\)/)[1],i=JSON.parse(r);t==="BV"||t==="bv"||t==="av"?(this.aid=i.videoData.aid,this.pid=parseInt(e.split("p=")[1],10)||1,this.cid=i.videoData.pages[this.pid-1].cid):t==="ep"?(this.aid=i.epInfo.aid,this.cid=i.epInfo.cid):t==="ss"&&(this.aid=i.epList[0].aid,this.cid=i.epList[0].cid)}).catch(function(s){throw new Error("get video aid error")})}async getInfo(){const{aid:t,cid:e}=this;if(!e)throw new Error("get video cid error");return I("https://api.bilibili.com/x/web-interface/view?aid="+t).then(s=>s.json()).catch(function(s){throw new Error("get video info error")})}async getData(t=!1){const{cid:e,type:s}=this;let r;if(t){const i=`cid=${e}&module=movie&player=1&quality=112&ts=1`,a=st.createHash("md5").update(i+"9b288147e5474dd2aa67085f716c560d").digest("hex");r=`https://bangumi.bilibili.com/player/web_api/playurl?${i}&sign=${a}`}else if(s==="BV"||s==="bv"||s==="av"){const i=`appkey=iVGUTjsxvpLeuDCf&cid=${e}&otype=json&qn=112&quality=112&type=`,a=st.createHash("md5").update(i+"aHRmhWMLkdeMuILqORnYZocwMBpMEOdt").digest("hex");r=`https://interface.bilibili.com/v2/playurl?${i}&sign=${a}`}else r=`https://api.bilibili.com/pgc/player/web/playurl?qn=80&cid=${e}`;return I(r).then(i=>i.text()).then(i=>{const a=t?this.parseData(i):JSON.parse(i),n=a.durl||a.result.durl;if(n)return this.links=n.map(l=>l.url),{fallback:t,data:a};if(t)throw Error();return this.getData(!0)}).catch(function(i){throw new Error("get playUrl or download link error")})}parseData(t){const e=$(t),s={durl:[],quality:""};return s.durl=[],s.quality=e.find("quality").text(),e.find("durl").each((r,i)=>{const a=$(i);s.durl.push({url:a.find("url").text(),order:a.find("order").text(),length:a.find("length").text(),size:a.find("size").text()})}),s}downloadByIndex(t,e,s=(r,i)=>{}){const{url:r}=this;if(this.tasks.some(l=>l.url===this.links[t]))return"DUPLICATE";this.tasks.push(new wt(this.links[t]));let i;try{i=et.statSync(e)}catch{}const a={url:this.links[t],headers:{Range:`bytes=${i?i.size:0}-`,"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.212 Safari/537.36",Referer:r}},n=et.createWriteStream(e,i?{flags:"a"}:{});return this.download(a,n,s),i}download(t,e,s){const r=this.tasks.findIndex(l=>l.url===t.url),i=Wt({time:250}).on("progress",l=>{const{percentage:u}=l;u===100&&(this.tasks[r].finished=!0),s(l,r)}),{url:a}=t;function n(l){(l.startsWith("https")?Ht:Ft).get(l,t,u=>{if(u.statusCode===302)return l=u.headers.location,n(l);i.setLength(u.headers["content-length"]),u.pipe(i).pipe(e).on("error",h=>{zt(h)})})}n(a)}}module.exports={Task:wt,Downloader:mt};const yt=require("path");async function Gt(o){await o.evaluate(async()=>{await new Promise(t=>{let e=0;const s=100;var r=setInterval(()=>{const i=document.body.scrollHeight;window.scrollBy(0,s),e+=s,e>=i-window.innerHeight&&(clearInterval(r),t(void 0))},100)})})}function kt(){const o=new Date;return o.getFullYear().toString()+"-"+w(o.getMonth()+1)+"-"+w(o.getDate())+" "+w(o.getHours())+":"+w(o.getMinutes())+":"+w(o.getSeconds())}function w(o){return o<10?"0"+o.toString():o.toString()}function Kt(){const o=new Date;return o.getFullYear().toString()+"-"+w(o.getMonth()+1)+"-"+w(o.getDate())+" "+w(o.getHours())+":"+w(o.getMinutes())+":"+w(o.getSeconds())}function Yt(){switch(process.platform){case"darwin":return yt.join(process.env.HOME,"Library","Application Support");case"win32":return process.env.APPDATA;case"linux":return process.env.HOME}}function Qt(){if(!Yt())return;const t="social-marketing";return yt.join(process.env.HOME,t,"log")}require("cheerio");const U=require("fs"),Xt=require("path"),Zt=require("filenamify"),p=require("debug")("bilibili-scraper"),te=p("app:error");class bt extends z{constructor(e){super(e);c(this,"startUrl");this.startUrl="https://www.bilibili.com"}async load_start_page(){p("load start page")}async makeloginaction(){this.logger.info("Using loginUrl: "+this.startUrl),await this.page.setBypassCSP(!0),this.last_response=await this.page.goto(this.startUrl),p("login success, cookies has been save at "+this.config.tmppath),await this.page.click(".header-login-entry"),await this.page.waitForSelector(".bili-mini-content-wp",{timeout:this.STANDARD_TIMEOUT});const e=await this.page.$("//div[contains(., ' 短信登录 ')]");e&&await e.click(),await this.page.waitForSelector(".header-entry-mini",{timeout:0});const s=await this.page.cookies();return await U.writeFile(this.config.tmppath+"/cookies.json",JSON.stringify(s,null,2),r=>{r&&te(r)}),await this.page.close(),!0}async clickSearchbtn(e){e.page&&(this.page=e.page),this.logger.info("Using loginUrl: "+this.startUrl),await this.page.setBypassCSP(!0),this.last_response=await this.page.goto(this.startUrl),await this.page.type(".nav-search-input",e.keyword);const s=await this.page.$(".nav-search-btn");return s&&await s.click(),s}async searchdata(e){e.page&&(this.page=e.page);const s=[];if(Array.isArray(e.keyword))for(const r of e.keyword){const i={page:this.page,keyword:r},a=await this.getVideourls(i);if(a)for(const n of a)s.push(n)}else if(typeof e.keyword=="string"){const r={page:this.page,keyword:e.keyword},i=await this.getVideourls(r);if(i)for(const a of i)s.push(i)}return s}async getVideourls(e){if(e.page&&(this.page=e.page),e.cookiesPath){if(!U.existsSync(e.cookiesPath))throw new Error(`Cannot find cookies file at ${e.cookiesPath}`);const s=JSON.parse(await U.promises.readFile(e.cookiesPath));await this.page.setCookie(...s)}if(typeof e.keyword=="string")return await this.handleSearch({page:this.page,keyword:e.keyword});{const s=[];for(const r of e.keyword){const i=await this.handleSearch({page:this.page,keyword:r});if(i)for(const a of i)s.push(a)}return s}}async handleSearch(e){await this.clickSearchbtn({page:this.page,keyword:e.keyword});const s=this.page.browser();await s.waitForTarget(l=>l.url().includes("search.bilibili.com"));const r=await s.pages();let i;for(const l of r)if((await l.url()).includes("search.bilibili.com")){i=l;break}if(!i)throw new Error("search page not found");await Gt(i);try{await i.waitForSelector(".vui_pagenation",{timeout:5e3})}catch{return p("not find .vui_pagenation item, the page may not have result"),new Promise(u=>{u(null)})}const a=[],n=await i.$$("button.vui_button");p(n);for(let l=0;l<n.length;l++){await i.evaluate(h=>{h.click()},n[l]);const u=await this.getVideolistlink({page:i});p(u),u.map(h=>{a.push(h)})}return a}async getVideolistlink({page:e}){e&&(this.page=e);let s=[];p(this.config.taskid);let r=0;return this.config.taskid&&(r=this.config.taskid),s=await this.page.$$eval(".bili-video-card__info--right >a:first-child",(i,a)=>i.map(n=>{const l={title:"",link:"",lang:"zh-cn"};a&&(l.taskid=a);const u=n.getAttribute("href");u&&(l.link=u);const h=n.querySelector("h3");if(h){const b=h.getAttribute("title");b&&(l.title=b)}return l}),r),await s.forEach((i,a)=>{i.link.includes("/video/")||s.splice(a,1)}),await s.forEach((i,a)=>{i.link.includes("/api/")&&(p("element has api "+i),s.splice(a,1))}),p(s),s}async downloadSigleVideo(e,s){if(!e)throw p(e),new Error("link is empty");const r=new mt;if(r.getVideoUrl(e),!r.url)throw new Error("video url invalid");await r.getAid();const i=await r.getInfo();p("VIDEO INFO",i);const a=Math.random().toString(20).slice(2),{data:n,fallback:l}=await r.getData(),u=n.durl||n.result.durl,h=n.quality||n.result.quality,qt={112:"1080P+",80:"1080P",74:"720P60",64:"720P",48:"720P",32:"480P",16:"360P",15:"360P"}[h]||"unknown";if(p("videoQuantity is "+qt),l)throw new Error("error happen when get video data");const G=[];return u.forEach((Be,D)=>{const P=Xt.join(s,`${Zt(a)}-${D}.flv`);p("part is %o",D),p("file name %o",P),r.downloadByIndex(D,P,(Ve,je)=>{}),G.push(P)}),G}async getVideodetail(e,s){e&&(this.page=e),await this.page.goto(s,{waitUntil:"domcontentloaded"})}}module.exports={BilibiliScraper:bt};const m=require("debug")("videoedit");class ee{async removeWatermark(t,e,s,r){if(!f.existsSync(t))throw new Error("video path not exist for the path "+t);const i=g.dirname(e);f.existsSync(i)||f.mkdirSync(i,{recursive:!0});const a=await A.spawn("Marketingtool",["--action","removeWatermark","-f",t,"-o",e]);a.stdout.on("data",n=>{m(`stdout: ${n}`)}),a.stderr.on("data",n=>{m(`stderr: ${n}`)}),a.on("close",n=>{if(m(`watermark remove child process exited with code ${n}`),r&&n==0)m("run callback"),r(s,e);else{const l="_convert";if(t.includes(l))return;{m("start convert video");const u=g.dirname(t)+g.sep+g.parse(t).name+l+".mp4";this.convertvideo(t,u,()=>this.removeWatermark(u,e,s,r))}}})}async getVideocaptions(t,e,s,r){if(!f.existsSync(t))throw new Error("video path not exist");await A.spawn("Marketingtool",["--action","translate","-f",t,"--source-lang",s,"--target-lang",r])}async convertvideo(t,e,s){if(!f.existsSync(t))throw new Error("video path not exist");(await A.spawn("Marketingtool",["--action","convertvideo","-f",t,"-o",e])).on("close",i=>{m(`convert video child process exited with code ${i}`),i!=1&&m("convert command failure: Marketingtool --action convertvideo -f "+t+" -o "+e)})}}const se=require("debug")("scraperdb"),rt=require("app-root-path"),k=class k{constructor(){c(this,"dbname");c(this,"db");c(this,"pathdb");const t=g.resolve(rt+"/tmp/db/");f.existsSync(t)||f.mkdirSync(t,{recursive:!0}),this.dbname="scraper.db",this.pathdb=t+"/"+this.dbname,this.db=new Pt.Database(this.pathdb,e=>{if(e)throw new Error("Getting error "+e)})}static getInstance(){return k.instance||(k.instance=new k),k.instance}init(){this.createTables()}getdb(){return this.db}createTables(){const t=g.resolve(rt+"/src/sql/scraperdb/");f.readdir(t,(e,s)=>{se(s),s.forEach(r=>{this.db.exec(f.readFileSync(t+g.sep+r).toString())})})}};c(k,"instance");let x=k;class it{constructor(){c(this,"db");c(this,"videoTable","video");c(this,"videoDescriptionTable","video_description");c(this,"language",[{id:1,name:"en-us"},{id:2,name:"zh-cn"}]);const t=x.getInstance();this.db=t.getdb()}saveVideo(t,e){let s=0;for(let n=0;n<this.language.length;n++)this.language[n].name==t.language&&(s=this.language[n].id);const r=kt(),i="INSERT INTO "+this.videoTable+" (url,localpath,record_time) VALUES (?,?,?)",a=this;this.db.run(i,[t.url,t.localpath,r],function(n){if(n)throw new Error(n.message+" url:"+t.url+" recordtime:"+r);if(this.lastID){const l="INSERT INTO "+a.videoDescriptionTable+" (video_id,language_id,title,description) VALUES (?,?,?,?)";a.db.run(l,[this.lastID,s,t.title,t.description],function(u){if(u)throw new Error(u.message)}),e&&e(this.lastID)}})}updateVideofilter(t,e){const s="UPDATE "+this.videoTable+" SET filterwatermark = ? WHERE id = ?";this.db.run(s,[e,t],function(r){if(r)throw new Error(r.message)})}truncatedb(){const t="DELETE FROM "+this.videoTable;this.db.run(t,[],function(s){if(s)throw new Error(s.message)});const e="DELETE FROM "+this.videoDescriptionTable;this.db.run(e,[],function(s){if(s)throw new Error(s.message)})}}const ot=require("debug")("Observer:videodownloadObserver"),re=require("app-root-path");class ie{constructor(){}update(t,e){switch(t){case"downloadvideoend":this.videodownloadend(e);break}}videodownloadend(t){ot(t);const e=new it,s=new ee,i=g.resolve(re+"/tmp/video/filterwater/")+g.sep+Math.random().toString(16).slice(2)+".mp4";e.saveVideo(t.video,n=>s.removeWatermark(t.video.localpath,i,n,function(u,h){const b=new it;ot("start to update video filter, the insert id is "+u+" the output path is "+h),b.updateVideofilter(u,h)}));const a=new O;t.scrapeinfo.id&&a.Updateprocesstime(t.scrapeinfo.id)}}const{Browser:oe}=require("puppeteer-cluster/dist/concurrency/builtInConcurrency"),N=require("debug")("se-scraper:CustomConcurrency"),{timeoutExecute:at}=require("puppeteer-cluster/dist/util"),nt=5e3;class ae extends oe{async init(){}async close(){}async workerInstance(){const t=this.options.perBrowserOptions.shift();N("Launch puppeteer instance with options=%o",t);let e=await this.puppeteer.launch(t),s,r;return{jobInstance:async()=>(await at(nt,(async()=>{r=await e.createIncognitoBrowserContext(),s=await r.newPage()})()),{resources:{page:s},close:async()=>{await at(nt,r.close())}}),close:async()=>{await e.close()},repair:async()=>{N("Starting repair");try{await e.close()}catch(i){N("Failed to close chrome: %o",i)}e=await this.puppeteer.launch(t)}}}}const B=require("fs"),ne=require("os"),y=require("lodash"),{createLogger:ce,format:le,transports:ue}=require("winston"),{combine:he,timestamp:de,printf:pe}=le,v=require("debug")("se-scraper:ScrapeManager"),{Cluster:ct}=require("puppeteer-cluster"),ge=require("puppeteer"),{addExtra:fe}=require("puppeteer-extra"),we=require("user-agents"),me=6;function lt(o){let t=B.readFileSync(o).toString().split(ne.EOL);return t=t.filter(e=>e.trim().length>0),t}function _(o,t){if(typeof o=="string")return new{facebook:Vt,youtube:ft,bilibili:bt}[o](t);throw new Error("social platform must either be a string of class (function)")}class M{constructor(t,e={}){c(this,"cluster");c(this,"pluggable");c(this,"scraper");c(this,"context");c(this,"config");c(this,"logger");c(this,"browser");c(this,"page");c(this,"numClusters");c(this,"tmppath");c(this,"runLogin");if(this.context=e,this.config=y.defaults(t,{user_agent:"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36",random_user_agent:!1,set_manual_settings:!1,log_ip_address:!1,log_http_headers:!1,sleep_range:null,logger:ce({level:"info",format:he(de(),pe(({level:s,message:r,timestamp:i})=>`${i} [${s}] ${r}`)),transports:[new ue.Console]}),platform:"facebook",keywords:["nodejs rocks"],chrome_flags:["--disable-infobars","--window-position=0,0","--ignore-certifcate-errors","--ignore-certifcate-errors-spki-list","--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-accelerated-2d-canvas","--disable-gpu","--window-size=1280,768","--start-fullscreen","--hide-scrollbars","--disable-notifications"],ignoreDefaultArgs:["--enable-automation","--disable-extensions","--disable-default-apps","--disable-component-extensions-with-background-pages"],num_pages:1,output_file:"",html_output:!1,clean_html_output:!0,clean_data_images:!0,screen_output:!1,scrape_from_file:"",block_assets:!0,custom_func:null,throw_on_detection:!1,proxies:null,proxy_file:"",use_proxies_only:!1,test_evasion:!1,apply_evasion_techniques:!0,puppeteer_cluster_config:{timeout:30*60*1e3,monitor:!1,concurrency:ct.CONCURRENCY_BROWSER,maxConcurrency:1}}),this.logger=this.config.logger,t.sleep_range&&t.sleep_range.length!==2)throw"sleep_range is not a valid array of two integers.";if(B.existsSync(this.config.keyword_file)&&(this.config.keywords=lt(this.config.keyword_file)),this.config.proxies&&this.config.proxy_file)throw new Error("Either use a proxy_file or specify a proxy for all connections. Do not use both options.");if(this.config.proxy_file&&(this.config.proxies=lt(this.config.proxy_file),this.logger.info(`${this.config.proxies.length} proxies read from file.`)),!this.config.proxies&&this.config.use_proxies_only)throw new Error("Must provide at least one proxy in proxies if you enable use_proxies_only");v("this.config=%O",this.config)}async start(){if(this.config.custom_func)if(B.existsSync(this.config.custom_func))try{const e=require(this.config.custom_func);this.pluggable=new e({config:this.config,context:this.context})}catch(e){return console.error(e),!1}else return console.error(`File "${this.config.custom_func}" does not exist!`),!1;const t=y.clone(this.config.chrome_flags);if(this.pluggable&&this.pluggable.start_browser)this.browser=await this.pluggable.start_browser({config:this.config}),this.page=await this.browser.newPage();else{let e;this.config.proxies&&this.config.proxies.length>0?(this.numClusters=Math.min(this.config.proxies.length+(this.config.use_proxies_only?0:1),me),e=y.clone(this.config.proxies),this.config.use_proxies_only===!1&&e.unshift(null)):(this.numClusters=this.config.puppeteer_cluster_config.maxConcurrency,e=y.times(this.numClusters,null)),this.logger.info(`Using ${this.numClusters} clusters.`);const s=y.map(e,i=>{const a=this.config.random_user_agent?new we({deviceCategory:"desktop"}).toString():this.config.user_agent;let n=t.concat([`--user-agent=${a}`]);return i&&(n=n.concat([`--proxy-server=${i}`])),{headless:this.config.headless,ignoreHTTPSErrors:!0,args:n}});v("perBrowserOptions=%O",s);const r=fe(ge);this.cluster=await ct.launch({puppeteer:r,monitor:this.config.puppeteer_cluster_config.monitor,timeout:this.config.puppeteer_cluster_config.timeout,concurrency:ae,maxConcurrency:this.numClusters,puppeteerOptions:{perBrowserOptions:s}})}}async login(t={}){if(Object.assign(this.config,t),this.pluggable&&this.pluggable.start_browser)this.scraper=_(this.config.platform,{config:this.config,context:this.context,pluggable:this.pluggable,page:this.page,tmppath:this.tmppath}),await this.scraper.runLogin({page:this.page});else{const e=[];for(let r=0;r<this.numClusters;r++)e.push([]);for(let r=0;r<this.config.keywords.length;r++)e[r%this.numClusters].push(this.config.keywords[r]);v("chunks=%o",e);const s=[];for(let r=0;r<e.length;r++){const i=y.clone(this.config);i.keywords=e[r];const a=_(this.config.platform,{config:i,context:{},pluggable:this.pluggable}),n=a.runLogin.bind(a);s.push(this.cluster.execute({},n))}await Promise.all(s)}}async searchdata(t={}){if(Object.assign(this.config,t),this.pluggable&&this.pluggable.start_browser){this.scraper=_(this.config.platform,{config:this.config,context:this.context,pluggable:this.pluggable,page:this.page,tmppath:this.tmppath});const e={page:this.page};await this.scraper.workersearchdata(e)}else{const e=[];for(let r=0;r<this.numClusters;r++)e.push([]);for(let r=0;r<this.config.keywords.length;r++)e[r%this.numClusters].push(this.config.keywords[r]);v("chunks=%o",e);const s=[];for(let r=0;r<e.length;r++){const i=y.clone(this.config);i.keywords=e[r];const a=_(this.config.platform,{config:i,context:{},pluggable:this.pluggable}),n=a.workersearchdata.bind(a);s.push(this.cluster.execute({},n))}await Promise.all(s)}}async quit(){this.pluggable&&this.pluggable.close_browser?await this.pluggable.close_browser():(await this.cluster.idle(),await this.cluster.close())}async downloadPlatomvideo(t){if(!["bilibili"].includes(this.config.platform))throw new Error("download video function not work at platform "+this.config.platform);this.scraper=_(this.config.platform,{config:this.config,context:this.context,pluggable:this.pluggable,page:this.page,tmppath:this.tmppath}),v("links=%o",t);const s=new ie;this.scraper.attach(s),await this.scraper.downloadvideo(t)}}module.exports={ScrapeManager:M};const ut=require("debug")("index");async function ye(o,t){Object.assign(o,t);var e=new M(o);await e.start();var s=await e.login(t);return await e.quit(),s}async function ke(o,t){Object.assign(o,t);var e=new M(o);await e.start(),await e.searchdata(t),await e.quit()}async function be(o,t){Object.assign(o,t);const e=5,s=new O;if(ut("result task id is "+t.resulttaskid),!t.resulttaskid)throw new Error("result_taskid is null");const r=await s.Getscrapyinfolist(t.resulttaskid,e);if(ut(r),!r)throw new Error("video link list is null");if(r.length<1)throw new Error("link list is empty");var i=new M(o);i.downloadPlatomvideo(r)}async function ve(){x.getInstance().init()}class ht{constructor(){c(this,"db");c(this,"taskrunTable","task_run");const t=x.getInstance();this.db=t.getdb()}saveTaskrun(t,e,s,r){const i=kt(),a="INSERT INTO "+this.taskrunTable+" (task_id,taskrun_num,log_path,record_time) VALUES (?,?,?,?)";this.db.run(a,[t,e,s,i],function(n){if(n)throw new Error(n.message+" taskid:"+t.toString()+" recordtime:"+i);this.lastID&&r&&r(this.lastID)})}getTaskidbytaskrunNum(t,e){const s="SELECT task_id FROM "+this.taskrunTable+" WHERE taskrun_num = ?";let r=0;this.db.get(s,[t],(i,a)=>{if(i)throw new Error(i.message);a&&(r=a.task_id,e&&e(r))})}checkTaskrunExist(t,e,s){const r="SELECT task_id FROM "+this.taskrunTable+" WHERE task_id = ? AND taskrun_num = ?";let i=!1;this.db.get(r,[t,e],(a,n)=>{if(a)throw new Error(a.message);n&&(i=!0),s&&s(i)})}}var V=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},vt={},j={exports:{}};function _e(){throw new Error(`secure random number generation not supported by this browser
use chrome, FireFox or Internet Explorer 11`)}var F=V.crypto||V.msCrypto;F&&F.getRandomValues?j.exports=Se:j.exports=_e;function Se(o,t){if(o>65536)throw new Error("requested too many random bytes");var e=new V.Uint8Array(o);o>0&&F.getRandomValues(e);var s=new Buffer(e.buffer);return typeof t=="function"?process.nextTick(function(){t(null,s)}):s}var xe=j.exports,_t={exports:{}};(function(o,t){function e(){this.chars=""}e.prototype.setType=function(s){if(Array.isArray(s))for(var r=0;r<s.length;r++)this.chars+=this.getCharacters(s[r]);else this.chars=this.getCharacters(s)},e.prototype.getCharacters=function(s){var r,i="0123456789",a="abcdefghijklmnopqrstuvwxyz",n=a.toUpperCase(),l="abcdef",u="01",h="01234567";return s==="alphanumeric"?r=i+a+n:s==="numeric"?r=i:s==="alphabetic"?r=a+n:s==="hex"?r=i+l:s==="binary"?r=u:s==="octal"?r=h:r=s,r},e.prototype.removeUnreadable=function(){var s=/[0OIl]/g;this.chars=this.chars.replace(s,"")},e.prototype.setcapitalization=function(s){s==="uppercase"?this.chars=this.chars.toUpperCase():s==="lowercase"&&(this.chars=this.chars.toLowerCase())},e.prototype.removeDuplicates=function(){var s=this.chars.split("");s=[...new Set(s)],this.chars=s.join("")},o.exports=e})(_t);var Ee=_t.exports,St=xe,Te=Ee;function Ce(o){for(var t=[],e=0;e<o;e++)t.push(Math.floor(Math.random()*255));return{length:o,readUInt8:function(s){return t[s]}}}function qe(o){try{return St(o)}catch{return Ce(o)}}function xt(o,t,e,s,r){for(var i=t,a=0;a<o.length&&i.length<s;a++){var n=o.readUInt8(a);n<r&&(i+=e.charAt(n%e.length))}return i}function Et(o,t,e,s,r){St(e,function(i,a){i&&r(i);var n=xt(a,o,t,e,s);n.length<e?Et(n,t,e,s,r):r(null,n)})}vt.generate=function(o,t){var e=new Te,s,r="";typeof o=="object"?(s=typeof o.length=="number"?o.length:32,o.charset?e.setType(o.charset):e.setType("alphanumeric"),o.capitalization&&e.setcapitalization(o.capitalization),o.readable&&e.removeUnreadable(),e.removeDuplicates()):typeof o=="number"?(s=o,e.setType("alphanumeric")):(s=32,e.setType("alphanumeric"));var i=e.chars.length,a=256-256%i;if(!t){for(;r.length<s;){var n=qe(Math.ceil(s*256/a));r=xt(n,r,e.chars,s,a)}return r}Et(r,e.chars,s,a,t)};var Oe=vt;const $e=require("path");class Tt{createsocialtaskrun(t,e){const s=new ht,r=this.getlogfile(t);return s.checkTaskrunExist(t,e,a=>{if(a)throw new Error("task run number exist")}),s.saveTaskrun(t,e,r,null),{taskId:t,taskRunNum:e,logfile:r}}getlogfile(t){const e=Qt();if(!e)throw new Error("get user home dir error");const s=Kt();return $e.join(e,"social-task-log",s,t.toString()+".log")}gentaskrunNum(t){return t.toString()+":"+Oe.generate()}TaskidbytaskrunNum(t,e){new ht().getTaskidbytaskrunNum(t,e)}}class Me{constructor(){c(this,"_httpClient");this._httpClient=new J}async getTaskbycampagin(t,e,s){const r=new URLSearchParams({campaiginId:t.toString(),page:e.toString(),size:s.toString()}),i=new K.URLSearchParams(r),a=await this._httpClient.get("/api/listsotask?"+i).catch(function(n){throw new Error(n.message)});if(!a)throw new Error("remote return social task is null");return a}async getTaskbyid(t){const e=new URLSearchParams({task_id:t.toString()}),s=new K.URLSearchParams(e),r=await this._httpClient.get("/api/getsocialtaskinfo?"+s).catch(function(i){throw new Error(i.message)});if(!r)throw new Error("remote return social task is null");return r}async getTasktype(){const t=await this._httpClient.get("/api/socialtasktype").catch(function(e){throw new Error(e.message)});if(!t)throw new Error("remote return social task type is null");return t}async getTaglist(){const t=await this._httpClient.get("/api/tag").catch(function(e){throw new Error(e.message)});if(!t)throw new Error("remote return tag is null");return t}async saveSocialTask(t){let e=new FormData;t.id&&e.append("socialtask_id",String(t.id)),e.append("campaign_id",String(t.campaign_id)),e.append("task_name",String(t.task_name)),e.append("type_id",String(t.type_id)),t.tag&&e.append("tags[]",String(t.tag)),t.keywords&&e.append("keywords[]",String(t.keywords));const s=await this._httpClient.post("/api/savesocialtask",e).catch(function(r){throw new Error(r.message)});if(!s)throw new Error("remote return social task type is null");return s}async createsocialtask(t,e){return new Tt().createsocialtaskrun(t,e)}async runsocialtask(t,e){var n,l;const s=g.join(__dirname,"utilityCode.js");if(!f.existsSync(s))throw new Error("child js path not exist for the path "+s);const{port1:r,port2:i}=new S.MessageChannelMain,a=S.utilityProcess.fork(g.join(__dirname,"utilityCode.js"),["-a","runtask","-t",t.taskRunNum],{stdio:"pipe",execArgv:["puppeteer-cluster:*"]});console.log(g.join(__dirname,"utilityCode.js")),a.on("spawn",()=>{a.postMessage({message:"hello"},[r])}),(n=a.stdout)==null||n.on("data",u=>{console.log(`Received data chunk ${u}`),e&&e(u.toString())}),(l=a.stderr)==null||l.on("data",u=>{console.log(`Received error chunk ${u}`),e&&e(u.toString())}),a.on("exit",()=>{console.log("child process exited ")}),i.on("message",u=>{console.log("port receive:",u.data),i.postMessage("I receive your messages:")}),i.start(),a.on("message",u=>{console.log("接收到消息了：",u)})}}class De{constructor(){c(this,"_httpClient");this._httpClient=new J}async getKeywordsbytag(t){let e=new FormData;e.append("tags[]",String(t));const s=await this._httpClient.post("/api/getkeywordtag",e).catch(function(r){throw new Error(r.message)}).then(function(r){return r});if(!s)throw new Error("remote return social task type is null");return s.data}}const{ArgumentParser:Pe}=require("argparse"),dt=require("fs"),Ae=require("path").resolve,Ie=require("debug")("runcli"),E=new Pe({description:"Social martketing"});E.add_argument("-a","--action",{help:"Tha action you want to the program to take"});E.add_argument("-c","--campaign",{help:"Tha campaign id you want to program to take"});E.add_argument("-t","--taskrunnum",{help:"Tha task run number you want to program to take"});E.add_argument("-head","--headless",{help:"Tha task run number you want to program to take"});let Ct=E.parse_args(),H={user_agent:"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36",random_user_agent:!1,headless:!1,debug_level:1,chrome_flags:[],custom_func:"",proxy:"",proxy_file:"",use_cluster:!1,puppeteer_cluster_config:{timeout:10*60*1e3,monitor:!1,concurrency:1,maxConcurrency:1}},d={output_file:"/tmp/test/test.json",block_assets:!1,test_evasion:!1,apply_evasion_techniques:!0,log_ip_address:!1,log_http_headers:!1,platform:"facebook",tmppath:"",taskid:0};function W(o,t,e){var s=o[t];return typeof s<"u"?s:e}async function Ue(o){let t=W(o,"action",!1);switch(t||console.log("no parameter action been passed"),t){case"login":Re();break;case"runtask":const e=W(o,"taskrunnum",!1);if(!e)throw new Error("task id is empty");Ne(e);break;case"sqlinit":ve();break}}async function Ne(o){await new Tt().TaskidbytaskrunNum(o,async e=>{if(console.log(e),!e)throw new Error("get taskid from db error");const r=await new Me().getTaskbyid(e);if(!r)throw new Error("taskInfo is undefined");if(console.log(r),!r.status)throw new Error(r.msg);if(!r.data)throw new Error("social task data empty");const i=r.data;switch(i.type_name){case"bilibiliscrape":if(d.platform="bilibili",d.taskid=i.id,i.keywords)d.keywords=i.keywords;else{const a=i.tag;if(a){const l=await new De().getKeywordsbytag(a);if(l)d.keywords=l;else throw new Error("get keyword by tag failure, keywordarr is undefined")}else throw new Error("both keyword and tag is undefined")}if(!d.keywords)throw new Error("can not get keywords,keywords is undefined");await ke(H,d);break;case"bilibilidownload":d.platform="bilibili",d.taskid=i.id,await be(H,d);break}})}async function Re(){let o=W(Ct,"campaign",!1);var t=new O;let e=await t.getRemoteConfig(o);if(Ie(e),e==null||!e)throw new Error("sosetting is undefined");d.platform=e.sotype,d.user=e.socialuser,d.pass=e.socialpass,console.log(e);const s=Ae("./tmp/"+d.platform+"/"+e.socialuser);await Le(s),d.tmppath=s,await ye(H,d)}function Le(o){o.split("/").reduce((t,e)=>(t+=`${e}/`,dt.existsSync(t)||dt.mkdirSync(t),t),"")}Ue(Ct);
//# sourceMappingURL=utilityCode.js.map
