"use strict";var ar=Object.defineProperty;var cr=(u,r,i)=>r in u?ar(u,r,{enumerable:!0,configurable:!0,writable:!0,value:i}):u[r]=i;var y=(u,r,i)=>(cr(u,typeof r!="symbol"?r+"":r,i),i);const ur=require("sqlite3"),lr=require("fs"),hr=require("path"),ct=require("electron"),pt=require("crypto"),bt=require("node:child_process"),re=require("url");function xe(u){const r=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(u){for(const i in u)if(i!=="default"){const o=Object.getOwnPropertyDescriptor(u,i);Object.defineProperty(r,i,o.get?o:{enumerable:!0,get:()=>u[i]})}}return r.default=u,Object.freeze(r)}const q=xe(lr),C=xe(hr),be=require("cheerio");async function pr(u){await u.goto("https://ipinfo.io/json",{waitLoad:!0,waitNetworkIdle:!0});const r=await u.content({timeout:2e4}),o=be.load(r)("pre").text();return JSON.parse(o)}async function fr(u){await u.goto("https://httpbin.org/get",{waitLoad:!0,waitNetworkIdle:!0});const r=await u.content(),o=be.load(r)("pre").text();return JSON.parse(o)}const dr=require("debug")("scraperdb"),ie=require("app-root-path"),X=class X{constructor(){y(this,"dbname");y(this,"db");y(this,"pathdb");const r=C.resolve(ie+"/tmp/db/");q.existsSync(r)||q.mkdirSync(r,{recursive:!0}),this.dbname="scraper.db",this.pathdb=r+"/"+this.dbname,this.db=new ur.Database(this.pathdb,i=>{if(i)throw new Error("Getting error "+i)})}static getInstance(){return X.instance||(X.instance=new X),X.instance}init(){this.createTables()}getdb(){return this.db}createTables(){const r=C.resolve(ie+"/src/sql/scraperdb/");q.readdir(r,(i,o)=>{dr(o),o.forEach(a=>{this.db.exec(q.readFileSync(r+C.sep+a).toString())})})}};y(X,"instance");let nt=X;function gr(u){return u&&u.__esModule&&Object.prototype.hasOwnProperty.call(u,"default")?u.default:u}var Ee={exports:{}},B=Ee.exports={},O,D;function vt(){throw new Error("setTimeout has not been defined")}function Tt(){throw new Error("clearTimeout has not been defined")}(function(){try{typeof setTimeout=="function"?O=setTimeout:O=vt}catch{O=vt}try{typeof clearTimeout=="function"?D=clearTimeout:D=Tt}catch{D=Tt}})();function _e(u){if(O===setTimeout)return setTimeout(u,0);if((O===vt||!O)&&setTimeout)return O=setTimeout,setTimeout(u,0);try{return O(u,0)}catch{try{return O.call(null,u,0)}catch{return O.call(this,u,0)}}}function wr(u){if(D===clearTimeout)return clearTimeout(u);if((D===Tt||!D)&&clearTimeout)return D=clearTimeout,clearTimeout(u);try{return D(u)}catch{try{return D.call(null,u)}catch{return D.call(this,u)}}}var L=[],it=!1,Q,ft=-1;function yr(){!it||!Q||(it=!1,Q.length?L=Q.concat(L):ft=-1,L.length&&Be())}function Be(){if(!it){var u=_e(yr);it=!0;for(var r=L.length;r;){for(Q=L,L=[];++ft<r;)Q&&Q[ft].run();ft=-1,r=L.length}Q=null,it=!1,wr(u)}}B.nextTick=function(u){var r=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)r[i-1]=arguments[i];L.push(new Ie(u,r)),L.length===1&&!it&&_e(Be)};function Ie(u,r){this.fun=u,this.array=r}Ie.prototype.run=function(){this.fun.apply(null,this.array)};B.title="browser";B.browser=!0;B.env={};B.argv=[];B.version="";B.versions={};function V(){}B.on=V;B.addListener=V;B.once=V;B.off=V;B.removeListener=V;B.removeAllListeners=V;B.emit=V;B.prependListener=V;B.prependOnceListener=V;B.listeners=function(u){return[]};B.binding=function(u){throw new Error("process.binding is not supported")};B.cwd=function(){return"/"};B.chdir=function(u){throw new Error("process.chdir is not supported")};B.umask=function(){return 0};var mr=Ee.exports;const rt=gr(mr),Se=require("path");async function kr(u){await u.evaluate(async()=>{await new Promise(r=>{let i=0;const o=100;var a=setInterval(()=>{const c=document.body.scrollHeight;window.scrollBy(0,o),i+=o,i>=c-window.innerHeight&&(clearInterval(a),r(void 0))},100)})})}function Dt(){const u=new Date;return u.getFullYear().toString()+"-"+N(u.getMonth()+1)+"-"+N(u.getDate())+" "+N(u.getHours())+":"+N(u.getMinutes())+":"+N(u.getSeconds())}function N(u){return u<10?"0"+u.toString():u.toString()}function xr(){const u=new Date;return u.getFullYear().toString()+"-"+N(u.getMonth()+1)+"-"+N(u.getDate())+" "+N(u.getHours())+":"+N(u.getMinutes())+":"+N(u.getSeconds())}function br(){switch(rt.platform){case"darwin":return Se.join(rt.env.HOME,"Library","Application Support");case"win32":return rt.env.APPDATA;case"linux":return rt.env.HOME}}function Er(){if(!br())return;const r="social-marketing";return Se.join(rt.env.HOME,r,"log")}class _r{constructor(){y(this,"db");y(this,"taskresultTable","task_result");const r=nt.getInstance();this.db=r.getdb()}saveTaskresult(r,i){if(!r.taskrunId)throw new Error("task run id empty");const o=Dt(),a="INSERT INTO "+this.taskresultTable+" (taskrun_id,url,title,content,lang,record_time) VALUES (?,?,?,?,?,?)";this.db.run(a,[r.taskrunId,r.url,r.title,r.content,r.lang,o],function(c){if(c)throw new Error(c.message+" taskrunid:"+r.taskrunId.toString()+" recordtime:"+o);this.lastID&&i&&i(this.lastID)})}}const Et=require("debug")("se-scraper:Scraper"),Br=require("app-root-path"),ne=require("fs");class qt{constructor(r){y(this,"config");y(this,"page");y(this,"last_response");y(this,"metadata");y(this,"pluggable");y(this,"context");y(this,"logger");y(this,"proxy");y(this,"keywords");y(this,"STANDARD_TIMEOUT");y(this,"SOLVE_CAPTCHA_TIME");y(this,"results");y(this,"result_rank");y(this,"num_requests");y(this,"num_keywords");y(this,"taskid");y(this,"taskrunid");y(this,"observers",[]);r.page&&(this.page=r.page),this.last_response=null,this.metadata={scraping_detected:!1},this.pluggable=r.pluggable,this.config=r.config,this.logger=this.config.logger,this.context=r.context,r.config.keywords&&(this.keywords=r.config.keywords),r.taskid&&(this.taskid=r.taskid),r.taskrunid&&(this.taskrunid=r.taskrunid),this.STANDARD_TIMEOUT=1e4,this.SOLVE_CAPTCHA_TIME=45e3,this.results={},this.result_rank=1,this.num_requests=0,this.num_keywords=0;let i=this.config[`${this.config.platform}_settings`];i&&typeof i=="string"&&(i=JSON.parse(i),this.config[`${this.config.platform}_settings`]=i)}attach(r){if(this.observers.includes(r))return console.log("Subject: Observer has been attached already.");console.log("Subject: Attached an observer."),this.observers.push(r)}detach(r){const i=this.observers.indexOf(r);if(i===-1)return console.log("Subject: Nonexistent observer.");this.observers.splice(i,1),console.log("Subject: Detached an observer.")}notify(r,i){console.log("Subject: Notifying observers...");for(const o of this.observers)o.update(r,i)}async runLogin(r){var i;Et("worker=%o",r.worker,this.config.keywords),r.page&&(this.page=r.page),await((i=this.page)==null?void 0:i.setViewport({width:1280,height:800})),await this.load_browser_engine(),await this.makeloginaction()}async load_browser_engine(){var r,i,o;if(this.config.apply_evasion_techniques===!0&&await Ir(this.page),this.config.block_assets===!0&&(await this.page.setRequestInterception(!0),this.page.on("request",a=>{const c=a.resourceType();["stylesheet","font","image","media"].includes(c)?a.abort():a.continue()})),this.config.test_evasion===!0){const a="https://bot.sannysoft.com";await this.page.goto(a),await this.page.screenshot({path:"headless-evasion-result.png"})}if(this.config.log_http_headers===!0&&(this.metadata.http_headers=await fr(this.page)),this.config.log_ip_address===!0){const a=await pr(this.page);this.metadata.ipinfo=a}if(this.proxy&&this.config.log_ip_address===!0){if(Et(`${(r=this.metadata.ipinfo)==null?void 0:r.ip} vs ${this.proxy}`),(i=this.metadata.ipinfo)!=null&&i.ip&&!this.proxy.includes((o=this.metadata.ipinfo)==null?void 0:o.ip))throw new Error(`Proxy output ip ${this.proxy} does not match with provided one`);this.logger.info(`Using valid Proxy: ${this.proxy}`)}return await this.load_start_page()}async load_login_page(){}async load_start_page(){}async makeloginaction(){}async userloginaction(){}async searchdata(r){}async workersearchdata(r){if(r.worker&&console.log("worker=%o",r.worker,this.config.keywords),r.page&&(this.page=r.page),await this.page.setViewport({width:1280,height:800}),await this.load_browser_engine(),!this.config.keywords){console.error("keyword is empty");return}const i=await this.searchdata({keyword:this.config.keywords}),o=new _r;i==null||i.map(async a=>{try{let c={url:a.link,title:a.title,lang:a.lang,taskrunId:this.taskrunid};a.content&&(c.content=a.content),o.saveTaskresult(c,null)}catch(c){console.error(c)}})}async downloadvideo(r){const i=new Date,o=i.getFullYear()+"-"+(i.getMonth()+1)+"-"+i.getDate(),a=C.resolve(Br+"/tmp/video/"+o+"/");ne.existsSync(a)||ne.mkdirSync(a,{recursive:!0}),r.forEach(async(c,p)=>{Et(c);const g=await this.downloadSigleVideo(c.url,a);if(g)for(let w=0;w<g.length;w++){const h={video:{url:c.url,localpath:g[w],title:c.title,description:c.content,language:c.lang},scrapeinfo:c};this.notify("downloadvideoend",h)}})}async downloadSigleVideo(r,i){}}async function Ir(u){await u.evaluateOnNewDocument(()=>{const r=Object.getPrototypeOf(navigator);delete r.webdriver,Object.setPrototypeOf(navigator,r)}),await u.evaluateOnNewDocument(()=>{}),await u.evaluateOnNewDocument(()=>{Object.defineProperty(navigator,"plugins",{get:()=>[1,2,3,4,5]})}),await u.evaluateOnNewDocument(()=>{Object.defineProperty(navigator,"languages",{get:()=>["en-US","en"]})}),await u.evaluateOnNewDocument(()=>{Object.defineProperty(HTMLIFrameElement.prototype,"contentWindow",{get:function(){return window}})}),await u.evaluateOnNewDocument(()=>{window.console.debug=()=>null})}class Sr extends qt{constructor(r){super(r)}async load_login_page(){const r="https://www.facebook.com";this.logger.info("Using loginUrl: "+r),this.last_response=await this.page.goto(r)}async userloginaction(){}}const vr=require("fs");class ve extends qt{constructor(r){super(r)}async load_login_page(){const r="https://www.youtube.com";this.logger.info("Using loginUrl: "+r),await this.page.setBypassCSP(!0),this.last_response=await this.page.goto(r),await this.page.evaluate(()=>{const o=document.getElementById("logo-icon");o&&(o.style.display="none")}),console.log(this.config.tmppath),await this.page.waitForSelector("#avatar-btn",{timeout:0});const i=await this.page.cookies();await vr.writeFile(this.config.tmppath+"/cookies.json",JSON.stringify(i,null,2))}}module.exports={YoutubeScraper:ve};const oe=require("fs"),se=require("crypto"),Tr=require("http"),Fr=require("https"),Cr=require("progress-stream"),_t=require("node-fetch"),Ar=require("debug")("bilibili-download"),Ur=Ar("app:error");class Te{constructor(r){y(this,"url");y(this,"finished");this.url=r,this.finished=!1}}class Fe{constructor(){y(this,"type");y(this,"id");y(this,"url");y(this,"aid");y(this,"pid");y(this,"cid");y(this,"name");y(this,"links");y(this,"tasks");this.type="",this.id="",this.url="",this.aid=-1,this.pid=1,this.cid=-1,this.name="",this.links=[],this.tasks=[]}getVideoUrl(r){if(!r)throw new Error("video url is empty");this.url="";const i={BV:"https://www.bilibili.com/video/",bv:"https://www.bilibili.com/video/",av:"https://www.bilibili.com/video/",ep:"https://www.bilibili.com/bangumi/play/",ss:"https://www.bilibili.com/bangumi/play/"};for(const[o,a]of Object.entries(i))if(r.includes(o)){this.type=o,this.id=o+r.split(o)[1],this.url=a+this.id;break}}async getAid(){const{type:r,url:i}=this;if(i)return _t(i).then(o=>o.text()).then(o=>{const a=o.match(/__INITIAL_STATE__=(.*?);\(function\(\)/)[1],c=JSON.parse(a);r==="BV"||r==="bv"||r==="av"?(this.aid=c.videoData.aid,this.pid=parseInt(i.split("p=")[1],10)||1,this.cid=c.videoData.pages[this.pid-1].cid):r==="ep"?(this.aid=c.epInfo.aid,this.cid=c.epInfo.cid):r==="ss"&&(this.aid=c.epList[0].aid,this.cid=c.epList[0].cid)}).catch(function(o){throw new Error("get video aid error")})}async getInfo(){const{aid:r,cid:i}=this;if(!i)throw new Error("get video cid error");return _t("https://api.bilibili.com/x/web-interface/view?aid="+r).then(o=>o.json()).catch(function(o){throw new Error("get video info error")})}async getData(r=!1){const{cid:i,type:o}=this;let a;if(r){const c=`cid=${i}&module=movie&player=1&quality=112&ts=1`,p=se.createHash("md5").update(c+"9b288147e5474dd2aa67085f716c560d").digest("hex");a=`https://bangumi.bilibili.com/player/web_api/playurl?${c}&sign=${p}`}else if(o==="BV"||o==="bv"||o==="av"){const c=`appkey=iVGUTjsxvpLeuDCf&cid=${i}&otype=json&qn=112&quality=112&type=`,p=se.createHash("md5").update(c+"aHRmhWMLkdeMuILqORnYZocwMBpMEOdt").digest("hex");a=`https://interface.bilibili.com/v2/playurl?${c}&sign=${p}`}else a=`https://api.bilibili.com/pgc/player/web/playurl?qn=80&cid=${i}`;return _t(a).then(c=>c.text()).then(c=>{const p=r?this.parseData(c):JSON.parse(c),g=p.durl||p.result.durl;if(g)return this.links=g.map(w=>w.url),{fallback:r,data:p};if(r)throw Error();return this.getData(!0)}).catch(function(c){throw new Error("get playUrl or download link error")})}parseData(r){const i=$(r),o={durl:[],quality:""};return o.durl=[],o.quality=i.find("quality").text(),i.find("durl").each((a,c)=>{const p=$(c);o.durl.push({url:p.find("url").text(),order:p.find("order").text(),length:p.find("length").text(),size:p.find("size").text()})}),o}downloadByIndex(r,i,o=(a,c)=>{}){const{url:a}=this;if(this.tasks.some(w=>w.url===this.links[r]))return"DUPLICATE";this.tasks.push(new Te(this.links[r]));let c;try{c=oe.statSync(i)}catch{}const p={url:this.links[r],headers:{Range:`bytes=${c?c.size:0}-`,"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.212 Safari/537.36",Referer:a}},g=oe.createWriteStream(i,c?{flags:"a"}:{});return this.download(p,g,o),c}download(r,i,o){const a=this.tasks.findIndex(w=>w.url===r.url),c=Cr({time:250}).on("progress",w=>{const{percentage:m}=w;m===100&&(this.tasks[a].finished=!0),o(w,a)}),{url:p}=r;function g(w){(w.startsWith("https")?Fr:Tr).get(w,r,m=>{if(m.statusCode===302)return w=m.headers.location,g(w);c.setLength(m.headers["content-length"]),m.pipe(c).pipe(i).on("error",h=>{Ur(h)})})}g(p)}}module.exports={Task:Te,Downloader:Fe};require("cheerio");const Bt=require("fs"),Rr=require("path"),Mr=require("filenamify"),A=require("debug")("bilibili-scraper"),$r=A("app:error");class Ce extends qt{constructor(i){super(i);y(this,"startUrl");this.startUrl="https://www.bilibili.com",this.taskid=i.taskid,this.taskrunid=i.taskrunid}async load_start_page(){A("load start page")}async makeloginaction(){this.logger.info("Using loginUrl: "+this.startUrl),await this.page.setBypassCSP(!0),this.last_response=await this.page.goto(this.startUrl),await this.page.click(".header-login-entry"),await this.page.waitForSelector(".bili-mini-content-wp",{timeout:this.STANDARD_TIMEOUT});const i=await this.page.$("//div[contains(., ' 短信登录 ')]");i&&await i.click(),await this.page.waitForSelector(".header-entry-mini",{timeout:0});const o=await this.page.cookies();return await Bt.writeFile(JSON.stringify(o,null,2),a=>{a&&$r(a)}),await this.page.close(),!0}async clickSearchbtn(i){i.page&&(this.page=i.page),this.logger.info("Using loginUrl: "+this.startUrl),await this.page.setBypassCSP(!0),this.last_response=await this.page.goto(this.startUrl),await this.page.type(".nav-search-input",i.keyword);const o=await this.page.$(".nav-search-btn");return o&&await o.click(),o}async searchdata(i){i.page&&(this.page=i.page);const o=[];if(Array.isArray(i.keyword))for(const a of i.keyword){const c={page:this.page,keyword:a},p=await this.getVideourls(c);if(p)for(const g of p)o.push(g)}else if(typeof i.keyword=="string"){const a={page:this.page,keyword:i.keyword},c=await this.getVideourls(a);if(c)for(const p of c)o.push(c)}return o}async getVideourls(i){if(i.page&&(this.page=i.page),i.cookiesPath){if(!Bt.existsSync(i.cookiesPath))throw new Error(`Cannot find cookies file at ${i.cookiesPath}`);const o=JSON.parse(await Bt.promises.readFile(i.cookiesPath));await this.page.setCookie(...o)}if(typeof i.keyword=="string")return await this.handleSearch({page:this.page,keyword:i.keyword});{const o=[];for(const a of i.keyword){const c=await this.handleSearch({page:this.page,keyword:a});if(c)for(const p of c)o.push(p)}return o}}async handleSearch(i){await this.clickSearchbtn({page:this.page,keyword:i.keyword});const o=this.page.browser();await o.waitForTarget(w=>w.url().includes("search.bilibili.com"));const a=await o.pages();let c;for(const w of a)if((await w.url()).includes("search.bilibili.com")){c=w;break}if(!c)throw new Error("search page not found");await kr(c);try{await c.waitForSelector(".vui_pagenation",{timeout:5e3})}catch{return A("not find .vui_pagenation item, the page may not have result"),new Promise(m=>{m(null)})}const p=[],g=await c.$$("button.vui_button");A(g);for(let w=0;w<g.length;w++){await c.evaluate(h=>{h.click()},g[w]);const m=await this.getVideolistlink({page:c});A(m),m.map(h=>{p.push(h)})}return p}async getVideolistlink({page:i}){i&&(this.page=i);let o=[];return o=await this.page.$$eval(".bili-video-card__info--right >a:first-child",a=>a.map(c=>{const p={title:"",link:"",lang:"zh-cn"},g=c.getAttribute("href");g&&(p.link=g,g.startsWith("https")||(p.link="https:"+g));const w=c.querySelector("h3");if(w){const m=w.getAttribute("title");m&&(p.title=m)}return p})),await o.forEach((a,c)=>{a.link.includes("/video/")||o.splice(c,1)}),await o.forEach((a,c)=>{a.link.includes("/api/")&&(A("element has api "+a),o.splice(c,1))}),A(o),o}async downloadSigleVideo(i,o){if(!i)throw A(i),new Error("link is empty");const a=new Fe;if(a.getVideoUrl(i),!a.url)throw new Error("video url invalid");await a.getAid();const c=await a.getInfo();A("VIDEO INFO",c);const p=Math.random().toString(20).slice(2),{data:g,fallback:w}=await a.getData(),m=g.durl||g.result.durl,h=g.quality||g.result.quality,R={112:"1080P+",80:"1080P",74:"720P60",64:"720P",48:"720P",32:"480P",16:"360P",15:"360P"}[h]||"unknown";if(A("videoQuantity is "+R),w)throw new Error("error happen when get video data");const T=[];return m.forEach((j,G)=>{const J=Rr.join(o,`${Mr(p)}-${G}.flv`);A("part is %o",G),A("file name %o",J),a.downloadByIndex(G,J,(Vt,lt)=>{}),T.push(J)}),T}async getVideodetail(i,o){i&&(this.page=i),await this.page.goto(o,{waitUntil:"domcontentloaded"})}}module.exports={BilibiliScraper:Ce};var Ae={},gt={};gt.byteLength=qr;gt.toByteArray=Pr;gt.fromByteArray=jr;var P=[],U=[],Or=typeof Uint8Array<"u"?Uint8Array:Array,It="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var et=0,Dr=It.length;et<Dr;++et)P[et]=It[et],U[It.charCodeAt(et)]=et;U["-".charCodeAt(0)]=62;U["_".charCodeAt(0)]=63;function Ue(u){var r=u.length;if(r%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var i=u.indexOf("=");i===-1&&(i=r);var o=i===r?0:4-i%4;return[i,o]}function qr(u){var r=Ue(u),i=r[0],o=r[1];return(i+o)*3/4-o}function Nr(u,r,i){return(r+i)*3/4-i}function Pr(u){var r,i=Ue(u),o=i[0],a=i[1],c=new Or(Nr(u,o,a)),p=0,g=a>0?o-4:o,w;for(w=0;w<g;w+=4)r=U[u.charCodeAt(w)]<<18|U[u.charCodeAt(w+1)]<<12|U[u.charCodeAt(w+2)]<<6|U[u.charCodeAt(w+3)],c[p++]=r>>16&255,c[p++]=r>>8&255,c[p++]=r&255;return a===2&&(r=U[u.charCodeAt(w)]<<2|U[u.charCodeAt(w+1)]>>4,c[p++]=r&255),a===1&&(r=U[u.charCodeAt(w)]<<10|U[u.charCodeAt(w+1)]<<4|U[u.charCodeAt(w+2)]>>2,c[p++]=r>>8&255,c[p++]=r&255),c}function Lr(u){return P[u>>18&63]+P[u>>12&63]+P[u>>6&63]+P[u&63]}function Vr(u,r,i){for(var o,a=[],c=r;c<i;c+=3)o=(u[c]<<16&16711680)+(u[c+1]<<8&65280)+(u[c+2]&255),a.push(Lr(o));return a.join("")}function jr(u){for(var r,i=u.length,o=i%3,a=[],c=16383,p=0,g=i-o;p<g;p+=c)a.push(Vr(u,p,p+c>g?g:p+c));return o===1?(r=u[i-1],a.push(P[r>>2]+P[r<<4&63]+"==")):o===2&&(r=(u[i-2]<<8)+u[i-1],a.push(P[r>>10]+P[r>>4&63]+P[r<<2&63]+"=")),a.join("")}var Nt={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */Nt.read=function(u,r,i,o,a){var c,p,g=a*8-o-1,w=(1<<g)-1,m=w>>1,h=-7,I=i?a-1:0,R=i?-1:1,T=u[r+I];for(I+=R,c=T&(1<<-h)-1,T>>=-h,h+=g;h>0;c=c*256+u[r+I],I+=R,h-=8);for(p=c&(1<<-h)-1,c>>=-h,h+=o;h>0;p=p*256+u[r+I],I+=R,h-=8);if(c===0)c=1-m;else{if(c===w)return p?NaN:(T?-1:1)*(1/0);p=p+Math.pow(2,o),c=c-m}return(T?-1:1)*p*Math.pow(2,c-o)};Nt.write=function(u,r,i,o,a,c){var p,g,w,m=c*8-a-1,h=(1<<m)-1,I=h>>1,R=a===23?Math.pow(2,-24)-Math.pow(2,-77):0,T=o?0:c-1,j=o?1:-1,G=r<0||r===0&&1/r<0?1:0;for(r=Math.abs(r),isNaN(r)||r===1/0?(g=isNaN(r)?1:0,p=h):(p=Math.floor(Math.log(r)/Math.LN2),r*(w=Math.pow(2,-p))<1&&(p--,w*=2),p+I>=1?r+=R/w:r+=R*Math.pow(2,1-I),r*w>=2&&(p++,w/=2),p+I>=h?(g=0,p=h):p+I>=1?(g=(r*w-1)*Math.pow(2,a),p=p+I):(g=r*Math.pow(2,I-1)*Math.pow(2,a),p=0));a>=8;u[i+T]=g&255,T+=j,g/=256,a-=8);for(p=p<<a|g,m+=a;m>0;u[i+T]=p&255,T+=j,p/=256,m-=8);u[i+T-j]|=G*128};/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(u){const r=gt,i=Nt,o=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;u.Buffer=h,u.SlowBuffer=Le,u.INSPECT_MAX_BYTES=50;const a=2147483647;u.kMaxLength=a;const{Uint8Array:c,ArrayBuffer:p,SharedArrayBuffer:g}=globalThis;h.TYPED_ARRAY_SUPPORT=w(),!h.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function w(){try{const n=new c(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,c.prototype),Object.setPrototypeOf(n,t),n.foo()===42}catch{return!1}}Object.defineProperty(h.prototype,"parent",{enumerable:!0,get:function(){if(h.isBuffer(this))return this.buffer}}),Object.defineProperty(h.prototype,"offset",{enumerable:!0,get:function(){if(h.isBuffer(this))return this.byteOffset}});function m(n){if(n>a)throw new RangeError('The value "'+n+'" is invalid for option "size"');const t=new c(n);return Object.setPrototypeOf(t,h.prototype),t}function h(n,t,e){if(typeof n=="number"){if(typeof t=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return j(n)}return I(n,t,e)}h.poolSize=8192;function I(n,t,e){if(typeof n=="string")return G(n,t);if(p.isView(n))return Vt(n);if(n==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof n);if(M(n,p)||n&&M(n.buffer,p)||typeof g<"u"&&(M(n,g)||n&&M(n.buffer,g)))return lt(n,t,e);if(typeof n=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const s=n.valueOf&&n.valueOf();if(s!=null&&s!==n)return h.from(s,t,e);const l=Pe(n);if(l)return l;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof n[Symbol.toPrimitive]=="function")return h.from(n[Symbol.toPrimitive]("string"),t,e);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof n)}h.from=function(n,t,e){return I(n,t,e)},Object.setPrototypeOf(h.prototype,c.prototype),Object.setPrototypeOf(h,c);function R(n){if(typeof n!="number")throw new TypeError('"size" argument must be of type number');if(n<0)throw new RangeError('The value "'+n+'" is invalid for option "size"')}function T(n,t,e){return R(n),n<=0?m(n):t!==void 0?typeof e=="string"?m(n).fill(t,e):m(n).fill(t):m(n)}h.alloc=function(n,t,e){return T(n,t,e)};function j(n){return R(n),m(n<0?0:yt(n)|0)}h.allocUnsafe=function(n){return j(n)},h.allocUnsafeSlow=function(n){return j(n)};function G(n,t){if((typeof t!="string"||t==="")&&(t="utf8"),!h.isEncoding(t))throw new TypeError("Unknown encoding: "+t);const e=jt(n,t)|0;let s=m(e);const l=s.write(n,t);return l!==e&&(s=s.slice(0,l)),s}function J(n){const t=n.length<0?0:yt(n.length)|0,e=m(t);for(let s=0;s<t;s+=1)e[s]=n[s]&255;return e}function Vt(n){if(M(n,c)){const t=new c(n);return lt(t.buffer,t.byteOffset,t.byteLength)}return J(n)}function lt(n,t,e){if(t<0||n.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(n.byteLength<t+(e||0))throw new RangeError('"length" is outside of buffer bounds');let s;return t===void 0&&e===void 0?s=new c(n):e===void 0?s=new c(n,t):s=new c(n,t,e),Object.setPrototypeOf(s,h.prototype),s}function Pe(n){if(h.isBuffer(n)){const t=yt(n.length)|0,e=m(t);return e.length===0||n.copy(e,0,0,t),e}if(n.length!==void 0)return typeof n.length!="number"||xt(n.length)?m(0):J(n);if(n.type==="Buffer"&&Array.isArray(n.data))return J(n.data)}function yt(n){if(n>=a)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+a.toString(16)+" bytes");return n|0}function Le(n){return+n!=n&&(n=0),h.alloc(+n)}h.isBuffer=function(t){return t!=null&&t._isBuffer===!0&&t!==h.prototype},h.compare=function(t,e){if(M(t,c)&&(t=h.from(t,t.offset,t.byteLength)),M(e,c)&&(e=h.from(e,e.offset,e.byteLength)),!h.isBuffer(t)||!h.isBuffer(e))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(t===e)return 0;let s=t.length,l=e.length;for(let f=0,d=Math.min(s,l);f<d;++f)if(t[f]!==e[f]){s=t[f],l=e[f];break}return s<l?-1:l<s?1:0},h.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},h.concat=function(t,e){if(!Array.isArray(t))throw new TypeError('"list" argument must be an Array of Buffers');if(t.length===0)return h.alloc(0);let s;if(e===void 0)for(e=0,s=0;s<t.length;++s)e+=t[s].length;const l=h.allocUnsafe(e);let f=0;for(s=0;s<t.length;++s){let d=t[s];if(M(d,c))f+d.length>l.length?(h.isBuffer(d)||(d=h.from(d)),d.copy(l,f)):c.prototype.set.call(l,d,f);else if(h.isBuffer(d))d.copy(l,f);else throw new TypeError('"list" argument must be an Array of Buffers');f+=d.length}return l};function jt(n,t){if(h.isBuffer(n))return n.length;if(p.isView(n)||M(n,p))return n.byteLength;if(typeof n!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof n);const e=n.length,s=arguments.length>2&&arguments[2]===!0;if(!s&&e===0)return 0;let l=!1;for(;;)switch(t){case"ascii":case"latin1":case"binary":return e;case"utf8":case"utf-8":return kt(n).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return e*2;case"hex":return e>>>1;case"base64":return ee(n).length;default:if(l)return s?-1:kt(n).length;t=(""+t).toLowerCase(),l=!0}}h.byteLength=jt;function Ve(n,t,e){let s=!1;if((t===void 0||t<0)&&(t=0),t>this.length||((e===void 0||e>this.length)&&(e=this.length),e<=0)||(e>>>=0,t>>>=0,e<=t))return"";for(n||(n="utf8");;)switch(n){case"hex":return Qe(this,t,e);case"utf8":case"utf-8":return Gt(this,t,e);case"ascii":return Ke(this,t,e);case"latin1":case"binary":return Xe(this,t,e);case"base64":return ze(this,t,e);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Ze(this,t,e);default:if(s)throw new TypeError("Unknown encoding: "+n);n=(n+"").toLowerCase(),s=!0}}h.prototype._isBuffer=!0;function z(n,t,e){const s=n[t];n[t]=n[e],n[e]=s}h.prototype.swap16=function(){const t=this.length;if(t%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let e=0;e<t;e+=2)z(this,e,e+1);return this},h.prototype.swap32=function(){const t=this.length;if(t%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let e=0;e<t;e+=4)z(this,e,e+3),z(this,e+1,e+2);return this},h.prototype.swap64=function(){const t=this.length;if(t%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let e=0;e<t;e+=8)z(this,e,e+7),z(this,e+1,e+6),z(this,e+2,e+5),z(this,e+3,e+4);return this},h.prototype.toString=function(){const t=this.length;return t===0?"":arguments.length===0?Gt(this,0,t):Ve.apply(this,arguments)},h.prototype.toLocaleString=h.prototype.toString,h.prototype.equals=function(t){if(!h.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t?!0:h.compare(this,t)===0},h.prototype.inspect=function(){let t="";const e=u.INSPECT_MAX_BYTES;return t=this.toString("hex",0,e).replace(/(.{2})/g,"$1 ").trim(),this.length>e&&(t+=" ... "),"<Buffer "+t+">"},o&&(h.prototype[o]=h.prototype.inspect),h.prototype.compare=function(t,e,s,l,f){if(M(t,c)&&(t=h.from(t,t.offset,t.byteLength)),!h.isBuffer(t))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof t);if(e===void 0&&(e=0),s===void 0&&(s=t?t.length:0),l===void 0&&(l=0),f===void 0&&(f=this.length),e<0||s>t.length||l<0||f>this.length)throw new RangeError("out of range index");if(l>=f&&e>=s)return 0;if(l>=f)return-1;if(e>=s)return 1;if(e>>>=0,s>>>=0,l>>>=0,f>>>=0,this===t)return 0;let d=f-l,k=s-e;const E=Math.min(d,k),b=this.slice(l,f),_=t.slice(e,s);for(let x=0;x<E;++x)if(b[x]!==_[x]){d=b[x],k=_[x];break}return d<k?-1:k<d?1:0};function Ht(n,t,e,s,l){if(n.length===0)return-1;if(typeof e=="string"?(s=e,e=0):e>2147483647?e=2147483647:e<-2147483648&&(e=-2147483648),e=+e,xt(e)&&(e=l?0:n.length-1),e<0&&(e=n.length+e),e>=n.length){if(l)return-1;e=n.length-1}else if(e<0)if(l)e=0;else return-1;if(typeof t=="string"&&(t=h.from(t,s)),h.isBuffer(t))return t.length===0?-1:Wt(n,t,e,s,l);if(typeof t=="number")return t=t&255,typeof c.prototype.indexOf=="function"?l?c.prototype.indexOf.call(n,t,e):c.prototype.lastIndexOf.call(n,t,e):Wt(n,[t],e,s,l);throw new TypeError("val must be string, number or Buffer")}function Wt(n,t,e,s,l){let f=1,d=n.length,k=t.length;if(s!==void 0&&(s=String(s).toLowerCase(),s==="ucs2"||s==="ucs-2"||s==="utf16le"||s==="utf-16le")){if(n.length<2||t.length<2)return-1;f=2,d/=2,k/=2,e/=2}function E(_,x){return f===1?_[x]:_.readUInt16BE(x*f)}let b;if(l){let _=-1;for(b=e;b<d;b++)if(E(n,b)===E(t,_===-1?0:b-_)){if(_===-1&&(_=b),b-_+1===k)return _*f}else _!==-1&&(b-=b-_),_=-1}else for(e+k>d&&(e=d-k),b=e;b>=0;b--){let _=!0;for(let x=0;x<k;x++)if(E(n,b+x)!==E(t,x)){_=!1;break}if(_)return b}return-1}h.prototype.includes=function(t,e,s){return this.indexOf(t,e,s)!==-1},h.prototype.indexOf=function(t,e,s){return Ht(this,t,e,s,!0)},h.prototype.lastIndexOf=function(t,e,s){return Ht(this,t,e,s,!1)};function je(n,t,e,s){e=Number(e)||0;const l=n.length-e;s?(s=Number(s),s>l&&(s=l)):s=l;const f=t.length;s>f/2&&(s=f/2);let d;for(d=0;d<s;++d){const k=parseInt(t.substr(d*2,2),16);if(xt(k))return d;n[e+d]=k}return d}function He(n,t,e,s){return ht(kt(t,n.length-e),n,e,s)}function We(n,t,e,s){return ht(ir(t),n,e,s)}function Ge(n,t,e,s){return ht(ee(t),n,e,s)}function Je(n,t,e,s){return ht(nr(t,n.length-e),n,e,s)}h.prototype.write=function(t,e,s,l){if(e===void 0)l="utf8",s=this.length,e=0;else if(s===void 0&&typeof e=="string")l=e,s=this.length,e=0;else if(isFinite(e))e=e>>>0,isFinite(s)?(s=s>>>0,l===void 0&&(l="utf8")):(l=s,s=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const f=this.length-e;if((s===void 0||s>f)&&(s=f),t.length>0&&(s<0||e<0)||e>this.length)throw new RangeError("Attempt to write outside buffer bounds");l||(l="utf8");let d=!1;for(;;)switch(l){case"hex":return je(this,t,e,s);case"utf8":case"utf-8":return He(this,t,e,s);case"ascii":case"latin1":case"binary":return We(this,t,e,s);case"base64":return Ge(this,t,e,s);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Je(this,t,e,s);default:if(d)throw new TypeError("Unknown encoding: "+l);l=(""+l).toLowerCase(),d=!0}},h.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function ze(n,t,e){return t===0&&e===n.length?r.fromByteArray(n):r.fromByteArray(n.slice(t,e))}function Gt(n,t,e){e=Math.min(n.length,e);const s=[];let l=t;for(;l<e;){const f=n[l];let d=null,k=f>239?4:f>223?3:f>191?2:1;if(l+k<=e){let E,b,_,x;switch(k){case 1:f<128&&(d=f);break;case 2:E=n[l+1],(E&192)===128&&(x=(f&31)<<6|E&63,x>127&&(d=x));break;case 3:E=n[l+1],b=n[l+2],(E&192)===128&&(b&192)===128&&(x=(f&15)<<12|(E&63)<<6|b&63,x>2047&&(x<55296||x>57343)&&(d=x));break;case 4:E=n[l+1],b=n[l+2],_=n[l+3],(E&192)===128&&(b&192)===128&&(_&192)===128&&(x=(f&15)<<18|(E&63)<<12|(b&63)<<6|_&63,x>65535&&x<1114112&&(d=x))}}d===null?(d=65533,k=1):d>65535&&(d-=65536,s.push(d>>>10&1023|55296),d=56320|d&1023),s.push(d),l+=k}return Ye(s)}const Jt=4096;function Ye(n){const t=n.length;if(t<=Jt)return String.fromCharCode.apply(String,n);let e="",s=0;for(;s<t;)e+=String.fromCharCode.apply(String,n.slice(s,s+=Jt));return e}function Ke(n,t,e){let s="";e=Math.min(n.length,e);for(let l=t;l<e;++l)s+=String.fromCharCode(n[l]&127);return s}function Xe(n,t,e){let s="";e=Math.min(n.length,e);for(let l=t;l<e;++l)s+=String.fromCharCode(n[l]);return s}function Qe(n,t,e){const s=n.length;(!t||t<0)&&(t=0),(!e||e<0||e>s)&&(e=s);let l="";for(let f=t;f<e;++f)l+=or[n[f]];return l}function Ze(n,t,e){const s=n.slice(t,e);let l="";for(let f=0;f<s.length-1;f+=2)l+=String.fromCharCode(s[f]+s[f+1]*256);return l}h.prototype.slice=function(t,e){const s=this.length;t=~~t,e=e===void 0?s:~~e,t<0?(t+=s,t<0&&(t=0)):t>s&&(t=s),e<0?(e+=s,e<0&&(e=0)):e>s&&(e=s),e<t&&(e=t);const l=this.subarray(t,e);return Object.setPrototypeOf(l,h.prototype),l};function S(n,t,e){if(n%1!==0||n<0)throw new RangeError("offset is not uint");if(n+t>e)throw new RangeError("Trying to access beyond buffer length")}h.prototype.readUintLE=h.prototype.readUIntLE=function(t,e,s){t=t>>>0,e=e>>>0,s||S(t,e,this.length);let l=this[t],f=1,d=0;for(;++d<e&&(f*=256);)l+=this[t+d]*f;return l},h.prototype.readUintBE=h.prototype.readUIntBE=function(t,e,s){t=t>>>0,e=e>>>0,s||S(t,e,this.length);let l=this[t+--e],f=1;for(;e>0&&(f*=256);)l+=this[t+--e]*f;return l},h.prototype.readUint8=h.prototype.readUInt8=function(t,e){return t=t>>>0,e||S(t,1,this.length),this[t]},h.prototype.readUint16LE=h.prototype.readUInt16LE=function(t,e){return t=t>>>0,e||S(t,2,this.length),this[t]|this[t+1]<<8},h.prototype.readUint16BE=h.prototype.readUInt16BE=function(t,e){return t=t>>>0,e||S(t,2,this.length),this[t]<<8|this[t+1]},h.prototype.readUint32LE=h.prototype.readUInt32LE=function(t,e){return t=t>>>0,e||S(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+this[t+3]*16777216},h.prototype.readUint32BE=h.prototype.readUInt32BE=function(t,e){return t=t>>>0,e||S(t,4,this.length),this[t]*16777216+(this[t+1]<<16|this[t+2]<<8|this[t+3])},h.prototype.readBigUInt64LE=H(function(t){t=t>>>0,tt(t,"offset");const e=this[t],s=this[t+7];(e===void 0||s===void 0)&&ot(t,this.length-8);const l=e+this[++t]*2**8+this[++t]*2**16+this[++t]*2**24,f=this[++t]+this[++t]*2**8+this[++t]*2**16+s*2**24;return BigInt(l)+(BigInt(f)<<BigInt(32))}),h.prototype.readBigUInt64BE=H(function(t){t=t>>>0,tt(t,"offset");const e=this[t],s=this[t+7];(e===void 0||s===void 0)&&ot(t,this.length-8);const l=e*2**24+this[++t]*2**16+this[++t]*2**8+this[++t],f=this[++t]*2**24+this[++t]*2**16+this[++t]*2**8+s;return(BigInt(l)<<BigInt(32))+BigInt(f)}),h.prototype.readIntLE=function(t,e,s){t=t>>>0,e=e>>>0,s||S(t,e,this.length);let l=this[t],f=1,d=0;for(;++d<e&&(f*=256);)l+=this[t+d]*f;return f*=128,l>=f&&(l-=Math.pow(2,8*e)),l},h.prototype.readIntBE=function(t,e,s){t=t>>>0,e=e>>>0,s||S(t,e,this.length);let l=e,f=1,d=this[t+--l];for(;l>0&&(f*=256);)d+=this[t+--l]*f;return f*=128,d>=f&&(d-=Math.pow(2,8*e)),d},h.prototype.readInt8=function(t,e){return t=t>>>0,e||S(t,1,this.length),this[t]&128?(255-this[t]+1)*-1:this[t]},h.prototype.readInt16LE=function(t,e){t=t>>>0,e||S(t,2,this.length);const s=this[t]|this[t+1]<<8;return s&32768?s|4294901760:s},h.prototype.readInt16BE=function(t,e){t=t>>>0,e||S(t,2,this.length);const s=this[t+1]|this[t]<<8;return s&32768?s|4294901760:s},h.prototype.readInt32LE=function(t,e){return t=t>>>0,e||S(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},h.prototype.readInt32BE=function(t,e){return t=t>>>0,e||S(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},h.prototype.readBigInt64LE=H(function(t){t=t>>>0,tt(t,"offset");const e=this[t],s=this[t+7];(e===void 0||s===void 0)&&ot(t,this.length-8);const l=this[t+4]+this[t+5]*2**8+this[t+6]*2**16+(s<<24);return(BigInt(l)<<BigInt(32))+BigInt(e+this[++t]*2**8+this[++t]*2**16+this[++t]*2**24)}),h.prototype.readBigInt64BE=H(function(t){t=t>>>0,tt(t,"offset");const e=this[t],s=this[t+7];(e===void 0||s===void 0)&&ot(t,this.length-8);const l=(e<<24)+this[++t]*2**16+this[++t]*2**8+this[++t];return(BigInt(l)<<BigInt(32))+BigInt(this[++t]*2**24+this[++t]*2**16+this[++t]*2**8+s)}),h.prototype.readFloatLE=function(t,e){return t=t>>>0,e||S(t,4,this.length),i.read(this,t,!0,23,4)},h.prototype.readFloatBE=function(t,e){return t=t>>>0,e||S(t,4,this.length),i.read(this,t,!1,23,4)},h.prototype.readDoubleLE=function(t,e){return t=t>>>0,e||S(t,8,this.length),i.read(this,t,!0,52,8)},h.prototype.readDoubleBE=function(t,e){return t=t>>>0,e||S(t,8,this.length),i.read(this,t,!1,52,8)};function F(n,t,e,s,l,f){if(!h.isBuffer(n))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>l||t<f)throw new RangeError('"value" argument is out of bounds');if(e+s>n.length)throw new RangeError("Index out of range")}h.prototype.writeUintLE=h.prototype.writeUIntLE=function(t,e,s,l){if(t=+t,e=e>>>0,s=s>>>0,!l){const k=Math.pow(2,8*s)-1;F(this,t,e,s,k,0)}let f=1,d=0;for(this[e]=t&255;++d<s&&(f*=256);)this[e+d]=t/f&255;return e+s},h.prototype.writeUintBE=h.prototype.writeUIntBE=function(t,e,s,l){if(t=+t,e=e>>>0,s=s>>>0,!l){const k=Math.pow(2,8*s)-1;F(this,t,e,s,k,0)}let f=s-1,d=1;for(this[e+f]=t&255;--f>=0&&(d*=256);)this[e+f]=t/d&255;return e+s},h.prototype.writeUint8=h.prototype.writeUInt8=function(t,e,s){return t=+t,e=e>>>0,s||F(this,t,e,1,255,0),this[e]=t&255,e+1},h.prototype.writeUint16LE=h.prototype.writeUInt16LE=function(t,e,s){return t=+t,e=e>>>0,s||F(this,t,e,2,65535,0),this[e]=t&255,this[e+1]=t>>>8,e+2},h.prototype.writeUint16BE=h.prototype.writeUInt16BE=function(t,e,s){return t=+t,e=e>>>0,s||F(this,t,e,2,65535,0),this[e]=t>>>8,this[e+1]=t&255,e+2},h.prototype.writeUint32LE=h.prototype.writeUInt32LE=function(t,e,s){return t=+t,e=e>>>0,s||F(this,t,e,4,4294967295,0),this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=t&255,e+4},h.prototype.writeUint32BE=h.prototype.writeUInt32BE=function(t,e,s){return t=+t,e=e>>>0,s||F(this,t,e,4,4294967295,0),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=t&255,e+4};function zt(n,t,e,s,l){te(t,s,l,n,e,7);let f=Number(t&BigInt(4294967295));n[e++]=f,f=f>>8,n[e++]=f,f=f>>8,n[e++]=f,f=f>>8,n[e++]=f;let d=Number(t>>BigInt(32)&BigInt(4294967295));return n[e++]=d,d=d>>8,n[e++]=d,d=d>>8,n[e++]=d,d=d>>8,n[e++]=d,e}function Yt(n,t,e,s,l){te(t,s,l,n,e,7);let f=Number(t&BigInt(4294967295));n[e+7]=f,f=f>>8,n[e+6]=f,f=f>>8,n[e+5]=f,f=f>>8,n[e+4]=f;let d=Number(t>>BigInt(32)&BigInt(4294967295));return n[e+3]=d,d=d>>8,n[e+2]=d,d=d>>8,n[e+1]=d,d=d>>8,n[e]=d,e+8}h.prototype.writeBigUInt64LE=H(function(t,e=0){return zt(this,t,e,BigInt(0),BigInt("0xffffffffffffffff"))}),h.prototype.writeBigUInt64BE=H(function(t,e=0){return Yt(this,t,e,BigInt(0),BigInt("0xffffffffffffffff"))}),h.prototype.writeIntLE=function(t,e,s,l){if(t=+t,e=e>>>0,!l){const E=Math.pow(2,8*s-1);F(this,t,e,s,E-1,-E)}let f=0,d=1,k=0;for(this[e]=t&255;++f<s&&(d*=256);)t<0&&k===0&&this[e+f-1]!==0&&(k=1),this[e+f]=(t/d>>0)-k&255;return e+s},h.prototype.writeIntBE=function(t,e,s,l){if(t=+t,e=e>>>0,!l){const E=Math.pow(2,8*s-1);F(this,t,e,s,E-1,-E)}let f=s-1,d=1,k=0;for(this[e+f]=t&255;--f>=0&&(d*=256);)t<0&&k===0&&this[e+f+1]!==0&&(k=1),this[e+f]=(t/d>>0)-k&255;return e+s},h.prototype.writeInt8=function(t,e,s){return t=+t,e=e>>>0,s||F(this,t,e,1,127,-128),t<0&&(t=255+t+1),this[e]=t&255,e+1},h.prototype.writeInt16LE=function(t,e,s){return t=+t,e=e>>>0,s||F(this,t,e,2,32767,-32768),this[e]=t&255,this[e+1]=t>>>8,e+2},h.prototype.writeInt16BE=function(t,e,s){return t=+t,e=e>>>0,s||F(this,t,e,2,32767,-32768),this[e]=t>>>8,this[e+1]=t&255,e+2},h.prototype.writeInt32LE=function(t,e,s){return t=+t,e=e>>>0,s||F(this,t,e,4,2147483647,-2147483648),this[e]=t&255,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24,e+4},h.prototype.writeInt32BE=function(t,e,s){return t=+t,e=e>>>0,s||F(this,t,e,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=t&255,e+4},h.prototype.writeBigInt64LE=H(function(t,e=0){return zt(this,t,e,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),h.prototype.writeBigInt64BE=H(function(t,e=0){return Yt(this,t,e,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function Kt(n,t,e,s,l,f){if(e+s>n.length)throw new RangeError("Index out of range");if(e<0)throw new RangeError("Index out of range")}function Xt(n,t,e,s,l){return t=+t,e=e>>>0,l||Kt(n,t,e,4),i.write(n,t,e,s,23,4),e+4}h.prototype.writeFloatLE=function(t,e,s){return Xt(this,t,e,!0,s)},h.prototype.writeFloatBE=function(t,e,s){return Xt(this,t,e,!1,s)};function Qt(n,t,e,s,l){return t=+t,e=e>>>0,l||Kt(n,t,e,8),i.write(n,t,e,s,52,8),e+8}h.prototype.writeDoubleLE=function(t,e,s){return Qt(this,t,e,!0,s)},h.prototype.writeDoubleBE=function(t,e,s){return Qt(this,t,e,!1,s)},h.prototype.copy=function(t,e,s,l){if(!h.isBuffer(t))throw new TypeError("argument should be a Buffer");if(s||(s=0),!l&&l!==0&&(l=this.length),e>=t.length&&(e=t.length),e||(e=0),l>0&&l<s&&(l=s),l===s||t.length===0||this.length===0)return 0;if(e<0)throw new RangeError("targetStart out of bounds");if(s<0||s>=this.length)throw new RangeError("Index out of range");if(l<0)throw new RangeError("sourceEnd out of bounds");l>this.length&&(l=this.length),t.length-e<l-s&&(l=t.length-e+s);const f=l-s;return this===t&&typeof c.prototype.copyWithin=="function"?this.copyWithin(e,s,l):c.prototype.set.call(t,this.subarray(s,l),e),f},h.prototype.fill=function(t,e,s,l){if(typeof t=="string"){if(typeof e=="string"?(l=e,e=0,s=this.length):typeof s=="string"&&(l=s,s=this.length),l!==void 0&&typeof l!="string")throw new TypeError("encoding must be a string");if(typeof l=="string"&&!h.isEncoding(l))throw new TypeError("Unknown encoding: "+l);if(t.length===1){const d=t.charCodeAt(0);(l==="utf8"&&d<128||l==="latin1")&&(t=d)}}else typeof t=="number"?t=t&255:typeof t=="boolean"&&(t=Number(t));if(e<0||this.length<e||this.length<s)throw new RangeError("Out of range index");if(s<=e)return this;e=e>>>0,s=s===void 0?this.length:s>>>0,t||(t=0);let f;if(typeof t=="number")for(f=e;f<s;++f)this[f]=t;else{const d=h.isBuffer(t)?t:h.from(t,l),k=d.length;if(k===0)throw new TypeError('The value "'+t+'" is invalid for argument "value"');for(f=0;f<s-e;++f)this[f+e]=d[f%k]}return this};const Z={};function mt(n,t,e){Z[n]=class extends e{constructor(){super(),Object.defineProperty(this,"message",{value:t.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${n}]`,this.stack,delete this.name}get code(){return n}set code(l){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:l,writable:!0})}toString(){return`${this.name} [${n}]: ${this.message}`}}}mt("ERR_BUFFER_OUT_OF_BOUNDS",function(n){return n?`${n} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),mt("ERR_INVALID_ARG_TYPE",function(n,t){return`The "${n}" argument must be of type number. Received type ${typeof t}`},TypeError),mt("ERR_OUT_OF_RANGE",function(n,t,e){let s=`The value of "${n}" is out of range.`,l=e;return Number.isInteger(e)&&Math.abs(e)>2**32?l=Zt(String(e)):typeof e=="bigint"&&(l=String(e),(e>BigInt(2)**BigInt(32)||e<-(BigInt(2)**BigInt(32)))&&(l=Zt(l)),l+="n"),s+=` It must be ${t}. Received ${l}`,s},RangeError);function Zt(n){let t="",e=n.length;const s=n[0]==="-"?1:0;for(;e>=s+4;e-=3)t=`_${n.slice(e-3,e)}${t}`;return`${n.slice(0,e)}${t}`}function tr(n,t,e){tt(t,"offset"),(n[t]===void 0||n[t+e]===void 0)&&ot(t,n.length-(e+1))}function te(n,t,e,s,l,f){if(n>e||n<t){const d=typeof t=="bigint"?"n":"";let k;throw f>3?t===0||t===BigInt(0)?k=`>= 0${d} and < 2${d} ** ${(f+1)*8}${d}`:k=`>= -(2${d} ** ${(f+1)*8-1}${d}) and < 2 ** ${(f+1)*8-1}${d}`:k=`>= ${t}${d} and <= ${e}${d}`,new Z.ERR_OUT_OF_RANGE("value",k,n)}tr(s,l,f)}function tt(n,t){if(typeof n!="number")throw new Z.ERR_INVALID_ARG_TYPE(t,"number",n)}function ot(n,t,e){throw Math.floor(n)!==n?(tt(n,e),new Z.ERR_OUT_OF_RANGE(e||"offset","an integer",n)):t<0?new Z.ERR_BUFFER_OUT_OF_BOUNDS:new Z.ERR_OUT_OF_RANGE(e||"offset",`>= ${e?1:0} and <= ${t}`,n)}const er=/[^+/0-9A-Za-z-_]/g;function rr(n){if(n=n.split("=")[0],n=n.trim().replace(er,""),n.length<2)return"";for(;n.length%4!==0;)n=n+"=";return n}function kt(n,t){t=t||1/0;let e;const s=n.length;let l=null;const f=[];for(let d=0;d<s;++d){if(e=n.charCodeAt(d),e>55295&&e<57344){if(!l){if(e>56319){(t-=3)>-1&&f.push(239,191,189);continue}else if(d+1===s){(t-=3)>-1&&f.push(239,191,189);continue}l=e;continue}if(e<56320){(t-=3)>-1&&f.push(239,191,189),l=e;continue}e=(l-55296<<10|e-56320)+65536}else l&&(t-=3)>-1&&f.push(239,191,189);if(l=null,e<128){if((t-=1)<0)break;f.push(e)}else if(e<2048){if((t-=2)<0)break;f.push(e>>6|192,e&63|128)}else if(e<65536){if((t-=3)<0)break;f.push(e>>12|224,e>>6&63|128,e&63|128)}else if(e<1114112){if((t-=4)<0)break;f.push(e>>18|240,e>>12&63|128,e>>6&63|128,e&63|128)}else throw new Error("Invalid code point")}return f}function ir(n){const t=[];for(let e=0;e<n.length;++e)t.push(n.charCodeAt(e)&255);return t}function nr(n,t){let e,s,l;const f=[];for(let d=0;d<n.length&&!((t-=2)<0);++d)e=n.charCodeAt(d),s=e>>8,l=e%256,f.push(l),f.push(s);return f}function ee(n){return r.toByteArray(rr(n))}function ht(n,t,e,s){let l;for(l=0;l<s&&!(l+e>=t.length||l>=n.length);++l)t[l+e]=n[l];return l}function M(n,t){return n instanceof t||n!=null&&n.constructor!=null&&n.constructor.name!=null&&n.constructor.name===t.name}function xt(n){return n!==n}const or=function(){const n="0123456789abcdef",t=new Array(256);for(let e=0;e<16;++e){const s=e*16;for(let l=0;l<16;++l)t[s+l]=n[e]+n[l]}return t}();function H(n){return typeof BigInt>"u"?sr:n}function sr(){throw new Error("BigInt not supported")}})(Ae);const W=Ae.Buffer;class ae{constructor(){y(this,"algorithm","aes-256-cbc");y(this,"key");y(this,"iv",pt.randomBytes(16));this.algorithm="aes-256-cbc";const r="Tus7uAT6r3eSj9gVbF7Wic3ipNczYNK1";this.key=W.from(r),this.iv=pt.randomBytes(16)}encrypt(r){let i=pt.createCipheriv(this.algorithm,this.key,this.iv),o=i.update(r);return o=W.concat([o,i.final()]),{iv:this.iv.toString("hex"),encryptedData:o.toString("hex")}}decrypt(r){let i=W.from(r.iv,"hex"),o=W.from(r.encryptedData,"hex"),a=pt.createDecipheriv(this.algorithm,W.from(this.key),i),c=a.update(o);return c=W.concat([c,a.final()]),c.toString()}}const ce=require("keytar");class Hr{constructor(r){y(this,"service");this.service=r}setPassword(r,i){ce.setPassword(this.service,r,i)}async getPassword(r){return await ce.getPassword(this.service,r)}}class Ft{constructor(){y(this,"store");y(this,"useSafestore");this.store=new Hr("social-market-token"),this.useSafestore=!1}setValue(r,i){if(this.useSafestore){const o=ct.safeStorage.encryptString(i);this.store.setPassword(r,o.toString())}else{const a=new ae().encrypt(i);this.store.setPassword(r,JSON.stringify(a))}}async getValue(r){const i=await this.store.getPassword(r);return i?this.useSafestore?ct.safeStorage.decryptString(W.from(i)):new ae().decrypt(JSON.parse(i)):""}checkEncryavaile(r){return ct.safeStorage.isEncryptionAvailable()}}class Pt{constructor(){y(this,"_headers",{});y(this,"baseUrl");this.baseUrl="http://localhost:8082"}async setheaderToken(){const i=await new Ft().getValue("social-market-token");console.log("prepare to set token:"+i),i&&this.setHeader("Authorization","Bearer "+i)}async _fetchJSON(r,i){await this.setheaderToken();const o=await fetch(this.baseUrl+r,{...i,headers:this._headers});if(!o.ok)throw new Error(o.statusText);const a=await o.json();return console.log(a),a}setHeader(r,i){return this._headers[r]=i,this}getHeader(r){return this._headers[r]}setBasicAuth(r,i){return this._headers.Authorization=`Basic ${btoa(`${r}:${i}`)}`,this}setBearerAuth(r){return this._headers.Authorization=`Bearer ${r}`,this}async get(r,i={}){return console.log(this._headers),this._fetchJSON(r,{...i,method:"GET"})}async post(r,i,o={}){return this._fetchJSON(r,{...o,body:i,method:"POST"})}async put(r,i){return this._fetchJSON(r,{body:i?JSON.stringify(i):void 0,method:"PUT"})}async patch(r,i,o={}){return this._fetchJSON(r,{...o,body:JSON.stringify(i),method:"PATCH"})}async delete(r,i={}){return this._fetchJSON(r,{...i,method:"DELETE"})}}function Ct(u){this.message=u}Ct.prototype=new Error,Ct.prototype.name="InvalidCharacterError";var ue=typeof window<"u"&&window.atob&&window.atob.bind(window)||function(u){var r=String(u).replace(/=+$/,"");if(r.length%4==1)throw new Ct("'atob' failed: The string to be decoded is not correctly encoded.");for(var i,o,a=0,c=0,p="";o=r.charAt(c++);~o&&(i=a%4?64*i+o:o,a++%4)?p+=String.fromCharCode(255&i>>(-2*a&6)):0)o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(o);return p};function Wr(u){var r=u.replace(/-/g,"+").replace(/_/g,"/");switch(r.length%4){case 0:break;case 2:r+="==";break;case 3:r+="=";break;default:throw"Illegal base64url string!"}try{return function(i){return decodeURIComponent(ue(i).replace(/(.)/g,function(o,a){var c=a.charCodeAt(0).toString(16).toUpperCase();return c.length<2&&(c="0"+c),"%"+c}))}(r)}catch{return ue(r)}}function dt(u){this.message=u}function Gr(u,r){if(typeof u!="string")throw new dt("Invalid token specified");var i=(r=r||{}).header===!0?0:1;try{return JSON.parse(Wr(u.split(".")[i]))}catch(o){throw new dt("Invalid token specified: "+o.message)}}dt.prototype=new Error,dt.prototype.name="InvalidTokenError";const le=require("debug")("RemoteSource");class Lt{constructor(){y(this,"tokenname","social-market-token");y(this,"REMOTEADD");y(this,"_httpClient");this._httpClient=new Pt}readConfig(){const r=require("dotenv").config();if(r.error)throw r.error;return r.parsed}async getRemoteConfig(r){return this._httpClient.get("/api/getsobyCam/?campaign_id="+r).then(function(o){if(o.status!=200)throw new Error("code not equal 200");if(!o.data.status)throw new Error("code not equal 200");return{sotype:o.data.data.sotype,socialuser:o.data.data.user,socialpass:o.data.data.pass,proxy:{proxy:o.data.data.proxy.url,user:o.data.data.proxy.user,pass:o.data.data.proxy.pass}}}).catch(function(o){console.error(o)})}async saveLinkremote(r){const i=require("form-data");le(r);let o=new i;return o.append("title",r.title),r.content&&o.append("content",r.content),o.append("url",r.url),o.append("lang",r.lang),r.socialtask_id&&o.append("socialtask_id",r.socialtask_id),this._httpClient.post("/api/savesolink",o).then(function(c){return c.data.data}).catch(function(c){throw new Error(c.message)})}async Getscrapyinfolist(r,i){return this._httpClient.get("/api/getscrapeinfolist?sotaskid="+r+"&limit="+i).then(function(a){return le(a),a.data.data?a.data.data:null}).catch(function(a){throw new Error(a.message)})}async Gettaskinfo(r){return this._httpClient.get("/api/getsocialtaskinfo?task_id="+r).then(function(o){return o.data.data}).catch(function(o){throw new Error(o.message)})}async Gettaskkeywords(r){return this._httpClient.get("/api/taskkeyword?task_id="+r).then(function(o){const a=[],c=o.data.data;for(const p in c)a.push(c[p].keyword);return a}).catch(function(o){throw new Error(o.message)})}async Updateprocesstime(r){const i=require("form-data"),o=new i;o.append("id",r),await this._httpClient.post("/api/updatescrapeprotime",o).then(function(a){}).catch(function(a){throw new Error(a.message)})}async Login(r,i){var o=new FormData;o.append("username",r),o.append("password",i),console.log(Array.from(o));const a=this;return await this._httpClient.post("/user/login",o).then(function(p){if(!p.status)throw new Error(p.msg);const g=a.ValidateToken(p.data.Token);return g.account_id>0&&new Ft().setValue(a.tokenname,p.data.Token),g}).catch(function(p){throw new Error(p.message)})}async GetUserInfo(){const i=await new Ft().getValue(this.tokenname);return i==null||i.length<1?null:(console.log("token is:"+i),await this._httpClient.get("/api/user/info").then(function(a){if(a.status==!1)throw new Error(a.msg);return a.data}).catch(function(a){throw new Error(a.message)}))}ValidateToken(r){const i=Gr(r);return{account_id:i.AccountId,email:i.Email,roles:i.Roles?i.Roles:[]}}}const Y=require("debug")("videoedit");class Jr{async removeWatermark(r,i,o,a){if(!q.existsSync(r))throw new Error("video path not exist for the path "+r);const c=C.dirname(i);q.existsSync(c)||q.mkdirSync(c,{recursive:!0});const p=await bt.spawn("Marketingtool",["--action","removeWatermark","-f",r,"-o",i]);p.stdout.on("data",g=>{Y(`stdout: ${g}`)}),p.stderr.on("data",g=>{Y(`stderr: ${g}`)}),p.on("close",g=>{if(Y(`watermark remove child process exited with code ${g}`),a&&g==0)Y("run callback"),a(o,i);else{const w="_convert";if(r.includes(w))return;{Y("start convert video");const m=C.dirname(r)+C.sep+C.parse(r).name+w+".mp4";this.convertvideo(r,m,()=>this.removeWatermark(m,i,o,a))}}})}async getVideocaptions(r,i,o,a){if(!q.existsSync(r))throw new Error("video path not exist");await bt.spawn("Marketingtool",["--action","translate","-f",r,"--source-lang",o,"--target-lang",a])}async convertvideo(r,i,o){if(!q.existsSync(r))throw new Error("video path not exist");(await bt.spawn("Marketingtool",["--action","convertvideo","-f",r,"-o",i])).on("close",c=>{Y(`convert video child process exited with code ${c}`),c!=1&&Y("convert command failure: Marketingtool --action convertvideo -f "+r+" -o "+i)})}}class he{constructor(){y(this,"db");y(this,"videoTable","video");y(this,"videoDescriptionTable","video_description");y(this,"language",[{id:1,name:"en-us"},{id:2,name:"zh-cn"}]);const r=nt.getInstance();this.db=r.getdb()}saveVideo(r,i){let o=0;for(let g=0;g<this.language.length;g++)this.language[g].name==r.language&&(o=this.language[g].id);const a=Dt(),c="INSERT INTO "+this.videoTable+" (url,localpath,record_time) VALUES (?,?,?)",p=this;this.db.run(c,[r.url,r.localpath,a],function(g){if(g)throw new Error(g.message+" url:"+r.url+" recordtime:"+a);if(this.lastID){const w="INSERT INTO "+p.videoDescriptionTable+" (video_id,language_id,title,description) VALUES (?,?,?,?)";p.db.run(w,[this.lastID,o,r.title,r.description],function(m){if(m)throw new Error(m.message)}),i&&i(this.lastID)}})}updateVideofilter(r,i){const o="UPDATE "+this.videoTable+" SET filterwatermark = ? WHERE id = ?";this.db.run(o,[i,r],function(a){if(a)throw new Error(a.message)})}truncatedb(){const r="DELETE FROM "+this.videoTable;this.db.run(r,[],function(o){if(o)throw new Error(o.message)});const i="DELETE FROM "+this.videoDescriptionTable;this.db.run(i,[],function(o){if(o)throw new Error(o.message)})}}const pe=require("debug")("Observer:videodownloadObserver"),zr=require("app-root-path");class Yr{constructor(){}update(r,i){switch(r){case"downloadvideoend":this.videodownloadend(i);break}}videodownloadend(r){pe(r);const i=new he,o=new Jr,c=C.resolve(zr+"/tmp/video/filterwater/")+C.sep+Math.random().toString(16).slice(2)+".mp4";i.saveVideo(r.video,g=>o.removeWatermark(r.video.localpath,c,g,function(m,h){const I=new he;pe("start to update video filter, the insert id is "+m+" the output path is "+h),I.updateVideofilter(m,h)}));const p=new Lt;r.scrapeinfo.id&&p.Updateprocesstime(r.scrapeinfo.id)}}const{Browser:Kr}=require("puppeteer-cluster/dist/concurrency/builtInConcurrency"),St=require("debug")("se-scraper:CustomConcurrency"),{timeoutExecute:fe}=require("puppeteer-cluster/dist/util"),de=5e3;class Xr extends Kr{async init(){}async close(){}async workerInstance(){const r=this.options.perBrowserOptions.shift();St("Launch puppeteer instance with options=%o",r);let i=await this.puppeteer.launch(r),o,a;return{jobInstance:async()=>(await fe(de,(async()=>{a=await i.createIncognitoBrowserContext(),o=await a.newPage()})()),{resources:{page:o},close:async()=>{await fe(de,a.close())}}),close:async()=>{await i.close()},repair:async()=>{St("Starting repair");try{await i.close()}catch(c){St("Failed to close chrome: %o",c)}i=await this.puppeteer.launch(r)}}}}const At=require("fs"),Qr=require("os"),K=require("lodash"),{createLogger:Zr,format:ti,transports:ei}=require("winston"),{combine:ri,timestamp:ii,printf:ni}=ti,st=require("debug")("se-scraper:ScrapeManager"),{Cluster:ge}=require("puppeteer-cluster"),oi=require("puppeteer"),{addExtra:si}=require("puppeteer-extra"),ai=require("user-agents"),ci=6;function we(u){let r=At.readFileSync(u).toString().split(Qr.EOL);return r=r.filter(i=>i.trim().length>0),r}function at(u,r){if(typeof u=="string")return new{facebook:Sr,youtube:ve,bilibili:Ce}[u](r);throw new Error("social platform must either be a string of class (function)")}class wt{constructor(r,i={}){y(this,"cluster");y(this,"pluggable");y(this,"scraper");y(this,"context");y(this,"config");y(this,"logger");y(this,"browser");y(this,"page");y(this,"numClusters");y(this,"tmppath");y(this,"runLogin");y(this,"taskid");y(this,"taskrunId");if(this.context=i,this.config=K.defaults(r,{user_agent:"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36",random_user_agent:!1,set_manual_settings:!1,log_ip_address:!1,log_http_headers:!1,sleep_range:null,logger:Zr({level:"info",format:ri(ii(),ni(({level:o,message:a,timestamp:c})=>`${c} [${o}] ${a}`)),transports:[new ei.Console]}),chrome_flags:["--disable-infobars","--window-position=0,0","--ignore-certifcate-errors","--ignore-certifcate-errors-spki-list","--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-accelerated-2d-canvas","--disable-gpu","--window-size=1280,768","--start-fullscreen","--hide-scrollbars","--disable-notifications"],ignoreDefaultArgs:["--enable-automation","--disable-extensions","--disable-default-apps","--disable-component-extensions-with-background-pages"],num_pages:1,output_file:"",html_output:!1,clean_html_output:!0,clean_data_images:!0,screen_output:!1,scrape_from_file:"",block_assets:!0,custom_func:null,throw_on_detection:!1,proxies:null,proxy_file:"",use_proxies_only:!1,test_evasion:!1,apply_evasion_techniques:!0,puppeteer_cluster_config:{timeout:30*60*1e3,monitor:!1,concurrency:ge.CONCURRENCY_BROWSER,maxConcurrency:1}}),this.logger=this.config.logger,r.sleep_range&&r.sleep_range.length!==2)throw"sleep_range is not a valid array of two integers.";if(At.existsSync(this.config.keyword_file)&&(this.config.keywords=we(this.config.keyword_file)),this.config.proxies&&this.config.proxy_file)throw new Error("Either use a proxy_file or specify a proxy for all connections. Do not use both options.");if(this.config.proxy_file&&(this.config.proxies=we(this.config.proxy_file),this.logger.info(`${this.config.proxies.length} proxies read from file.`)),!this.config.proxies&&this.config.use_proxies_only)throw new Error("Must provide at least one proxy in proxies if you enable use_proxies_only");st("this.config=%O",this.config),r.taskid&&(this.taskid=r.taskid),r.taskrunId&&(this.taskrunId=r.taskrunId)}async start(){if(this.config.custom_func)if(At.existsSync(this.config.custom_func))try{const i=require(this.config.custom_func);this.pluggable=new i({config:this.config,context:this.context})}catch(i){return console.error(i),!1}else return console.error(`File "${this.config.custom_func}" does not exist!`),!1;const r=K.clone(this.config.chrome_flags);if(this.pluggable&&this.pluggable.start_browser)this.browser=await this.pluggable.start_browser({config:this.config}),this.page=await this.browser.newPage();else{let i;this.config.proxies&&this.config.proxies.length>0?(this.numClusters=Math.min(this.config.proxies.length+(this.config.use_proxies_only?0:1),ci),i=K.clone(this.config.proxies),this.config.use_proxies_only===!1&&i.unshift(null)):(this.numClusters=this.config.puppeteer_cluster_config.maxConcurrency,i=K.times(this.numClusters,null)),this.logger.info(`Using ${this.numClusters} clusters.`);const o=K.map(i,c=>{const p=this.config.random_user_agent?new ai({deviceCategory:"desktop"}).toString():this.config.user_agent;let g=r.concat([`--user-agent=${p}`]);return c&&(g=g.concat([`--proxy-server=${c}`])),{headless:this.config.headless,ignoreHTTPSErrors:!0,args:g}});st("perBrowserOptions=%O",o);const a=si(oi);this.cluster=await ge.launch({puppeteer:a,monitor:this.config.puppeteer_cluster_config.monitor,timeout:this.config.puppeteer_cluster_config.timeout,concurrency:Xr,maxConcurrency:this.numClusters,puppeteerOptions:{perBrowserOptions:o}})}}async login(r={}){if(Object.assign(this.config,r),this.pluggable&&this.pluggable.start_browser)this.scraper=at(this.config.platform,{config:this.config,context:this.context,pluggable:this.pluggable,page:this.page}),await this.scraper.runLogin({page:this.page});else{const i=[];for(let a=0;a<this.numClusters;a++)i.push([]);for(let a=0;a<this.config.keywords.length;a++)i[a%this.numClusters].push(this.config.keywords[a]);st("chunks=%o",i);const o=[];for(let a=0;a<i.length;a++){const c=K.clone(this.config);c.keywords=i[a];const p=at(this.config.platform,{config:c,context:{},pluggable:this.pluggable}),g=p.runLogin.bind(p);o.push(this.cluster.execute({},g))}await Promise.all(o)}}async searchdata(r={}){if(Object.assign(this.config,r),this.pluggable&&this.pluggable.start_browser){this.scraper=at(this.config.platform,{config:this.config,context:this.context,pluggable:this.pluggable,page:this.page,taskid:this.taskid,taskrunid:this.taskrunId});const i={page:this.page};await this.scraper.workersearchdata(i)}else{const i=[];for(let a=0;a<this.numClusters;a++)i.push([]);for(let a=0;a<this.config.keywords.length;a++)i[a%this.numClusters].push(this.config.keywords[a]);st("chunks=%o",i);const o=[];for(let a=0;a<i.length;a++){const c=K.clone(this.config);c.keywords=i[a],console.log("task run id is"+c.taskrunid);const p=at(this.config.platform,{config:c,context:{},pluggable:this.pluggable,taskid:c.taskid,taskrunid:c.taskrunid}),g=p.workersearchdata.bind(p);o.push(this.cluster.execute({},g))}await Promise.all(o)}}async quit(){this.pluggable&&this.pluggable.close_browser?await this.pluggable.close_browser():(await this.cluster.idle(),await this.cluster.close())}async downloadPlatomvideo(r){if(!["bilibili"].includes(this.config.platform))throw new Error("download video function not work at platform "+this.config.platform);this.scraper=at(this.config.platform,{config:this.config,context:this.context,pluggable:this.pluggable,page:this.page}),st("links=%o",r);const o=new Yr;this.scraper.attach(o),await this.scraper.downloadvideo(r)}}module.exports={ScrapeManager:wt};const ye=require("debug")("index");async function ui(u,r){Object.assign(u,r);var i=new wt(u);await i.start();var o=await i.login(r);return await i.quit(),o}async function li(u,r){Object.assign(u,r);var i=new wt(u);console.log("scraper task id"+i.taskid),await i.start(),await i.searchdata(r),await i.quit()}async function hi(u,r){Object.assign(u,r);const i=5,o=new Lt;if(ye("result task id is "+r.resulttaskid),!r.resulttaskid)throw new Error("result_taskid is null");const a=await o.Getscrapyinfolist(r.resulttaskid,i);if(ye(a),!a)throw new Error("video link list is null");if(a.length<1)throw new Error("link list is empty");var c=new wt(u);c.downloadPlatomvideo(a)}async function pi(){nt.getInstance().init()}class me{constructor(){y(this,"db");y(this,"taskrunTable","task_run");const r=nt.getInstance();this.db=r.getdb()}saveTaskrun(r,i,o,a){const c=Dt(),p="INSERT INTO "+this.taskrunTable+" (task_id,taskrun_num,log_path,record_time) VALUES (?,?,?,?)";this.db.run(p,[r,i,o,c],function(g){if(g)throw new Error(g.message+" taskid:"+r.toString()+" recordtime:"+c);this.lastID&&a&&a(this.lastID)})}getTaskidbytaskrunNum(r,i){const o="SELECT id,task_id FROM "+this.taskrunTable+" WHERE taskrun_num = ?";this.db.get(o,[r],(a,c)=>{if(a)throw new Error(a.message);if(c){const p=c.task_id,g=c.id;i&&i(g,p)}})}checkTaskrunExist(r,i,o){const a="SELECT task_id FROM "+this.taskrunTable+" WHERE task_id = ? AND taskrun_num = ?";let c=!1;this.db.get(a,[r,i],(p,g)=>{if(p)throw new Error(p.message);g&&(c=!0),o&&o(c)})}}var Ut=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Re={},Rt={exports:{}};function fi(){throw new Error(`secure random number generation not supported by this browser
use chrome, FireFox or Internet Explorer 11`)}var Mt=Ut.crypto||Ut.msCrypto;Mt&&Mt.getRandomValues?Rt.exports=di:Rt.exports=fi;function di(u,r){if(u>65536)throw new Error("requested too many random bytes");var i=new Ut.Uint8Array(u);u>0&&Mt.getRandomValues(i);var o=new W(i.buffer);return typeof r=="function"?rt.nextTick(function(){r(null,o)}):o}var gi=Rt.exports,Me={exports:{}};(function(u,r){function i(){this.chars=""}i.prototype.setType=function(o){if(Array.isArray(o))for(var a=0;a<o.length;a++)this.chars+=this.getCharacters(o[a]);else this.chars=this.getCharacters(o)},i.prototype.getCharacters=function(o){var a,c="0123456789",p="abcdefghijklmnopqrstuvwxyz",g=p.toUpperCase(),w="abcdef",m="01",h="01234567";return o==="alphanumeric"?a=c+p+g:o==="numeric"?a=c:o==="alphabetic"?a=p+g:o==="hex"?a=c+w:o==="binary"?a=m:o==="octal"?a=h:a=o,a},i.prototype.removeUnreadable=function(){var o=/[0OIl]/g;this.chars=this.chars.replace(o,"")},i.prototype.setcapitalization=function(o){o==="uppercase"?this.chars=this.chars.toUpperCase():o==="lowercase"&&(this.chars=this.chars.toLowerCase())},i.prototype.removeDuplicates=function(){var o=this.chars.split("");o=[...new Set(o)],this.chars=o.join("")},u.exports=i})(Me);var wi=Me.exports,$e=gi,yi=wi;function mi(u){for(var r=[],i=0;i<u;i++)r.push(Math.floor(Math.random()*255));return{length:u,readUInt8:function(o){return r[o]}}}function ki(u){try{return $e(u)}catch{return mi(u)}}function Oe(u,r,i,o,a){for(var c=r,p=0;p<u.length&&c.length<o;p++){var g=u.readUInt8(p);g<a&&(c+=i.charAt(g%i.length))}return c}function De(u,r,i,o,a){$e(i,function(c,p){c&&a(c);var g=Oe(p,u,r,i,o);g.length<i?De(g,r,i,o,a):a(null,g)})}Re.generate=function(u,r){var i=new yi,o,a="";typeof u=="object"?(o=typeof u.length=="number"?u.length:32,u.charset?i.setType(u.charset):i.setType("alphanumeric"),u.capitalization&&i.setcapitalization(u.capitalization),u.readable&&i.removeUnreadable(),i.removeDuplicates()):typeof u=="number"?(o=u,i.setType("alphanumeric")):(o=32,i.setType("alphanumeric"));var c=i.chars.length,p=256-256%c;if(!r){for(;a.length<o;){var g=ki(Math.ceil(o*256/p));a=Oe(g,a,i.chars,o,p)}return a}De(a,i.chars,o,p,r)};var xi=Re;const bi=require("path");class qe{createsocialtaskrun(r,i){const o=new me,a=this.getlogfile(r);return o.checkTaskrunExist(r,i,p=>{if(p)throw new Error("task run number exist")}),o.saveTaskrun(r,i,a,null),{taskId:r,taskRunNum:i,logfile:a}}getlogfile(r){const i=Er();if(!i)throw new Error("get user home dir error");const o=xr();return bi.join(i,"social-task-log",o,r.toString()+".log")}gentaskrunNum(r){return r.toString()+":"+xi.generate()}TaskidbytaskrunNum(r,i){new me().getTaskidbytaskrunNum(r,i)}}class Ei{constructor(){y(this,"_httpClient");this._httpClient=new Pt}async getTaskbycampagin(r,i,o){const a=new URLSearchParams({campaiginId:r.toString(),page:i.toString(),size:o.toString()}),c=new re.URLSearchParams(a),p=await this._httpClient.get("/api/listsotask?"+c).catch(function(g){throw new Error(g.message)});if(!p)throw new Error("remote return social task is null");return p}async getTaskbyid(r){const i=new URLSearchParams({task_id:r.toString()}),o=new re.URLSearchParams(i),a=await this._httpClient.get("/api/getsocialtaskinfo?"+o).catch(function(c){throw new Error(c.message)});if(!a)throw new Error("remote return social task is null");return a}async getTasktype(){const r=await this._httpClient.get("/api/socialtasktype").catch(function(i){throw new Error(i.message)});if(!r)throw new Error("remote return social task type is null");return r}async getTaglist(){const r=await this._httpClient.get("/api/tag").catch(function(i){throw new Error(i.message)});if(!r)throw new Error("remote return tag is null");return r}async saveSocialTask(r){let i=new FormData;r.id&&i.append("socialtask_id",String(r.id)),i.append("campaign_id",String(r.campaign_id)),i.append("task_name",String(r.task_name)),i.append("type_id",String(r.type_id)),r.tag&&i.append("tags[]",String(r.tag)),r.keywords&&i.append("keywords[]",String(r.keywords));const o=await this._httpClient.post("/api/savesocialtask",i).catch(function(a){throw new Error(a.message)});if(!o)throw new Error("remote return social task type is null");return o}async createsocialtask(r,i){return new qe().createsocialtaskrun(r,i)}async runsocialtask(r,i){var g,w;const o=C.join(__dirname,"utilityCode.js");if(!q.existsSync(o))throw new Error("child js path not exist for the path "+o);const{port1:a,port2:c}=new ct.MessageChannelMain,p=ct.utilityProcess.fork(C.join(__dirname,"utilityCode.js"),["-a","runtask","-t",r.taskRunNum],{stdio:"pipe",execArgv:["puppeteer-cluster:*"]});console.log(C.join(__dirname,"utilityCode.js")),p.on("spawn",()=>{p.postMessage({message:"hello"},[a])}),(g=p.stdout)==null||g.on("data",m=>{console.log(`Received data chunk ${m}`),i&&i(m.toString())}),(w=p.stderr)==null||w.on("data",m=>{console.log(`Received error chunk ${m}`),i&&i(m.toString())}),p.on("exit",()=>{console.log("child process exited ")}),c.on("message",m=>{console.log("port receive:",m.data),c.postMessage("I receive your messages:")}),c.start(),p.on("message",m=>{console.log("接收到消息了：",m)})}}const _i={user_agent:"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36",random_user_agent:!1,headless:!1,debug_level:1,chrome_flags:[],custom_func:"",proxy:"",proxy_file:"",use_cluster:!1,puppeteer_cluster_config:{timeout:10*60*1e3,monitor:!1,concurrency:1,maxConcurrency:1}},Bi={output_file:"/tmp/test/test.json",block_assets:!1,test_evasion:!1,apply_evasion_techniques:!0,log_ip_address:!1,log_http_headers:!1,platform:"facebook",tmppath:"",taskid:0};class Ii{constructor(){y(this,"_httpClient");this._httpClient=new Pt}async getKeywordsbytag(r){let i=new FormData;i.append("tags[]",String(r));const o=await this._httpClient.post("/api/getkeywordtag",i).catch(function(a){throw new Error(a.message)}).then(function(a){return a});if(!o)throw new Error("remote return social task type is null");return o.data}}const{ArgumentParser:Si}=require("argparse"),ke=require("fs"),vi=require("path").resolve,Ti=require("debug")("runcli"),ut=new Si({description:"Social martketing"});ut.add_argument("-a","--action",{help:"Tha action you want to the program to take"});ut.add_argument("-c","--campaign",{help:"Tha campaign id you want to program to take"});ut.add_argument("-t","--taskrunnum",{help:"Tha task run number you want to program to take"});ut.add_argument("-head","--headless",{help:"Tha task run number you want to program to take"});let Ne=ut.parse_args(),$t=_i,v=Bi;function Ot(u,r,i){var o=u[r];return typeof o<"u"?o:i}async function Fi(u){let r=Ot(u,"action",!1);switch(r||console.log("no parameter action been passed"),r){case"login":Ai();break;case"runtask":const i=Ot(u,"taskrunnum",!1);if(!i)throw new Error("task run number is empty");Ci(i);break;case"sqlinit":pi();break}}async function Ci(u){await new qe().TaskidbytaskrunNum(u,async(i,o)=>{if(console.log(o),!o)throw new Error("get taskid from db error");if(!i)throw new Error("get taskrunid from db error");const c=await new Ei().getTaskbyid(o);if(!c)throw new Error("taskInfo is undefined");if(console.log(c),!c.status)throw new Error(c.msg);if(!c.data)throw new Error("social task data empty");const p=c.data;switch(p.type_name){case"bilibiliscrape":if(v.platform="bilibili",v.taskid=p.id,v.taskrunid=i,p.keywords)v.keywords=p.keywords;else{const g=p.tag;if(g){const m=await new Ii().getKeywordsbytag(g);if(m)v.keywords=m;else throw new Error("get keyword by tag failure, keywordarr is undefined")}else throw new Error("both keyword and tag is undefined")}if(!v.keywords)throw new Error("can not get keywords,keywords is undefined");await li($t,v);break;case"bilibilidownload":v.platform="bilibili",v.taskid=p.id,await hi($t,v);break}})}async function Ai(){let u=Ot(Ne,"campaign",!1);var r=new Lt;let i=await r.getRemoteConfig(u);if(Ti(i),i==null||!i)throw new Error("sosetting is undefined");v.platform=i.sotype,v.user=i.socialuser,v.pass=i.socialpass,console.log(i);const o=vi("./tmp/"+v.platform+"/"+i.socialuser);await Ui(o),v.tmppath=o,await ui($t,v)}function Ui(u){u.split("/").reduce((r,i)=>(r+=`${i}/`,ke.existsSync(r)||ke.mkdirSync(r),r),"")}Fi(Ne);
//# sourceMappingURL=utilityCode.js.map
